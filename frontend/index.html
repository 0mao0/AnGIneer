<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PicoAgent Test Console</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({ 
            startOnLoad: false, 
            theme: 'neutral',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            themeVariables: {
                fontSize: '13px',
                fontFamily: 'arial',
                nodePadding: '10'
            }
        });
    </script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; background: #f5f5f5; display: flex; height: 100vh; overflow: hidden; }
        
        /* Left Sidebar: Test List */
        .sidebar { width: 260px; background: #2c3e50; color: white; padding: 20px; display: flex; flex-direction: column; gap: 10px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); flex-shrink: 0; }
        
        /* Middle Column: Interaction Area */
        .main-content { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; background: white; border-right: 1px solid #ddd; }
        
        /* Right Column: Execution Trace */
        .execution-trace { width: 450px; background: #f8f9fa; display: flex; flex-direction: column; flex-shrink: 0; border-left: 1px solid #ddd; height: 100vh; }
        
        .trace-section-header { 
            padding: 10px 15px; 
            background: #e9ecef; 
            border-bottom: 1px solid #dee2e6; 
            font-size: 12px; 
            font-weight: bold; 
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #flowchartArea { 
            flex: 1; 
            overflow: auto; 
            background: white; 
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        #flowchartArea svg {
            width: 100% !important;
            max-width: 100%;
            height: auto;
        }

        /* Ensure Mermaid labels can expand to fit content */
        .mermaid .label foreignObject {
            overflow: visible;
        }
        .mermaid .label foreignObject div {
            max-width: 200px !important;
            width: auto !important;
            display: inline-block !important;
            text-align: center !important;
            white-space: normal !important;
            word-wrap: break-word;
        }
        .nodeLabel {
            white-space: normal !important;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .unit-test-result-summary {
            background: white;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        #consoleArea { 
            height: 40%; 
            overflow-y: auto; 
            background: #2c3e50; 
            color: #ecf0f1; 
            padding: 15px; 
            font-family: 'Consolas', monospace; 
            font-size: 11px;
            border-top: 2px solid #34495e;
        }

        .trace-step {
            margin-bottom: 8px;
            border-bottom: 1px solid #3d566e;
            padding-bottom: 5px;
        }
        .trace-step-time { color: #95a5a6; font-size: 10px; }
        .trace-step-content { margin-top: 3px; white-space: pre-wrap; word-break: break-word; }
        
        .container { max-width: 100%; margin: 0; }
        h1, h2, h3 { margin-top: 0; color: #333; }
        h2 { color: #ecf0f1; font-size: 1.1rem; margin-bottom: 15px; }
        h3 { font-size: 0.9rem; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; }

        .input-group { margin-top: auto; padding-top: 20px; border-top: 1px solid #eee; display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; transition: background 0.2s; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; }
        
        .test-btn { background: #34495e; text-align: left; padding: 12px; border: none; border-radius: 4px; font-size: 12px; line-height: 1.4; border-left: 4px solid transparent; color: #bdc3c7; cursor: pointer; width: 100%; }
        .test-btn:hover { background: #4b6584; color: white; }
        .test-btn.active { border-left-color: #3498db; background: #3d566e; color: white; }
        .test-btn strong { display: block; color: white; margin-bottom: 3px; font-size: 13px; }

        /* Chat Styles */
        #chatDisplay { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; padding-bottom: 20px; }
        .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 8px; font-size: 14px; line-height: 1.5; position: relative; }
        .chat-bubble.user { align-self: flex-end; background: #007bff; color: white; border-bottom-right-radius: 2px; }
        .chat-bubble.bot { align-self: flex-start; background: #f0f0f0; color: #333; border-bottom-left-radius: 2px; border: 1px solid #e0e0e0; }
        
        /* Trace Card Styles */
        .trace-card { background: white; border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; margin-bottom: 12px; font-size: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .trace-card.running { border-left: 3px solid #007bff; }
        .trace-card.completed { border-left: 3px solid #28a745; }
        .trace-card.failed { border-left: 3px solid #dc3545; }
        .trace-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; color: #2c3e50; }
        .trace-meta { color: #7f8c8d; font-family: 'Consolas', monospace; font-size: 11px; margin-bottom: 5px; }
        .trace-details { color: #34495e; background: #fcfcfc; padding: 6px; border-radius: 4px; border: 1px solid #f0f0f0; margin-top: 5px; overflow-x: auto; }
        
        .status-badge { padding: 2px 5px; border-radius: 3px; font-size: 10px; color: white; text-transform: uppercase; }
        .status-running { background: #007bff; }
        .status-completed { background: #28a745; }
        .status-failed { background: #dc3545; }

        pre { margin: 0; white-space: pre-wrap; word-wrap: break-word; }
        
        #modelSelectionArea { background: #f8f9f9; padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #e5e8e8; }
        .model-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; }
        .model-item { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 12px; 
            cursor: pointer; 
            padding: 6px 10px; 
            border: 1px solid #d5dbdb; 
            border-radius: 4px;
            background: white;
            transition: all 0.2s;
        }
        .model-item:hover { border-color: #3498db; background: #ebf5fb; }
        .model-item input[type="radio"] { margin: 0; }
        .model-item.active { border-color: #3498db; background: #ebf5fb; font-weight: bold; }
        .model-name { color: #2c3e50; font-weight: 500; }
        .model-id { color: #7f8c8d; font-size: 10px; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }

        /* Unit Test Result Styles */
        .unit-test-result { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 4px; font-family: 'Consolas', monospace; font-size: 12px; }
        .unit-test-result .stdout { color: #d4d4d4; }
        .unit-test-result .stderr { color: #f44747; }

        /* Sample Queries */
        .sample-queries {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .sample-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 15px;
            padding: 4px 12px;
            font-size: 11px;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s;
        }
        .sample-btn:hover {
            background: #e9ecef;
            border-color: #ced4da;
            color: #212529;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>PicoAgent æµ‹è¯•å¥—ä»¶</h2>
        <button class="test-btn" id="btn-test-0" onclick="switchTest('0', this)">
            <strong>æµ‹è¯• 00: LLM å¯¹è¯èƒ½åŠ›</strong>
            é€‰æ‹©æ¨¡å‹ï¼ˆæ”¯æŒ NVIDIA, æ™ºè°± AI ç­‰ï¼‰å¹¶è¿›è¡Œå®æ—¶å¯¹è¯æµ‹è¯•.
        </button>
        <button class="test-btn" id="btn-test-1" onclick="switchTest('1', this)">
            <strong>æµ‹è¯• 01: å·¥å…·ä¸SOPåŠ è½½</strong>
            éªŒè¯ç³»ç»Ÿé™æ€èµ„æºï¼ˆTools/SOPsï¼‰çš„åŠ è½½æƒ…å†µ.
        </button>
        <button class="test-btn" id="btn-test-2" onclick="switchTest('2', this)">
            <strong>æµ‹è¯• 02: æ„å›¾è¯†åˆ«</strong>
            éªŒè¯å¯¹ä¸åŒç±»å‹é—®é¢˜çš„æ„å›¾å‘½ä¸­èƒ½åŠ› (SOPè·¯ç”±).
        </button>
        <button class="test-btn" id="btn-test-3" onclick="switchTest('3', this)">
            <strong>æµ‹è¯• 03: SOP è§£æ</strong>
            éªŒè¯ SOP æ­¥éª¤è§£æä¸å·¥å…·è¯†åˆ«èƒ½åŠ›.
        </button>
        <button class="test-btn" id="btn-test-4" onclick="switchTest('4', this)">
            <strong>æµ‹è¯• 04: å·¥å…·æœ‰æ•ˆæ€§</strong>
            ç‹¬ç«‹éªŒè¯è®¡ç®—å™¨ã€è¡¨æ ¼æŸ¥è¯¢ç­‰å·¥å…·çš„åŠŸèƒ½.
        </button>
        <button class="test-btn" id="btn-test-5" onclick="switchTest('5', this)">
            <strong>æµ‹è¯• 05: å…¨æµç¨‹æµ‹è¯•</strong>
            æ¨¡æ‹Ÿä»æŸ¥è¯¢åˆ°æ‰§è¡Œçš„å®Œæ•´ä¸šåŠ¡æµ.
        </button>
        
        <div style="margin-top: auto; font-size: 11px; color: #95a5a6; text-align: center; border-top: 1px solid #34495e; padding-top: 10px;">
            PicoAgent v0.1 Prototype
        </div>
    </div>

    <div class="main-content">
        <h1 id="testTitle">æµ‹è¯•æ§åˆ¶å°</h1>
        
        <!-- Test 00: Chat Interface -->
        <div id="chatInterface" style="display: none; flex: 1; flex-direction: column;">
            <div id="modelSelectionArea">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div style="font-weight: bold; font-size: 14px; color: #2980b9;">é€‰æ‹©æ¨¡å‹ä¸æ¨¡å¼:</div>
                    <div id="modeSelection" style="display: flex; gap: 15px; background: #ebf5fb; padding: 5px 15px; border-radius: 20px; border: 1px solid #d4e6f1;">
                        <label style="font-size: 12px; display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="radio" name="runMode" value=""> é»˜è®¤
                        </label>
                        <label style="font-size: 12px; display: flex; align-items: center; gap: 5px; cursor: pointer; color: #8e44ad; font-weight: bold;">
                            <input type="radio" name="runMode" value="thinking"> Thinking ğŸ§ 
                        </label>
                        <label style="font-size: 12px; display: flex; align-items: center; gap: 5px; cursor: pointer; color: #27ae60; font-weight: bold;">
                            <input type="radio" name="runMode" value="instruct" checked> Instruct ğŸ“
                        </label>
                    </div>
                </div>
                <div id="modelGrid" class="model-grid">
                    <!-- Models loaded here -->
                </div>
            </div>
            <div id="chatDisplay">
                <!-- Chat history -->
                <div class="chat-bubble bot">æ‚¨å¥½ï¼è¯·é€‰æ‹©å·¦ä¾§çš„æµ‹è¯•é¡¹ï¼Œæˆ–è€…åœ¨è¿™é‡Œé€‰æ‹©ä¸€ä¸ªæ¨¡å‹å¼€å§‹å¯¹è¯æµ‹è¯•ã€‚</div>
            </div>
        </div>

        <!-- Unit Test Interface -->
        <div id="unitTestInterface" style="display: none; flex: 1; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                <h3 style="margin: 0; color: #2c3e50;">æµ‹è¯•ç»“æœ</h3>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div id="unitTestModelSelection" style="display: none; gap: 6px; align-items: center; background: #fdf2f2; padding: 5px 10px; border-radius: 20px; border: 1px solid #f5c6cb;">
                        <span style="font-size: 12px; color: #7f8c8d;">æ¨¡å‹</span>
                        <select id="unitTestModelSelect" style="font-size: 12px; border: 1px solid #eee; padding: 2px 8px; border-radius: 12px; background: white; outline: none;" onchange="updateUnitTestModelSelection(this)">
                            <option value="">åŠ è½½ä¸­...</option>
                        </select>
                    </div>
                    <div id="unitTestModeSelection" style="display: none; gap: 15px; background: #ebf5fb; padding: 5px 15px; border-radius: 20px; border: 1px solid #d4e6f1;">
                        <label style="font-size: 12px; display: flex; align-items: center; gap: 5px; cursor: pointer; color: #27ae60; font-weight: bold;">
                            <input type="radio" name="unitTestRunMode" value="instruct" checked> Instruct ğŸ“
                        </label>
                        <label style="font-size: 12px; display: flex; align-items: center; gap: 5px; cursor: pointer; color: #8e44ad; font-weight: bold;">
                            <input type="radio" name="unitTestRunMode" value="thinking"> Thinking ğŸ§ 
                        </label>
                    </div>
                </div>
            </div>
            
            <div id="testResultDisplay" style="flex: 1; overflow-y: auto;">
                <!-- Results of runUnitTest -->
                <div style="color: #95a5a6; font-style: italic; text-align: center; margin-top: 50px;">
                    æµ‹è¯•è¿è¡Œç»“æœå°†åœ¨æ­¤æ˜¾ç¤º
                </div>
            </div>
        </div>

        <div id="samplesContainer" style="margin-top: auto; padding-top: 10px;">
            <div id="sampleQueriesArea" style="display: none; margin-bottom: 5px;">
                <div style="font-size: 11px; color: #7f8c8d; margin-bottom: 5px; margin-left: 5px;">æ“ä½œ:</div>
                <div class="sample-queries">
                    <!-- Dynamic buttons will be loaded here -->
                </div>
            </div>
        </div>

        <div class="input-group">
            <input type="text" id="queryInput" placeholder="åœ¨æ­¤è¾“å…¥æ‚¨çš„æµ‹è¯•æŒ‡ä»¤..." onkeyup="if(event.keyCode===13) runCurrentAction()">
            <button id="runBtn" onclick="runCurrentAction()">è¿è¡Œ</button>
        </div>
    </div>

    <div class="execution-trace">
        <div class="trace-section-header">
            <span>æ‰§è¡Œæµç¨‹å›¾</span>
            <div id="traceStats" style="font-size: 11px; font-weight: normal;">
                è€—æ—¶: <span id="timer">0ms</span>
            </div>
        </div>
        <div id="flowchartArea">
            <div id="mermaidContainer" class="mermaid">
                graph TD
                Start((å¼€å§‹)) --> Idle[ç­‰å¾…æŒ‡ä»¤]
            </div>
        </div>

        <div class="trace-section-header">
            <span>å®æ—¶æ§åˆ¶å°è¾“å‡º</span>
            <button onclick="document.getElementById('consoleArea').innerHTML=''" style="padding: 2px 8px; font-size: 10px; background: #6c757d;">æ¸…ç©º</button>
        </div>
        <div id="consoleArea">
            <div style="color: #95a5a6; font-style: italic;">ç­‰å¾…æµ‹è¯•è¿è¡Œ...</div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let currentTestId = null;
        let startTime = 0;
        let timerInterval;
        let availableModels = [];

        async function fetchModels() {
            const intro = "åŠ è½½å¯ç”¨æ¨¡å‹å¹¶åŒæ­¥é»˜è®¤é€‰æ‹©ã€‚";
            try {
                const response = await fetch(`${API_URL}/llm_configs`);
                availableModels = await response.json();
                const container = document.getElementById('modelGrid');
                container.innerHTML = availableModels.map((m, index) => `
                    <label class="model-item ${m.configured ? (index === 0 ? 'active' : '') : 'disabled'}" id="model-${m.name}">
                        <input type="radio" name="selectedModel" value="${m.name}" ${m.configured ? (index === 0 ? 'checked' : '') : 'disabled'} onchange="updateModelSelection(this)">
                        <div style="flex: 1">
                            <div class="model-name">${m.name}</div>
                            <div class="model-id">${m.model}</div>
                        </div>
                        <div class="model-latency" id="latency-${m.name}" style="font-size: 10px; color: #3498db; font-weight: bold;"></div>
                    </label>
                `).join('');
                const unitTestSelect = document.getElementById('unitTestModelSelect');
                const configuredModels = availableModels.filter(m => m.configured);
                if (unitTestSelect) {
                    unitTestSelect.innerHTML = configuredModels.length > 0 
                        ? configuredModels.map(m => `<option value="${m.name}">${m.name}</option>`).join('')
                        : `<option value="">æ— å¯ç”¨æ¨¡å‹</option>`;
                }
                const defaultModel = pickDefaultModel(availableModels);
                if (defaultModel) {
                    const safeName = window.CSS && CSS.escape ? CSS.escape(defaultModel) : defaultModel;
                    const radio = document.querySelector(`input[name="selectedModel"][value="${safeName}"]`);
                    if (radio && !radio.disabled) {
                        radio.checked = true;
                        updateModelSelection(radio);
                    }
                    if (unitTestSelect) {
                        unitTestSelect.value = defaultModel;
                    }
                }
            } catch (e) {
                console.error('Failed to fetch models', e);
            }
        }

        function updateModelSelection(radio) {
            const intro = "åŒæ­¥æ¨¡å‹å¡ç‰‡ä¸ä¸‹æ‹‰é€‰æ‹©çŠ¶æ€ã€‚";
            // Update UI to show selection
            document.querySelectorAll('.model-item').forEach(el => {
                el.classList.remove('active');
            });
            const parent = document.getElementById(`model-${radio.value}`);
            if (parent) parent.classList.add('active');
            const unitTestSelect = document.getElementById('unitTestModelSelect');
            if (unitTestSelect && unitTestSelect.value !== radio.value) {
                unitTestSelect.value = radio.value;
            }
            
            addConsoleLine(`Model changed to: ${radio.value}`);
        }

        function updateUnitTestModelSelection(select) {
            const intro = "å°†ç»“æœåŒºæ¨¡å‹é€‰æ‹©åŒæ­¥åˆ°æ¨¡å‹å¡ç‰‡ã€‚";
            const safeName = window.CSS && CSS.escape ? CSS.escape(select.value) : select.value;
            const radio = document.querySelector(`input[name="selectedModel"][value="${safeName}"]`);
            if (radio && !radio.disabled) {
                radio.checked = true;
                updateModelSelection(radio);
            }
        }

        function pickDefaultModel(models) {
            const intro = "ä¼˜å…ˆé€‰æ‹© Qwen-VL ç³»åˆ—ä½œä¸ºé»˜è®¤æ¨¡å‹ã€‚";
            if (!models || models.length === 0) return null;
            const candidates = models.filter(m => m.configured);
            const keywords = ["Qwen-VL", "Qwen3-VL", "Qwen VL"];
            const preferred = candidates.find(m => keywords.some(k => (m.name || "").includes(k) || (m.model || "").includes(k)));
            return (preferred || candidates[0])?.name || null;
        }

        // --- Helpers for Test 02 Streaming ---
        function handleTest02Event(event) {
            if (event.status === 'running') {
                addConsoleLine(`[${event.step}] ${event.msg}`);
                updateTest02Flowchart(event.step);
            } else if (event.status === 'done') {
                addConsoleLine(`[${event.step}] âœ… ${event.msg}`);
                if (event.step === 'result') {
                    renderTest02Result(event.data);
                }
                updateTest02Flowchart(event.step, true);
            } else if (event.status === 'failed') {
                 addConsoleLine(`[${event.step}] âŒ ${event.msg}`, true);
            } else if (event.status === 'warning') {
                 addConsoleLine(`[${event.step}] âš ï¸ ${event.msg}`);
            }
        }

        function updateTest01Flowchart(currentStep, summary = {}) {
            const intro = "æ ¹æ® Test01 è¿›åº¦åˆ·æ–°æµç¨‹å›¾é«˜äº®çŠ¶æ€ã€‚";
            const doneColor = "#d4efdf,stroke:#27ae60,stroke-width:2px";
            const activeColor = "#3498db,stroke:#2980b9,stroke-width:2px,color:white,stroke-dasharray: 5 5";
            const warnColor = "#fcf3cf,stroke:#f1c40f,stroke-width:2px";
            const errorColor = "#f5b7b1,stroke:#c0392b,stroke-width:2px";
            const def = `graph TD
                Start((Start)) --> API["API Bridge (APIæ¡¥æ¥)<br/>backend/api_bridge.py:run_test/1"]
                API --> Script["Test Script (æµ‹è¯•è„šæœ¬)<br/>tests/test_01_tool_registration.py"]
                Script --> ToolsLoad["Load Tools (åŠ è½½å·¥å…·)<br/>src/tools/base.py:ToolRegistry.list_tools"]
                ToolsLoad --> ToolsCheck["Validate Core Tools (æ ¸å¿ƒå·¥å…·æ ¡éªŒ)"]
                ToolsCheck --> SOPLoad["Load SOPs (åŠ è½½SOP)<br/>src/core/sop_loader.py:load_all"]
                SOPLoad --> SOPCheck["Validate Core SOPs (æ ¸å¿ƒSOPæ ¡éªŒ)"]
                SOPCheck --> End(("Result (ç»“æœ)"))
            `;
            let styleStr = "";
            let focusNode = null;
            styleStr += `style Start fill:${doneColor}\n`;
            if (currentStep === 'running') {
                styleStr += `style API fill:${activeColor}\n`;
                styleStr += `style Script fill:${activeColor}\n`;
                styleStr += `style ToolsLoad fill:${activeColor}\n`;
                focusNode = "ToolsLoad";
            } else if (currentStep === 'result') {
                styleStr += `style API fill:${doneColor}\n`;
                styleStr += `style Script fill:${doneColor}\n`;
                styleStr += `style ToolsLoad fill:${doneColor}\n`;
                styleStr += `style ToolsCheck fill:${summary.toolsError ? errorColor : doneColor}\n`;
                styleStr += `style SOPLoad fill:${doneColor}\n`;
                styleStr += `style SOPCheck fill:${summary.sopsError ? errorColor : (summary.sopsWarn ? warnColor : doneColor)}\n`;
                styleStr += `style End fill:#d1f2eb,stroke:#16a085,stroke-width:4px\n`;
                focusNode = "End";
            }
            setFlowchartFocusNode(focusNode);
            updateFlowchart(def + "\n" + styleStr);
        }

        function updateTest02Flowchart(currentStep, isDone=false) {
             const intro = "æ ¹æ®æµå¼æ­¥éª¤åˆ·æ–°æµç¨‹å›¾é«˜äº®çŠ¶æ€ã€‚";
             const doneColor = "#d4efdf,stroke:#27ae60,stroke-width:2px";
             const activeColor = "#3498db,stroke:#2980b9,stroke-width:2px,color:white,stroke-dasharray: 5 5";
             
             // Detailed graph definition matching the initialization
             let def = `graph TD
                Start((Start)) --> API["API Endpoint (APIç«¯ç‚¹)<br/>backend/api_bridge.py:stream_test_02"]
                API --> SOP["Load SOPs (åŠ è½½SOP)<br/>src/core/sop_loader.py:load_all"]
                SOP --> ClassInit["Init Classifier (åˆå§‹åŒ–åˆ†ç±»å™¨)<br/>src/agents/classifier.py:__init__"]
                ClassInit --> Route["Route Intent (æ„å›¾è·¯ç”±)<br/>src/agents/classifier.py:route"]
                Route --> Prompt["Build Prompt (æ„å»ºæç¤ºè¯)<br/>src/agents/classifier.py:_build_prompt"]
                Prompt --> LLM["LLM Chat (LLMå¯¹è¯)<br/>src/core/llm.py:chat"]
                LLM --> Parse["Parse Response (è§£æå“åº”)<br/>src/agents/classifier.py"]
               Parse --> End(("Result (ç»“æœ)"))
             `;
             
             let styleStr = "";
             let focusNode = null;
             
             // State machine coloring
             styleStr += `style Start fill:${doneColor}\n`;
             styleStr += `style API fill:${doneColor}\n`; // API is always done when we receive events

             // LoadSOP (sop_load, sop_validate)
             if (currentStep === 'sop_load' || currentStep === 'sop_validate') {
                 styleStr += `style SOP fill:${isDone ? doneColor : activeColor}\n`;
                 focusNode = "SOP";
             } else if (['llm_load', 'inference', 'result'].includes(currentStep)) {
                 styleStr += `style SOP fill:${doneColor}\n`;
             }
             
             // InitLLM (llm_load)
             if (currentStep === 'llm_load') {
                 styleStr += `style ClassInit fill:${isDone ? doneColor : activeColor}\n`;
                 focusNode = "ClassInit";
             } else if (['inference', 'result'].includes(currentStep)) {
                  styleStr += `style ClassInit fill:${doneColor}\n`;
             }
             
             // Infer (inference covers Route -> Prompt -> LLM)
             if (currentStep === 'inference') {
                 // Highlight the active part of inference chain
                 styleStr += `style Route fill:${activeColor}\n`;
                 styleStr += `style Prompt fill:${activeColor}\n`;
                 styleStr += `style LLM fill:${activeColor}\n`;
                 focusNode = "LLM";
             } else if (['result'].includes(currentStep)) {
                 styleStr += `style Route fill:${doneColor}\n`;
                 styleStr += `style Prompt fill:${doneColor}\n`;
                 styleStr += `style LLM fill:${doneColor}\n`;
             }
             
             // Result (result covers Parse -> End)
             if (currentStep === 'result') {
                 styleStr += `style Parse fill:${doneColor}\n`;
                 styleStr += `style End fill:#d1f2eb,stroke:#16a085,stroke-width:4px\n`;
                 focusNode = "End";
             }
             setFlowchartFocusNode(focusNode);
             updateFlowchart(def + "\n" + styleStr);
        }
        
        function renderTest02Result(data) {
             const intro = "æ¸²æŸ“ Test02 æµå¼ç»“æœå†…å®¹ã€‚";
             const reasonValue = data.reason ?? data.reasonText ?? data.reason_zh ?? data.reason_en;
             const reasonText = reasonValue != null && reasonValue.toString().trim() !== "" ? escapeHtml(reasonValue) : 'æ— ';
             const rawInferenceTime = data.inference_time_s ?? data.inference_time ?? data.latency_s;
             const inferenceSeconds = rawInferenceTime !== undefined && rawInferenceTime !== null && rawInferenceTime !== "" ? Number(rawInferenceTime) : null;
             const inferenceText = inferenceSeconds !== null && !Number.isNaN(inferenceSeconds) ? `${inferenceSeconds.toFixed(2)}s` : 'æœªçŸ¥';
             const html = `
                <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #eee;">
                    <div style="font-size: 11px; color: #95a5a6; margin-bottom: 4px;">æµ‹è¯•æŒ‡ä»¤ (User Query):</div>
                    <div style="font-family: sans-serif; font-size: 14px; color: #34495e; font-weight: 500;">${escapeHtml(data.raw_query || '')}</div>
                </div>
                <div style="background: #f8f9fa; border-left: 4px solid #8e44ad; padding: 15px; border-radius: 4px;">
                     <div style="font-weight: bold; color: #8e44ad; margin-bottom: 10px; font-size: 14px;">ğŸ¯ æ„å›¾è·¯ç”±ç»“æœ</div>
                     <div style="margin-bottom: 8px;">
                        <strong>SOP ID:</strong> 
                        <code style="background: #f4ecf7; color: #6c3483; padding: 2px 6px; border-radius: 3px;">${data.sop_id}</code>
                     </div>
                     <div style="margin-bottom: 8px;">
                        <strong>SOP Name:</strong> ${data.sop_name}
                     </div>
                     <div style="margin-bottom: 8px;">
                        <strong>Reason (æ¨ç†):</strong> 
                        <div style="background: #fff; border: 1px solid #ddd; padding: 8px; margin-top: 5px; font-size: 12px; border-radius: 4px; color: #555;">${reasonText}</div>
                     </div>
                     <div style="margin-bottom: 8px;">
                        <strong>æ¨ç†æ—¶é—´:</strong> ${inferenceText}
                     </div>
                     <div>
                        <strong>æå–å‚æ•°:</strong> 
                        <pre style="background: #fff; border: 1px solid #ddd; padding: 8px; margin-top: 5px; font-size: 12px; border-radius: 4px;">${JSON.stringify(data.args, null, 2)}</pre>
                     </div>
                 </div>
             `;
             document.getElementById('testResultDisplay').innerHTML = html;
        }

        fetchModels();

        async function switchTest(testId, btn) {
            const intro = "æ ¹æ®æµ‹è¯•ç±»å‹åˆ‡æ¢ç•Œé¢å¸ƒå±€ã€‚";
            currentTestId = testId;
            document.querySelectorAll('.test-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            document.getElementById('testTitle').innerText = btn.querySelector('strong').innerText;
            
            // Show/Hide interfaces
            const samplesContainer = document.getElementById('samplesContainer');
            const chatSampleDiv = document.getElementById('sampleQueriesArea');
            const modeDiv = document.getElementById('unitTestModeSelection');
            const unitTestModelSelection = document.getElementById('unitTestModelSelection');
            const modelGrid = document.getElementById('modelGrid');

            // Hide all first
            samplesContainer.style.display = 'none';
            chatSampleDiv.style.display = 'none';
            modeDiv.style.display = 'none';
            unitTestModelSelection.style.display = 'none';
            modelGrid.style.display = 'none'; // Default hidden for unit tests

            if (testId === '0') {
                document.getElementById('chatInterface').style.display = 'flex';
                document.getElementById('unitTestInterface').style.display = 'none';
                document.getElementById('queryInput').placeholder = "è¾“å…¥æ‚¨æƒ³å¯¹ LLM è¯´çš„è¯...";
                
                samplesContainer.style.display = 'block';
                chatSampleDiv.style.display = 'block';
                modelGrid.style.display = 'grid'; // Show for chat
                await loadTestCases(testId);
            } else {
                document.getElementById('chatInterface').style.display = 'none';
                document.getElementById('unitTestInterface').style.display = 'flex';
                document.getElementById('queryInput').placeholder = "è¾“å…¥æµ‹è¯•å‚æ•°æˆ–ç›´æ¥ç‚¹å‡»è¿è¡Œ...";
                
                // Show samples container ONLY if there are samples for this test
                if (testId === '1' || testId === '2') {
                    samplesContainer.style.display = 'block';
                    chatSampleDiv.style.display = 'block'; // Reuse the same container
                    await loadTestCases(testId);
                    
                    if (testId === '1') {
                         // Test 01: No LLM involved, hide mode selection
                         modeDiv.style.display = 'none';
                    } else if (testId === '2') {
                        // Test 02: Needs LLM selection and Mode
                        modeDiv.style.display = 'flex';
                        unitTestModelSelection.style.display = 'flex';
                        modelGrid.style.display = 'grid';
                    }
                }
            }
            
            // Clear results
            document.getElementById('consoleArea').innerHTML = '';
            document.getElementById('testResultDisplay').innerHTML = `
                <div style="color: #95a5a6; font-style: italic; text-align: center; margin-top: 50px;">
                    æµ‹è¯•è¿è¡Œç»“æœå°†åœ¨æ­¤æ˜¾ç¤º
                </div>
            `;
            updateFlowchart(`graph TD\nStart((å¼€å§‹)) --> Idle[${mq('ç­‰å¾…æŒ‡ä»¤')}]`);
        }

        async function loadTestCases(testId) {
            const container = document.querySelector('#sampleQueriesArea .sample-queries');
            if (!container) return;
            container.innerHTML = '<span style="font-size:11px;color:#999;">åŠ è½½ä¸­...</span>';
            
            try {
                const response = await fetch(`${API_URL}/test_cases/${testId}`);
                const data = await response.json();
                
                container.innerHTML = ''; // Clear loading
                
                if (data.cases && data.cases.length > 0) {
                    data.cases.forEach(item => {
                        const btn = document.createElement('button');
                        btn.className = 'sample-btn';
                        btn.innerText = item.label;
                        btn.onclick = () => {
                            document.getElementById('queryInput').value = item.query;
                            if (currentTestId === '0') {
                                runChatTest();
                            } else {
                                runUnitTest(currentTestId);
                            }
                        };
                        container.appendChild(btn);
                    });
                } else {
                    container.innerHTML = '<span style="font-size:11px;color:#999;">æ— å¯ç”¨æ ·æœ¬</span>';
                }
            } catch (e) {
                console.error("Failed to load test cases", e);
                container.innerHTML = '<span style="font-size:11px;color:#999;">åŠ è½½å¤±è´¥</span>';
            }
        }

        function setQuery(text) {
            document.getElementById('queryInput').value = text;
        }

    let flowchartRenderPending = null;
    let flowchartRenderRunning = false;
    let flowchartFocusNode = null;
    function updateFlowchart(mermaidCode) {
        const intro = "æ’é˜Ÿæ¸²æŸ“ Mermaid æµç¨‹å›¾å¹¶é¿å…é—ªç™½ã€‚";
        const container = document.getElementById('flowchartArea');
        flowchartRenderPending = mermaidCode;
        if (flowchartRenderRunning) return;
        flowchartRenderRunning = true;
        const renderNext = async () => {
            while (flowchartRenderPending) {
                const code = flowchartRenderPending;
                flowchartRenderPending = null;
                try {
                    const { svg } = await mermaid.render('mermaid-svg', code);
                    container.innerHTML = svg;
                    if (flowchartFocusNode) {
                        requestAnimationFrame(() => centerFlowchartNode(flowchartFocusNode));
                    }
                } catch (e) {
                    console.error("Mermaid render failed", e);
                }
            }
            flowchartRenderRunning = false;
        };
        renderNext();
    }

    function setFlowchartFocusNode(nodeName) {
        const intro = "è®¾ç½®å½“å‰éœ€è¦å±…ä¸­çš„æµç¨‹å›¾èŠ‚ç‚¹ã€‚";
        flowchartFocusNode = nodeName;
    }

    function centerFlowchartNode(nodeName) {
        const intro = "å°†æµç¨‹å›¾ä¸­æŒ‡å®šèŠ‚ç‚¹æ»šåŠ¨åˆ°å®¹å™¨ä¸­é—´ã€‚";
        if (!nodeName) return;
        const container = document.getElementById('flowchartArea');
        if (!container) return;
        const safeName = window.CSS && CSS.escape ? CSS.escape(nodeName) : nodeName;
        const target = container.querySelector(`[id^="flowchart-${safeName}-"]`);
        if (!target) return;
        const containerRect = container.getBoundingClientRect();
        const targetRect = target.getBoundingClientRect();
        const delta = targetRect.top - containerRect.top - containerRect.height / 2 + targetRect.height / 2;
        container.scrollTop += delta;
    }

    function addConsoleLine(text, isError = false) {
        const consoleArea = document.getElementById('consoleArea');
        const div = document.createElement('div');
        div.className = 'trace-step';
        const time = new Date().toLocaleTimeString();
        const safeText = escapeHtml(text);
        div.innerHTML = `
            <span class="trace-step-time">[${time}]</span>
            <div class="trace-step-content" style="color: ${isError ? '#f44747' : '#ecf0f1'}">${safeText}</div>
        `;
        consoleArea.appendChild(div);
        consoleArea.scrollTop = consoleArea.scrollHeight;
    }

        function runCurrentAction() {
            if (currentTestId === '0') {
                runChatTest();
            } else if (currentTestId) {
                runUnitTest(currentTestId);
            } else {
                alert("è¯·å…ˆä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæµ‹è¯•é¡¹ã€‚");
            }
        }

        function updateTimer() {
            const elapsed = Date.now() - startTime;
            document.getElementById('timer').innerText = elapsed + 'ms';
        }

        function startTimer() {
            startTime = Date.now();
            document.getElementById('traceStats').style.display = 'block';
            timerInterval = setInterval(updateTimer, 50);
        }

        function stopTimer(status = 'å®Œæˆ') {
            clearInterval(timerInterval);
            const elapsed = Date.now() - startTime;
            const selectedModel = document.querySelector('input[name="selectedModel"]:checked')?.value;
            if (selectedModel) {
                const latencyEl = document.getElementById(`latency-${selectedModel}`);
                if (latencyEl) latencyEl.innerText = elapsed + 'ms';
            }
        }

        function addChatMessage(role, content) {
            const display = document.getElementById('chatDisplay');
            const div = document.createElement('div');
            div.className = `chat-bubble ${role}`;
            div.innerText = content;
            display.appendChild(div);
            display.scrollTop = display.scrollHeight;
        }

        async function runChatTest(runDefault = false) {
            let query = document.getElementById('queryInput').value;
            const model = document.querySelector('input[name="selectedModel"]:checked')?.value;
            const mode = document.querySelector('input[name="runMode"]:checked')?.value;
            
            if (runDefault) {
                query = ""; // Empty query triggers default suite in backend
            } else if (!query) {
                return;
            }
            
            if (!model) { alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¨¡å‹"); return; }

        if (query) {
            addChatMessage('user', query);
        } else {
            addChatMessage('user', "è¿è¡Œé»˜è®¤æµ‹è¯•å¥—ä»¶ (5ä¸ªæ ·æœ¬)");
        }
        
        document.getElementById('queryInput').value = '';
        document.getElementById('consoleArea').innerHTML = '';
        
        startTimer();
        
        addConsoleLine(`å¯åŠ¨ LLM å¯¹è¯æµ‹è¯•: æ¨¡å‹=${model}, æ¨¡å¼=${mode || 'é»˜è®¤'}, è¾“å…¥=${query || 'é»˜è®¤å¥—ä»¶'}`);
        // Initial flowchart
        updateFlowchart(`graph TD
            Start((Start)) --> API["API Bridge (APIæ¡¥æ¥)<br/>backend/api_bridge.py:run_test/0"]
            API --> Script["Test Script (æµ‹è¯•è„šæœ¬)<br/>tests/test_00_llm_chat.py"]
            Script --> LLM["LLM Core (æ ¸å¿ƒLLM)<br/>src/core/llm.py:chat"]
            LLM --> HTTP["Request (è¯·æ±‚)<br/>requests.post"]
            HTTP --> Waiting["Waiting for Response... (ç­‰å¾…å“åº”)"]
        `);

        try {
            let url = `${API_URL}/run_test/0?config=${encodeURIComponent(model)}&query=${encodeURIComponent(query)}`;
            if (mode) url += `&mode=${encodeURIComponent(mode)}`;
            
            const response = await fetch(url);
            const data = await response.json();
            
            const stdout = data.stdout || "";
            const responseMatch = stdout.match(/å“åº”å†…å®¹é¢„è§ˆ: (.*)\.\.\./);
            const botResponse = responseMatch ? responseMatch[1] : "æµ‹è¯•å®Œæˆï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚";
            
            // Extract function calls from stdout for chat test
            let chatFunctions = [];
            stdout.split('\n').forEach(line => {
                if (line.includes('[CALL]')) {
                    const func = line.split('[CALL]')[1]?.trim().replace('()', '');
                    if (func) chatFunctions.push(func);
                }
            });

            addChatMessage('bot', botResponse);
            addConsoleLine("æ”¶åˆ°åç«¯å“åº”:\n" + stdout);
            
            const successLabel = chatFunctions.length > 0 
                ? `å“åº”æˆåŠŸ\n(${chatFunctions.join(', ')})`
                : "å“åº”æˆåŠŸ";

            // Sanitize label for Mermaid: escape quotes and handle newlines
            const safeLabel = successLabel.replace(/"/g, "'").replace(/\n/g, '<br/>');
            const resultNode = data.exit_code === 0 
                ? `Success["Success (æˆåŠŸ)<br/>${safeLabel}"]` 
                : `Failed["Failed (å¤±è´¥)<br/>Exit Code: ${data.exit_code}"]`;
            
            const resultStyle = data.exit_code === 0 ? "style Success fill:#d4efdf,stroke:#27ae60" : "style Failed fill:#fadbd8,stroke:#c0392b";
            
            updateFlowchart(`graph TD
                Start((Start)) --> API["API Bridge (APIæ¡¥æ¥)<br/>backend/api_bridge.py:run_test/0"]
                API --> Script["Test Script (æµ‹è¯•è„šæœ¬)<br/>tests/test_00_llm_chat.py"]
                Script --> LLM["LLM Core (æ ¸å¿ƒLLM)<br/>src/core/llm.py:chat"]
                LLM --> HTTP["Request (è¯·æ±‚)<br/>requests.post"]
                HTTP --> ${resultNode}
                ${resultStyle}
            `);

            if (data.stderr) {
                addConsoleLine("é”™è¯¯è¾“å‡º: " + data.stderr, true);
            }
            
            stopTimer(data.exit_code === 0 ? 'æµ‹è¯•é€šè¿‡' : 'æµ‹è¯•å¤±è´¥');
        } catch (error) {
            addChatMessage('bot', "å‘ç”Ÿé”™è¯¯: " + error.message);
            addConsoleLine("è¿è¡Œæ—¶å¼‚å¸¸: " + error.message, true);
            updateFlowchart(`graph TD\nStart((å¼€å§‹)) --> Error[${mq('ç³»ç»Ÿé”™è¯¯: ' + error.message)}]\nError --> End((ç»“æŸ))`);
            stopTimer('è¿è¡Œå‡ºé”™');
        }
        }

    async function runUnitTest(testId) {
            // Collect UI State
            // query and mode will be determined below based on test ID and visibility
            const model = document.querySelector('input[name="selectedModel"]:checked')?.value;

            document.getElementById('consoleArea').innerHTML = '';
            document.getElementById('testResultDisplay').innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100px; color: #3498db;">
                    <div class="loading-spinner"></div>
                    <div style="margin-top: 10px; font-size: 13px;">æ­£åœ¨æ‰§è¡Œæµ‹è¯•è„šæœ¬...</div>
                </div>
            `;
            
            startTimer();
            
            // Get mode if visible
            const modeDiv = document.getElementById('unitTestModeSelection');
            let mode = null;
            if (modeDiv.style.display !== 'none') {
                mode = document.querySelector('input[name="unitTestRunMode"]:checked')?.value;
            }

            // Get query from main input if it's test 01 or 02
            let query = null;
            if (testId === '1' || testId === '2') {
                query = document.getElementById('queryInput').value;
                document.getElementById('queryInput').value = ''; // Clear input as requested
                addConsoleLine(`æµ‹è¯•æŒ‡ä»¤: "${query}"`);
            }

            // --- SPECIAL HANDLING FOR TEST 02 STREAMING ---
        if (testId === '2' && query) {
            // Validate Model Selection for Test 02
            if (!model) { 
                alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¨¡å‹ (Test 02 éœ€è¦ LLM)"); 
                document.getElementById('testResultDisplay').innerHTML = '';
                return; 
            }

            // Use the new streaming endpoint
            addConsoleLine(`å¯åŠ¨æ„å›¾è¯†åˆ«æµç¨‹ (Streaming)...`);
            addConsoleLine(`Model: ${model}, Mode: ${mode}`);
            
            // Init Flowchart
            const graphDef = `graph TD
                Start((Start)) --> API["API Endpoint (APIç«¯ç‚¹)<br/>backend/api_bridge.py:stream_test_02"]
                API --> SOP["Load SOPs (åŠ è½½SOP)<br/>src/core/sop_loader.py:load_all"]
                SOP --> ClassInit["Init Classifier (åˆå§‹åŒ–åˆ†ç±»å™¨)<br/>src/agents/classifier.py:__init__"]
                ClassInit --> Route["Route Intent (æ„å›¾è·¯ç”±)<br/>src/agents/classifier.py:route"]
                Route --> Prompt["Build Prompt (æ„å»ºæç¤ºè¯)<br/>src/agents/classifier.py:_build_prompt"]
                Prompt --> LLM["LLM Chat (LLMå¯¹è¯)<br/>src/core/llm.py:chat"]
                LLM --> Parse["Parse Response (è§£æå“åº”)<br/>src/agents/classifier.py"]
                Parse --> End(("Result (ç»“æœ)"))
                
                style Start fill:#ecf0f1,stroke:#bdc3c7
                style API fill:#e8f8f5,stroke:#1abc9c
                style SOP fill:#fff,stroke:#3498db,stroke-dasharray: 5 5
                style ClassInit fill:#fff,stroke:#bdc3c7
                style Route fill:#fff,stroke:#bdc3c7
                style Prompt fill:#fff,stroke:#bdc3c7
                style LLM fill:#fef9e7,stroke:#f1c40f
                style Parse fill:#fff,stroke:#bdc3c7
                style End fill:#ecf0f1,stroke:#bdc3c7
            `;
            updateFlowchart(graphDef);

            try {
                const url = `${API_URL}/test/stream/02?query=${encodeURIComponent(query)}&config=${encodeURIComponent(model)}&mode=${encodeURIComponent(mode)}`;
                const response = await fetch(url);
                const reader = response.body.getReader();
            const decoder = new TextDecoder();
                    let buffer = '';
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop(); // Keep incomplete line
                        
                        for (const line of lines) {
                            if (!line.trim()) continue;
                            try {
                                const event = JSON.parse(line);
                                handleTest02Event(event);
                            } catch (e) {
                                console.error("JSON Parse Error", e);
                            }
                        }
                    }
                    stopTimer('å®Œæˆ');
                } catch (e) {
                    addConsoleLine(`Error: ${e.message}`, true);
                    stopTimer('å‡ºé”™');
                }
                return; // Exit function, don't run legacy logic
            }

            addConsoleLine(`å•å…ƒæµ‹è¯•å¯åŠ¨: Test ID: ${testId} ${mode ? `(Mode: ${mode})` : ''}`);
            let graphDef = "";
            if (testId === '1') {
                graphDef = `graph TD
                    Start((Start)) --> API["API Bridge<br/>backend/api_bridge.py:run_test/1"]
                    API --> Script["Test Script<br/>tests/test_01_tool_registration.py"]
                    Script --> ToolsLoad["Load Tools<br/>src/tools/base.py:ToolRegistry.list_tools"]
                    ToolsLoad --> ToolsCheck["Validate Core Tools"]
                    ToolsCheck --> SOPLoad["Load SOPs<br/>src/core/sop_loader.py:load_all"]
                    SOPLoad --> SOPCheck["Validate Core SOPs"]
                    SOPCheck --> End((Wait Result))`;
            } else if (testId === '2') {
                 graphDef = `graph TD
                    Start((Start)) --> API["API Bridge<br/>backend/api_bridge.py:run_test/2"]
                    API --> Script["Test Script<br/>tests/test_02_intent_classifier.py"]
                    Script --> SOP["SOP Loader<br/>src/core/sop_loader.py"]
                    SOP --> Class["Classifier<br/>src/agents/classifier.py"]
                    Class --> End((Wait Result))`;
            } else {
                 graphDef = `graph TD\nStart((Start)) --> Init["åˆå§‹åŒ–æµ‹è¯•: ${testId}"]\nInit --> Running["è¿è¡Œä¸­..."]`;
            }
            if (testId === '1') {
                updateTest01Flowchart('running');
            } else {
                updateFlowchart(graphDef);
            }

            try {
                const config = document.querySelector('input[name="selectedModel"]:checked')?.value;
                
                let url = `${API_URL}/run_test/${testId}`;
                const params = [];
                if (mode) params.push(`mode=${encodeURIComponent(mode)}`);
                if (query) params.push(`query=${encodeURIComponent(query)}`);
                if (config) params.push(`config=${encodeURIComponent(config)}`);
                
                if (params.length > 0) {
                    url += `?${params.join('&')}`;
                }

                const response = await fetch(url);
                const data = await response.json();
                
                // Extract key result for display
                let summaryResult = "";
                
                // Common JSON extraction for structured tests
                let jsonResult = null;
                const jsonMatch = data.stdout.match(/__JSON_START__\s*([\s\S]*?)\s*__JSON_END__/);
                if (jsonMatch) {
                    try {
                        jsonResult = JSON.parse(jsonMatch[1]);
                    } catch (e) {
                        console.error("Failed to parse JSON result", e);
                    }
                }

                if (testId === '1') {
                    if (jsonResult) {
                        let toolsHtml = "";
                        let sopsHtml = "";
                        const toolCountMatch = data.stdout.match(/å·²æ³¨å†Œå·¥å…·æ•°é‡:\s*(\d+)/);
                        const sopCountMatch = data.stdout.match(/å·²åŠ è½½ SOP æ•°é‡:\s*(\d+)/);
                        const toolCount = toolCountMatch ? parseInt(toolCountMatch[1]) : (jsonResult.tools ? jsonResult.tools.filter(t => t.status === 'ok').length : 0);
                        const sopCount = sopCountMatch ? parseInt(sopCountMatch[1]) : (jsonResult.sops ? jsonResult.sops.filter(s => s.status === 'ok').length : 0);
                        if (jsonResult.tools && jsonResult.tools.length > 0) {
                            toolsHtml = jsonResult.tools.map(t => `
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 16px;">${t.status === 'ok' ? 'âœ…' : 'âŒ'}</span>
                                        <div>
                                            <div style="font-weight: bold; color: #2c3e50; display: flex; align-items: center;">
                                                ${t.name}
                                                ${t.execution && t.execution !== 'skipped' ? 
                                                    `<span style="font-size: 9px; padding: 1px 4px; border-radius: 3px; margin-left: 6px; background: ${t.execution==='success'?'#d4edda':(t.execution==='error'?'#f8d7da':'#fff3cd')}; color: ${t.execution==='success'?'#155724':(t.execution==='error'?'#721c24':'#856404')}">Run: ${t.execution}</span>` 
                                                    : ''}
                                            </div>
                                            <div style="font-size: 11px; color: #95a5a6;">${t.desc || 'No description'}</div>
                                        </div>
                                    </div>
                                    <div style="font-size: 10px; color: #bdc3c7; text-transform: uppercase;">TOOL</div>
                                </div>
                            `).join('');
                        }

                        if (jsonResult.sops && jsonResult.sops.length > 0) {
                            sopsHtml = jsonResult.sops.map(s => `
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 16px;">${s.status === 'missing' ? 'âŒ' : 'âœ…'}</span>
                                        <div>
                                            <div style="font-weight: bold; color: #2c3e50;">${s.name}</div>
                                            <div style="font-size: 11px; color: #95a5a6;">${s.desc || 'No description'}</div>
                                        </div>
                                    </div>
                                    <div style="font-size: 10px; color: #bdc3c7; text-transform: uppercase;">SOP</div>
                                </div>
                            `).join('');
                        }

                        summaryResult = `
                            <div style="background: white; border: 1px solid #e0e0e0; border-radius: 6px; overflow: hidden;">
                                <div style="padding: 10px 15px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0; font-weight: bold; color: #34495e;">
                                    èµ„æºåŠ è½½æ£€æŸ¥æ¸…å•
                                </div>
                                <div style="max-height: 300px; overflow-y: auto;">
                                    ${toolsHtml ? `<div style="padding: 5px 15px; background: #e8f8f5; color: #16a085; font-size: 11px; font-weight: bold;">Toolsï¼ˆ${toolCount}ï¼‰</div>${toolsHtml}` : ''}
                                    ${sopsHtml ? `<div style="padding: 5px 15px; background: #fef9e7; color: #f1c40f; font-size: 11px; font-weight: bold;">SOPsï¼ˆ${sopCount}ï¼‰</div>${sopsHtml}` : ''}
                                </div>
                            </div>
                        `;
                        updateTest01Flowchart('result', {
                            toolsError: (jsonResult.tools || []).some(t => t.status !== 'ok'),
                            sopsError: (jsonResult.sops || []).some(s => s.status === 'missing'),
                            sopsWarn: (jsonResult.sops || []).some(s => s.status === 'warning')
                        });
                    } else {
                        const toolMatch = data.stdout.match(/\[AI é€‰æ‹©\] å·¥å…·: (.*)/);
                        const paramsMatch = data.stdout.match(/\[AI å‚æ•°\] Inputs: (.*)/);
                        if (toolMatch) {
                            summaryResult = `
                                <div style="background: #f8f9fa; border-left: 4px solid #27ae60; padding: 15px; border-radius: 4px;">
                                    <div style="font-weight: bold; color: #27ae60; margin-bottom: 10px; font-size: 14px;">âœ… å·¥å…·é€‰æ‹©ç»“æœ</div>
                                    <div style="margin-bottom: 8px;"><strong>é€‰å®šå·¥å…·:</strong> <code style="background: #e8f6ef; color: #1e8449; padding: 2px 6px; border-radius: 3px;">${toolMatch[1]}</code></div>
                                    <div><strong>æå–å‚æ•°:</strong> <pre style="background: #fff; border: 1px solid #ddd; padding: 8px; margin-top: 5px; font-size: 12px; border-radius: 4px;">${paramsMatch ? paramsMatch[1] : '{}'}</pre></div>
                                </div>
                            `;
                        }
                        updateTest01Flowchart('result', {});
                    }
                } else if (testId === '2') {
        const stdout = data.stdout || "";
        console.log("Test 02 Output:", stdout); // Debug log
        const matchSuccess = stdout.includes('[AI åŒ¹é…æˆåŠŸ]') || stdout.includes('[MATCH SUCCESS]');
        const matchError = stdout.includes('[AI è¿è¡Œå‡ºé”™]') || stdout.includes('[AI ERROR]');
        // æ›´åŠ å®½æ¾çš„æ­£åˆ™åŒ¹é…ï¼Œæ”¯æŒä¸­æ–‡å’Œè‹±æ–‡æ ‡è®°
        const sopMatch = stdout.match(/åŒ¹é… SOP ID:\s*(.*?)($| \|)/i) || stdout.match(/SOP_ID:\s*(.*)/i);
        const argsMatch = stdout.match(/æå–å‚æ•°:\s*(.*?)($| \|)/i) || stdout.match(/ARGS:\s*(.*)/i);

        let queryDisplay = "";
        if (query) {
             queryDisplay = `
                <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #eee;">
                    <div style="font-size: 11px; color: #95a5a6; margin-bottom: 4px;">æµ‹è¯•æŒ‡ä»¤ (User Query):</div>
                    <div style="font-family: sans-serif; font-size: 14px; color: #34495e; font-weight: 500;">${escapeHtml(query)}</div>
                </div>
            `;
        }

        if (data.exit_code !== 0) {
            summaryResult = `
                ${queryDisplay}
                <div style="background: #fff5f5; border-left: 4px solid #e74c3c; padding: 15px; border-radius: 4px;">
                    <div style="font-weight: bold; color: #e74c3c; margin-bottom: 5px; font-size: 14px;">âŒ æµ‹è¯•æ‰§è¡Œå‡ºé”™</div>
                    <div style="font-size: 13px; color: #666;">Python è„šæœ¬è¿è¡Œå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºã€‚</div>
                </div>
            `;
        } else if (matchError) {
            summaryResult = `
                ${queryDisplay}
                <div style="background: #fff5f5; border-left: 4px solid #e74c3c; padding: 15px; border-radius: 4px;">
                    <div style="font-weight: bold; color: #e74c3c; margin-bottom: 5px; font-size: 14px;">âš ï¸ åˆ†ç±»å™¨æ‰§è¡Œå¼‚å¸¸</div>
                    <div style="font-size: 13px; color: #666;">AI å“åº”è§£æå¤±è´¥ï¼Œå¯èƒ½ç”±äºæ¨¡å‹è¾“å‡ºæ ¼å¼ä¸æ­£ç¡®æˆ–ç½‘ç»œè¶…æ—¶ã€‚</div>
                </div>
            `;
        } else if (matchSuccess && sopMatch) {
                         summaryResult = `
                             ${queryDisplay}
                             <div style="background: #f8f9fa; border-left: 4px solid #8e44ad; padding: 15px; border-radius: 4px;">
                                 <div style="font-weight: bold; color: #8e44ad; margin-bottom: 10px; font-size: 14px;">ğŸ¯ æ„å›¾è·¯ç”±æˆåŠŸ</div>
                                 <div style="margin-bottom: 8px;"><strong>åŒ¹é… SOP:</strong> <code style="background: #f4ecf7; color: #6c3483; padding: 2px 6px; border-radius: 3px;">${sopMatch[1].trim()}</code></div>
                                 <div><strong>æå–å‚æ•°:</strong> <pre style="background: #fff; border: 1px solid #ddd; padding: 8px; margin-top: 5px; font-size: 12px; border-radius: 4px;">${argsMatch ? argsMatch[1].trim() : '{}'}</pre></div>
                             </div>
                         `;
                     } else {
                         summaryResult = `
                             ${queryDisplay}
                             <div style="background: #fff5f5; border-left: 4px solid #e74c3c; padding: 15px; border-radius: 4px;">
                                 <div style="font-weight: bold; color: #e74c3c; margin-bottom: 5px; font-size: 14px;">âšª æœªåŒ¹é…åˆ° SOP</div>
                                 <div style="font-size: 13px; color: #666;">æŒ‡ä»¤å¯èƒ½å±äºé€šç”¨å¯¹è¯æˆ–ä¸å±äºç°æœ‰æµç¨‹ã€‚</div>
                             </div>
                         `;
                     }
                 }

                if (!summaryResult) {
                    summaryResult = `
                        <div style="background: #f8f9fa; border-left: 4px solid #3498db; padding: 15px; border-radius: 4px;">
                            <div style="font-weight: bold; color: #3498db; margin-bottom: 5px;">æµ‹è¯•æ‰§è¡Œå®Œæˆ</div>
                            <div style="font-size: 13px; color: #666;">è¯¦ç»†æ‰§è¡Œè¿‡ç¨‹è¯·æŸ¥çœ‹å³ä¾§å®æ—¶æ§åˆ¶å°è¾“å‡ºã€‚</div>
                            <div style="margin-top: 10px; font-size: 12px;">çŠ¶æ€ç : <span style="color: ${data.exit_code === 0 ? '#27ae60' : '#e74c3c'}">${data.exit_code}</span></div>
                        </div>
                    `;
                }

                document.getElementById('testResultDisplay').innerHTML = `
                    <div class="unit-test-result-summary">
                        <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 12px;">
                            æµ‹è¯•æ–‡ä»¶: <span style="font-family: monospace;">tests/${data.test_file}</span>
                        </div>
                        ${summaryResult}
                        ${data.stderr ? `
                            <div style="margin-top: 15px;">
                                <div style="font-size: 11px; color: #e74c3c; margin-bottom: 5px;">é”™è¯¯/è­¦å‘Šè¾“å‡º:</div>
                                <pre class="stderr" style="max-height: 100px; overflow-y: auto; font-size: 11px; background: #fdf2f2;">${escapeHtml(data.stderr)}</pre>
                            </div>
                        ` : ''}
                    </div>
                `;
            
            let flowchartSteps = [`Start((å¼€å§‹)) --> Init[${mq('æµ‹è¯•: ' + data.test_file)}]`];
            let lastNode = "Init";
            let stepCount = 0;
            let currentStepName = "";
            let currentStepDetails = [];
            const buildFlowchartSteps = testId !== '1';

            const lines = data.stdout.split('\n');
            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (!trimmedLine) return;

                if (trimmedLine.includes('-> æ­¥éª¤')) {
                    if (stepCount > 0 && buildFlowchartSteps) {
                        const nodeId = `Step${stepCount}`;
                        const label = currentStepDetails.length > 0 
                            ? `${currentStepName}\n${currentStepDetails.join('\n')}`
                            : currentStepName;
                        flowchartSteps.push(`${lastNode} --> ${nodeId}[${mq(label)}]`);
                        lastNode = nodeId;
                    }
                    
                    stepCount++;
                    currentStepName = trimmedLine.split(':')[1]?.trim() || `æ­¥éª¤${stepCount}`;
                    currentStepDetails = [];
                    addConsoleLine(trimmedLine);
                } else {
                    if (stepCount > 0 && buildFlowchartSteps) {
                        const cleanLine = trimmedLine.replace('[CALL]', 'ğŸ“').replace('[OK]', 'âœ…').replace('[ERROR]', 'âŒ');
                        currentStepDetails.push(cleanLine);
                    }
                    addConsoleLine(trimmedLine, trimmedLine.includes('[ERROR]') || trimmedLine.includes('å¤±è´¥'));
                }
            });

            if (buildFlowchartSteps) {
                if (stepCount > 0) {
                    const nodeId = `Step${stepCount}`;
                    const label = currentStepDetails.length > 0 
                        ? `${currentStepName}\n${currentStepDetails.join('\n')}`
                        : currentStepName;
                    flowchartSteps.push(`${lastNode} --> ${nodeId}[${mq(label)}]`);
                    lastNode = nodeId;
                }

                flowchartSteps.push(`${lastNode} --> End((å®Œæˆ))`);
                updateFlowchart(`graph TD\n${flowchartSteps.join('\n')}`);
            }

            if (data.stderr) {
                addConsoleLine("é”™è¯¯è¾“å‡º:\n" + data.stderr, true);
            }
            
            stopTimer(data.exit_code === 0 ? 'æµ‹è¯•é€šè¿‡' : 'æµ‹è¯•å¤±è´¥');
        } catch (error) {
            document.getElementById('testResultDisplay').innerHTML = `<div style="color: red;">è¿è¡Œå‡ºé”™: ${error.message}</div>`;
            addConsoleLine("è¿è¡Œå‡ºé”™: " + error.message, true);
            updateFlowchart(`graph TD\nStart((å¼€å§‹)) --> Error[${mq('ç³»ç»Ÿé”™è¯¯: ' + error.message)}]\nError --> End((ç»“æŸ))`);
            stopTimer('è¿è¡Œå‡ºé”™');
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML.replace(/\r?\n/g, "<br/>");
    }

    // Helper to quote labels for Mermaid to avoid syntax errors
    function mq(text) {
        if (!text) return '""';
        // Use double quotes for the label and escape internal double quotes
        // Replace newlines with <br/> for HTML labels
        return `"${text.toString().replace(/"/g, "'").replace(/\n/g, "<br/>")}"`;
    }
</script>
</body>
</html>
