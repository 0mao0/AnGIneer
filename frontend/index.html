<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PicoAgent Test Console</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({ 
            startOnLoad: false, 
            theme: 'neutral',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            themeVariables: {
                fontSize: '13px',
                fontFamily: 'arial',
                nodePadding: '10'
            }
        });
    </script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; background: #f5f5f5; display: flex; height: 100vh; overflow: hidden; }
        
        /* Left Sidebar: Test List */
        .sidebar { width: 260px; background: #2c3e50; color: white; padding: 20px; display: flex; flex-direction: column; gap: 10px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); flex-shrink: 0; }
        
        /* Middle Column: Interaction Area */
        .main-content { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; background: white; border-right: 1px solid #ddd; }
        
        /* Right Column: Execution Trace */
        .execution-trace { width: 450px; background: #f8f9fa; display: flex; flex-direction: column; flex-shrink: 0; border-left: 1px solid #ddd; height: 100vh; }
        
        .trace-section-header { 
            padding: 10px 15px; 
            background: #e9ecef; 
            border-bottom: 1px solid #dee2e6; 
            font-size: 12px; 
            font-weight: bold; 
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #flowchartArea { 
            flex: 1; 
            overflow: auto; 
            background: white; 
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        #flowchartArea svg {
            width: 100% !important;
            max-width: 100%;
            height: auto;
        }

        /* Ensure Mermaid labels can expand to fit content */
        .mermaid .label foreignObject {
            overflow: visible;
        }
        .mermaid .label foreignObject div {
            max-width: 200px !important;
            width: auto !important;
            display: inline-block !important;
            text-align: center !important;
            white-space: normal !important;
            word-wrap: break-word;
        }
        .nodeLabel {
            white-space: normal !important;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .unit-test-result-summary {
            background: white;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        #consoleArea { 
            height: 40%; 
            overflow-y: auto; 
            background: #2c3e50; 
            color: #ecf0f1; 
            padding: 15px; 
            font-family: 'Consolas', monospace; 
            font-size: 11px;
            border-top: 2px solid #34495e;
        }

        .trace-step {
            margin-bottom: 8px;
            border-bottom: 1px solid #3d566e;
            padding-bottom: 5px;
        }
        .trace-step-time { color: #95a5a6; font-size: 10px; }
        .trace-step-content { margin-top: 3px; white-space: pre-wrap; word-break: break-word; }
        
        .container { max-width: 100%; margin: 0; }
        h1, h2, h3 { margin-top: 0; color: #333; }
        h2 { color: #ecf0f1; font-size: 1.1rem; margin-bottom: 15px; }
        h3 { font-size: 0.9rem; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; }

        .input-group { margin-top: auto; padding-top: 20px; border-top: 1px solid #eee; display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; transition: background 0.2s; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; }
        
        .test-btn { background: #34495e; text-align: left; padding: 12px; border: none; border-radius: 4px; font-size: 12px; line-height: 1.4; border-left: 4px solid transparent; color: #bdc3c7; cursor: pointer; width: 100%; }
        .test-btn:hover { background: #4b6584; color: white; }
        .test-btn.active { border-left-color: #3498db; background: #3d566e; color: white; }
        .test-btn strong { display: block; color: white; margin-bottom: 3px; font-size: 13px; }

        /* Chat Styles */
        #chatDisplay { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; padding-bottom: 20px; }
        .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 8px; font-size: 14px; line-height: 1.5; position: relative; }
        .chat-bubble.user { align-self: flex-end; background: #007bff; color: white; border-bottom-right-radius: 2px; }
        .chat-bubble.bot { align-self: flex-start; background: #f0f0f0; color: #333; border-bottom-left-radius: 2px; border: 1px solid #e0e0e0; }
        
        /* Trace Card Styles */
        .trace-card { background: white; border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; margin-bottom: 12px; font-size: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .trace-card.running { border-left: 3px solid #007bff; }
        .trace-card.completed { border-left: 3px solid #28a745; }
        .trace-card.failed { border-left: 3px solid #dc3545; }
        .trace-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; color: #2c3e50; }
        .trace-meta { color: #7f8c8d; font-family: 'Consolas', monospace; font-size: 11px; margin-bottom: 5px; }
        .trace-details { color: #34495e; background: #fcfcfc; padding: 6px; border-radius: 4px; border: 1px solid #f0f0f0; margin-top: 5px; overflow-x: auto; }
        
        .status-badge { padding: 2px 5px; border-radius: 3px; font-size: 10px; color: white; text-transform: uppercase; }
        .status-running { background: #007bff; }
        .status-completed { background: #28a745; }
        .status-failed { background: #dc3545; }

        pre { margin: 0; white-space: pre-wrap; word-wrap: break-word; }
        
        #modelSelectionArea { background: #f8f9f9; padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #e5e8e8; }
        .model-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; }
        .model-item { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 12px; 
            cursor: pointer; 
            padding: 6px 10px; 
            border: 1px solid #d5dbdb; 
            border-radius: 4px;
            background: white;
            transition: all 0.2s;
        }
        .model-item:hover { border-color: #3498db; background: #ebf5fb; }
        .model-item input[type="radio"] { margin: 0; }
        .model-item.active { border-color: #3498db; background: #ebf5fb; font-weight: bold; }
        .model-name { color: #2c3e50; font-weight: 500; }
        .model-id { color: #7f8c8d; font-size: 10px; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }

        /* Unit Test Result Styles */
        .unit-test-result { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 4px; font-family: 'Consolas', monospace; font-size: 12px; }
        .unit-test-result .stdout { color: #d4d4d4; }
        .unit-test-result .stderr { color: #f44747; }

        /* Sample Queries */
        .sample-queries {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .sample-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 15px;
            padding: 4px 12px;
            font-size: 11px;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s;
        }
        .sample-btn:hover {
            background: #e9ecef;
            border-color: #ced4da;
            color: #212529;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>PicoAgent æµ‹è¯•å¥—ä»¶</h2>
        <button class="test-btn" id="btn-test-0" onclick="switchTest('0', this)">
            <strong>æµ‹è¯• 00: LLM å¯¹è¯èƒ½åŠ›</strong>
            é€‰æ‹©æ¨¡å‹ï¼ˆæ”¯æŒ NVIDIA, æ™ºè°± AI ç­‰ï¼‰å¹¶è¿›è¡Œå®æ—¶å¯¹è¯æµ‹è¯•.
        </button>
        <button class="test-btn" id="btn-test-1" onclick="switchTest('1', this)">
            <strong>æµ‹è¯• 01: å·¥å…·ä¸SOPåŠ è½½</strong>
            éªŒè¯ç³»ç»Ÿé™æ€èµ„æºï¼ˆTools/SOPsï¼‰çš„åŠ è½½æƒ…å†µ.
        </button>
        <button class="test-btn" id="btn-test-2" onclick="switchTest('2', this)">
            <strong>æµ‹è¯• 02: æ„å›¾è¯†åˆ«</strong>
            éªŒè¯å¯¹ä¸åŒç±»å‹é—®é¢˜çš„æ„å›¾å‘½ä¸­èƒ½åŠ› (SOPè·¯ç”±).
        </button>
        <button class="test-btn" id="btn-test-3" onclick="switchTest('3', this)">
            <strong>æµ‹è¯• 03: SOP è§£æ</strong>
            éªŒè¯ SOP æ­¥éª¤è§£æä¸å·¥å…·è¯†åˆ«èƒ½åŠ›.
        </button>
        <button class="test-btn" id="btn-test-4" onclick="switchTest('4', this)">
            <strong>æµ‹è¯• 04: å·¥å…·æœ‰æ•ˆæ€§</strong>
            ç‹¬ç«‹éªŒè¯è®¡ç®—å™¨ã€è¡¨æ ¼æŸ¥è¯¢ç­‰å·¥å…·çš„åŠŸèƒ½.
        </button>
        <button class="test-btn" id="btn-test-5" onclick="switchTest('5', this)">
            <strong>æµ‹è¯• 05: å…¨æµç¨‹æµ‹è¯•</strong>
            æ¨¡æ‹Ÿä»æŸ¥è¯¢åˆ°æ‰§è¡Œçš„å®Œæ•´ä¸šåŠ¡æµ.
        </button>
        
        <div style="margin-top: auto; font-size: 11px; color: #95a5a6; text-align: center; border-top: 1px solid #34495e; padding-top: 10px;">
            PicoAgent v0.1 Prototype
        </div>
    </div>

    <div class="main-content">
        <h1 id="testTitle">æµ‹è¯•æ§åˆ¶å°</h1>
        
        <!-- Test 00: Chat Interface -->
        <div id="chatInterface" style="display: none; flex: 1; flex-direction: column;">
            <div id="modelSelectionArea">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div style="font-weight: bold; font-size: 14px; color: #2980b9;">é€‰æ‹©æ¨¡å‹ä¸æ¨¡å¼:</div>
                    <div id="modeSelection" style="display: flex; gap: 15px; background: #ebf5fb; padding: 5px 15px; border-radius: 20px; border: 1px solid #d4e6f1;">
                        <label style="font-size: 12px; display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="radio" name="runMode" value=""> é»˜è®¤
                        </label>
                        <label style="font-size: 12px; display: flex; align-items: center; gap: 5px; cursor: pointer; color: #8e44ad; font-weight: bold;">
                            <input type="radio" name="runMode" value="thinking"> Thinking ğŸ§ 
                        </label>
                        <label style="font-size: 12px; display: flex; align-items: center; gap: 5px; cursor: pointer; color: #27ae60; font-weight: bold;">
                            <input type="radio" name="runMode" value="instruct" checked> Instruct ğŸ“
                        </label>
                    </div>
                </div>
                <div id="modelGrid" class="model-grid">
                    <!-- Models loaded here -->
                </div>
            </div>
            <div id="chatDisplay">
                <!-- Chat history -->
                <div class="chat-bubble bot">æ‚¨å¥½ï¼è¯·é€‰æ‹©å·¦ä¾§çš„æµ‹è¯•é¡¹ï¼Œæˆ–è€…åœ¨è¿™é‡Œé€‰æ‹©ä¸€ä¸ªæ¨¡å‹å¼€å§‹å¯¹è¯æµ‹è¯•ã€‚</div>
            </div>
        </div>

        <!-- Unit Test Interface -->
        <div id="unitTestInterface" style="display: none; flex: 1; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                <h3 style="margin: 0; color: #2c3e50;">æµ‹è¯•ç»“æœ</h3>
                <!-- Unit Test Mode Selection -->
                <div id="unitTestModeSelection" style="display: none; gap: 15px; background: #ebf5fb; padding: 5px 15px; border-radius: 20px; border: 1px solid #d4e6f1;">
                    <label style="font-size: 12px; display: flex; align-items: center; gap: 5px; cursor: pointer; color: #27ae60; font-weight: bold;">
                        <input type="radio" name="unitTestRunMode" value="instruct" checked> Instruct ğŸ“
                    </label>
                    <label style="font-size: 12px; display: flex; align-items: center; gap: 5px; cursor: pointer; color: #8e44ad; font-weight: bold;">
                        <input type="radio" name="unitTestRunMode" value="thinking"> Thinking ğŸ§ 
                    </label>
                </div>
            </div>
            
            <div id="testResultDisplay" style="flex: 1; overflow-y: auto;">
                <!-- Results of runUnitTest -->
                <div style="color: #95a5a6; font-style: italic; text-align: center; margin-top: 50px;">
                    æµ‹è¯•è¿è¡Œç»“æœå°†åœ¨æ­¤æ˜¾ç¤º
                </div>
            </div>
        </div>

        <div id="samplesContainer" style="margin-top: auto; padding-top: 10px;">
            <div id="sampleQueriesArea" style="display: none; margin-bottom: 5px;">
                <div style="font-size: 11px; color: #7f8c8d; margin-bottom: 5px; margin-left: 5px;">æ“ä½œ:</div>
                <div class="sample-queries">
                    <!-- Dynamic buttons will be loaded here -->
                </div>
            </div>
        </div>

        <div class="input-group">
            <input type="text" id="queryInput" placeholder="åœ¨æ­¤è¾“å…¥æ‚¨çš„æµ‹è¯•æŒ‡ä»¤..." onkeyup="if(event.keyCode===13) runCurrentAction()">
            <button id="runBtn" onclick="runCurrentAction()">è¿è¡Œ</button>
        </div>
    </div>

    <div class="execution-trace">
        <div class="trace-section-header">
            <span>æ‰§è¡Œæµç¨‹å›¾</span>
            <div id="traceStats" style="font-size: 11px; font-weight: normal;">
                è€—æ—¶: <span id="timer">0ms</span>
            </div>
        </div>
        <div id="flowchartArea">
            <div id="mermaidContainer" class="mermaid">
                graph TD
                Start((å¼€å§‹)) --> Idle[ç­‰å¾…æŒ‡ä»¤]
            </div>
        </div>

        <div class="trace-section-header">
            <span>å®æ—¶æ§åˆ¶å°è¾“å‡º</span>
            <button onclick="document.getElementById('consoleArea').innerHTML=''" style="padding: 2px 8px; font-size: 10px; background: #6c757d;">æ¸…ç©º</button>
        </div>
        <div id="consoleArea">
            <div style="color: #95a5a6; font-style: italic;">ç­‰å¾…æµ‹è¯•è¿è¡Œ...</div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let currentTestId = null;
        let startTime = 0;
        let timerInterval;
        let availableModels = [];

        async function fetchModels() {
            try {
                const response = await fetch(`${API_URL}/llm_configs`);
                availableModels = await response.json();
                const container = document.getElementById('modelGrid');
                container.innerHTML = availableModels.map((m, index) => `
                    <label class="model-item ${m.configured ? (index === 0 ? 'active' : '') : 'disabled'}" id="model-${m.name}">
                        <input type="radio" name="selectedModel" value="${m.name}" ${m.configured ? (index === 0 ? 'checked' : '') : 'disabled'} onchange="updateModelSelection(this)">
                        <div style="flex: 1">
                            <div class="model-name">${m.name}</div>
                            <div class="model-id">${m.model}</div>
                        </div>
                        <div class="model-latency" id="latency-${m.name}" style="font-size: 10px; color: #3498db; font-weight: bold;"></div>
                    </label>
                `).join('');
            } catch (e) {
                console.error('Failed to fetch models', e);
            }
        }

        function updateModelSelection(radio) {
            document.querySelectorAll('.model-item').forEach(el => el.classList.remove('active'));
            if (radio.checked) {
                radio.closest('.model-item').classList.add('active');
            }
        }

        fetchModels();

        async function switchTest(testId, btn) {
            currentTestId = testId;
            document.querySelectorAll('.test-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            document.getElementById('testTitle').innerText = btn.querySelector('strong').innerText;
            
            // Show/Hide interfaces
            const samplesContainer = document.getElementById('samplesContainer');
            const chatSampleDiv = document.getElementById('sampleQueriesArea');
            const modeDiv = document.getElementById('unitTestModeSelection');

            // Hide all first
            samplesContainer.style.display = 'none';
            chatSampleDiv.style.display = 'none';
            modeDiv.style.display = 'none';

            if (testId === '0') {
                document.getElementById('chatInterface').style.display = 'flex';
                document.getElementById('unitTestInterface').style.display = 'none';
                document.getElementById('queryInput').placeholder = "è¾“å…¥æ‚¨æƒ³å¯¹ LLM è¯´çš„è¯...";
                
                samplesContainer.style.display = 'block';
                chatSampleDiv.style.display = 'block';
                await loadTestCases(testId);
            } else {
                document.getElementById('chatInterface').style.display = 'none';
                document.getElementById('unitTestInterface').style.display = 'flex';
                document.getElementById('queryInput').placeholder = "è¾“å…¥æµ‹è¯•å‚æ•°æˆ–ç›´æ¥ç‚¹å‡»è¿è¡Œ...";
                
                // Show samples container ONLY if there are samples for this test
                if (testId === '1' || testId === '2') {
                    samplesContainer.style.display = 'block';
                    chatSampleDiv.style.display = 'block'; // Reuse the same container
                    await loadTestCases(testId);
                    
                    if (testId === '1') {
                         modeDiv.style.display = 'flex';
                    } else if (testId === '2') {
                        // Test 02 doesn't usually need mode selection but let's hide it or keep it if needed.
                        // Based on original code, Test 02 didn't strictly use mode in UI but backend supports it.
                        // Let's keep it hidden for simplicity unless requested, or match original behavior.
                        // Original had modeDiv.style.display = 'flex' for Test 2.
                         modeDiv.style.display = 'flex';
                    }
                }
            }
            
            // Clear results
            document.getElementById('consoleArea').innerHTML = '';
            document.getElementById('testResultDisplay').innerHTML = `
                <div style="color: #95a5a6; font-style: italic; text-align: center; margin-top: 50px;">
                    æµ‹è¯•è¿è¡Œç»“æœå°†åœ¨æ­¤æ˜¾ç¤º
                </div>
            `;
            updateFlowchart(`graph TD\nStart((å¼€å§‹)) --> Idle[${mq('ç­‰å¾…æŒ‡ä»¤')}]`);
        }

        async function loadTestCases(testId) {
            const container = document.querySelector('#sampleQueriesArea .sample-queries');
            if (!container) return;
            container.innerHTML = '<span style="font-size:11px;color:#999;">åŠ è½½ä¸­...</span>';
            
            try {
                const response = await fetch(`${API_URL}/test_cases/${testId}`);
                const data = await response.json();
                
                container.innerHTML = ''; // Clear loading
                
                if (data.cases && data.cases.length > 0) {
                    data.cases.forEach(item => {
                        const btn = document.createElement('button');
                        btn.className = 'sample-btn';
                        btn.innerText = item.label;
                        btn.onclick = () => {
                            document.getElementById('queryInput').value = item.query;
                            if (currentTestId === '0') {
                                runChatTest();
                            } else {
                                runUnitTest(currentTestId);
                            }
                        };
                        container.appendChild(btn);
                    });
                } else {
                    container.innerHTML = '<span style="font-size:11px;color:#999;">æ— å¯ç”¨æ ·æœ¬</span>';
                }
            } catch (e) {
                console.error("Failed to load test cases", e);
                container.innerHTML = '<span style="font-size:11px;color:#999;">åŠ è½½å¤±è´¥</span>';
            }
        }

        function setQuery(text) {
            document.getElementById('queryInput').value = text;
        }

    function updateFlowchart(mermaidCode) {
        const container = document.getElementById('flowchartArea');
        container.innerHTML = `<div id="mermaidContainer" class="mermaid">${mermaidCode}</div>`;
        mermaid.render('mermaid-svg', mermaidCode).then(({ svg }) => {
            container.innerHTML = svg;
        });
    }

    function addConsoleLine(text, isError = false) {
        const consoleArea = document.getElementById('consoleArea');
        const div = document.createElement('div');
        div.className = 'trace-step';
        const time = new Date().toLocaleTimeString();
        const safeText = escapeHtml(text);
        div.innerHTML = `
            <span class="trace-step-time">[${time}]</span>
            <div class="trace-step-content" style="color: ${isError ? '#f44747' : '#ecf0f1'}">${safeText}</div>
        `;
        consoleArea.appendChild(div);
        consoleArea.scrollTop = consoleArea.scrollHeight;
    }

        function runCurrentAction() {
            if (currentTestId === '0') {
                runChatTest();
            } else if (currentTestId) {
                runUnitTest(currentTestId);
            } else {
                alert("è¯·å…ˆä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæµ‹è¯•é¡¹ã€‚");
            }
        }

        function updateTimer() {
            const elapsed = Date.now() - startTime;
            document.getElementById('timer').innerText = elapsed + 'ms';
        }

        function startTimer() {
            startTime = Date.now();
            document.getElementById('traceStats').style.display = 'block';
            timerInterval = setInterval(updateTimer, 50);
        }

        function stopTimer(status = 'å®Œæˆ') {
            clearInterval(timerInterval);
            const elapsed = Date.now() - startTime;
            const selectedModel = document.querySelector('input[name="selectedModel"]:checked')?.value;
            if (selectedModel) {
                const latencyEl = document.getElementById(`latency-${selectedModel}`);
                if (latencyEl) latencyEl.innerText = elapsed + 'ms';
            }
        }

        function addChatMessage(role, content) {
            const display = document.getElementById('chatDisplay');
            const div = document.createElement('div');
            div.className = `chat-bubble ${role}`;
            div.innerText = content;
            display.appendChild(div);
            display.scrollTop = display.scrollHeight;
        }

        async function runChatTest(runDefault = false) {
            let query = document.getElementById('queryInput').value;
            const model = document.querySelector('input[name="selectedModel"]:checked')?.value;
            const mode = document.querySelector('input[name="runMode"]:checked')?.value;
            
            if (runDefault) {
                query = ""; // Empty query triggers default suite in backend
            } else if (!query) {
                return;
            }
            
            if (!model) { alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¨¡å‹"); return; }

        if (query) {
            addChatMessage('user', query);
        } else {
            addChatMessage('user', "è¿è¡Œé»˜è®¤æµ‹è¯•å¥—ä»¶ (5ä¸ªæ ·æœ¬)");
        }
        
        document.getElementById('queryInput').value = '';
        document.getElementById('consoleArea').innerHTML = '';
        
        startTimer();
        
        addConsoleLine(`å¯åŠ¨ LLM å¯¹è¯æµ‹è¯•: æ¨¡å‹=${model}, æ¨¡å¼=${mode || 'é»˜è®¤'}, è¾“å…¥=${query || 'é»˜è®¤å¥—ä»¶'}`);
        // Initial flowchart
        updateFlowchart(`graph TD\nStart((å¼€å§‹)) --> Request[${mq('å‘é€è¯·æ±‚: ' + model + (mode ? ' ['+mode+']' : ''))}]\nRequest --> Waiting[${mq('ç­‰å¾…å“åº”...')}]`);

        try {
            let url = `${API_URL}/run_test/0?config=${encodeURIComponent(model)}&query=${encodeURIComponent(query)}`;
            if (mode) url += `&mode=${encodeURIComponent(mode)}`;
            
            const response = await fetch(url);
            const data = await response.json();
            
            const stdout = data.stdout || "";
            const responseMatch = stdout.match(/å“åº”å†…å®¹é¢„è§ˆ: (.*)\.\.\./);
            const botResponse = responseMatch ? responseMatch[1] : "æµ‹è¯•å®Œæˆï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚";
            
            // Extract function calls from stdout for chat test
            let chatFunctions = [];
            stdout.split('\n').forEach(line => {
                if (line.includes('[CALL]')) {
                    const func = line.split('[CALL]')[1]?.trim().replace('()', '');
                    if (func) chatFunctions.push(func);
                }
            });

            addChatMessage('bot', botResponse);
            addConsoleLine("æ”¶åˆ°åç«¯å“åº”:\n" + stdout);
            
            const successLabel = chatFunctions.length > 0 
                ? `å“åº”æˆåŠŸ\n(${chatFunctions.join(', ')})`
                : "å“åº”æˆåŠŸ";

            if (data.exit_code === 0) {
                updateFlowchart(`graph TD\nStart((å¼€å§‹)) --> Request[${mq('å‘é€è¯·æ±‚: ' + model)}]\nRequest --> Success[${mq(successLabel)}]\nSuccess --> End((ç»“æŸ))`);
            } else {
                updateFlowchart(`graph TD\nStart((å¼€å§‹)) --> Request[${mq('å‘é€è¯·æ±‚: ' + model)}]\nRequest --> Failed[${mq('è¯·æ±‚å¤±è´¥')}]\nFailed --> End((ç»“æŸ))`);
            }

            if (data.stderr) {
                addConsoleLine("é”™è¯¯è¾“å‡º: " + data.stderr, true);
            }
            
            stopTimer(data.exit_code === 0 ? 'æµ‹è¯•é€šè¿‡' : 'æµ‹è¯•å¤±è´¥');
        } catch (error) {
            addChatMessage('bot', "å‘ç”Ÿé”™è¯¯: " + error.message);
            addConsoleLine("è¿è¡Œæ—¶å¼‚å¸¸: " + error.message, true);
            updateFlowchart(`graph TD\nStart((å¼€å§‹)) --> Error[${mq('ç³»ç»Ÿé”™è¯¯: ' + error.message)}]\nError --> End((ç»“æŸ))`);
            stopTimer('è¿è¡Œå‡ºé”™');
        }
        }

    async function runUnitTest(testId) {
            document.getElementById('consoleArea').innerHTML = '';
            document.getElementById('testResultDisplay').innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100px; color: #3498db;">
                    <div class="loading-spinner"></div>
                    <div style="margin-top: 10px; font-size: 13px;">æ­£åœ¨æ‰§è¡Œæµ‹è¯•è„šæœ¬...</div>
                </div>
            `;
            
            startTimer();
            
            // Get mode if visible
            const modeDiv = document.getElementById('unitTestModeSelection');
            let mode = null;
            if (modeDiv.style.display !== 'none') {
                mode = document.querySelector('input[name="unitTestRunMode"]:checked')?.value;
            }

            // Get query from main input if it's test 01
            let query = null;
            if (testId === '1') {
                query = document.getElementById('queryInput').value;
                addConsoleLine(`æµ‹è¯•æŒ‡ä»¤: "${query}"`);
            }

            addConsoleLine(`å•å…ƒæµ‹è¯•å¯åŠ¨: Test ID: ${testId} ${mode ? `(Mode: ${mode})` : ''}`);
            updateFlowchart(`graph TD\nStart((å¼€å§‹)) --> Init[${mq('åˆå§‹åŒ–æµ‹è¯•: ' + testId)}]\nInit --> Running[${mq('è¿è¡Œä¸­...')}]`);

            try {
                const config = document.querySelector('input[name="selectedModel"]:checked')?.value;
                
                let url = `${API_URL}/run_test/${testId}`;
                const params = [];
                if (mode) params.push(`mode=${encodeURIComponent(mode)}`);
                if (query) params.push(`query=${encodeURIComponent(query)}`);
                if (config) params.push(`config=${encodeURIComponent(config)}`);
                
                if (params.length > 0) {
                    url += `?${params.join('&')}`;
                }

                const response = await fetch(url);
                const data = await response.json();
                
                // Extract key result for display
                let summaryResult = "";
                
                // Common JSON extraction for structured tests
                let jsonResult = null;
                const jsonMatch = data.stdout.match(/__JSON_START__\s*([\s\S]*?)\s*__JSON_END__/);
                if (jsonMatch) {
                    try {
                        jsonResult = JSON.parse(jsonMatch[1]);
                    } catch (e) {
                        console.error("Failed to parse JSON result", e);
                    }
                }

                if (testId === '1') {
                    if (jsonResult) {
                        // Render Checklist from JSON
                        let toolsHtml = "";
                        if (jsonResult.tools && jsonResult.tools.length > 0) {
                            toolsHtml = jsonResult.tools.map(t => `
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 16px;">${t.status === 'ok' ? 'âœ…' : 'âŒ'}</span>
                                        <div>
                                            <div style="font-weight: bold; color: #2c3e50; display: flex; align-items: center;">
                                                ${t.name}
                                                ${t.execution && t.execution !== 'skipped' ? 
                                                    `<span style="font-size: 9px; padding: 1px 4px; border-radius: 3px; margin-left: 6px; background: ${t.execution==='success'?'#d4edda':(t.execution==='error'?'#f8d7da':'#fff3cd')}; color: ${t.execution==='success'?'#155724':(t.execution==='error'?'#721c24':'#856404')}">Run: ${t.execution}</span>` 
                                                    : ''}
                                            </div>
                                            <div style="font-size: 11px; color: #95a5a6;">${t.desc || 'No description'}</div>
                                        </div>
                                    </div>
                                    <div style="font-size: 10px; color: #bdc3c7; text-transform: uppercase;">TOOL</div>
                                </div>
                            `).join('');
                        }

                        let sopsHtml = "";
                        if (jsonResult.sops && jsonResult.sops.length > 0) {
                            sopsHtml = jsonResult.sops.map(s => `
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 16px;">${s.status === 'ok' ? 'âœ…' : (s.status === 'warning' ? 'âš ï¸' : 'âŒ')}</span>
                                        <div>
                                            <div style="font-weight: bold; color: #2c3e50;">${s.name}</div>
                                            <div style="font-size: 11px; color: #95a5a6;">${s.desc || 'No description'}</div>
                                        </div>
                                    </div>
                                    <div style="font-size: 10px; color: #bdc3c7; text-transform: uppercase;">SOP</div>
                                </div>
                            `).join('');
                        }

                        summaryResult = `
                            <div style="background: white; border: 1px solid #e0e0e0; border-radius: 6px; overflow: hidden;">
                                <div style="padding: 10px 15px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0; font-weight: bold; color: #34495e;">
                                    èµ„æºåŠ è½½æ£€æŸ¥æ¸…å•
                                </div>
                                <div style="max-height: 300px; overflow-y: auto;">
                                    ${toolsHtml ? `<div style="padding: 5px 15px; background: #e8f8f5; color: #16a085; font-size: 11px; font-weight: bold;">å·¥å…· (Tools)</div>${toolsHtml}` : ''}
                                    ${sopsHtml ? `<div style="padding: 5px 15px; background: #fef9e7; color: #f1c40f; font-size: 11px; font-weight: bold;">SOPs</div>${sopsHtml}` : ''}
                                </div>
                            </div>
                        `;
                    } else {
                        // Fallback to old regex if JSON missing (legacy support)
                        const toolMatch = data.stdout.match(/\[AI é€‰æ‹©\] å·¥å…·: (.*)/);
                        const paramsMatch = data.stdout.match(/\[AI å‚æ•°\] Inputs: (.*)/);
                        if (toolMatch) {
                            summaryResult = `
                                <div style="background: #f8f9fa; border-left: 4px solid #27ae60; padding: 15px; border-radius: 4px;">
                                    <div style="font-weight: bold; color: #27ae60; margin-bottom: 10px; font-size: 14px;">âœ… å·¥å…·é€‰æ‹©ç»“æœ</div>
                                    <div style="margin-bottom: 8px;"><strong>é€‰å®šå·¥å…·:</strong> <code style="background: #e8f6ef; color: #1e8449; padding: 2px 6px; border-radius: 3px;">${toolMatch[1]}</code></div>
                                    <div><strong>æå–å‚æ•°:</strong> <pre style="background: #fff; border: 1px solid #ddd; padding: 8px; margin-top: 5px; font-size: 12px; border-radius: 4px;">${paramsMatch ? paramsMatch[1] : '{}'}</pre></div>
                                </div>
                            `;
                        }
                    }
                } else if (testId === '2') {
        const stdout = data.stdout || "";
        console.log("Test 02 Output:", stdout); // Debug log
        const matchSuccess = stdout.includes('[AI åŒ¹é…æˆåŠŸ]') || stdout.includes('[MATCH SUCCESS]');
        const matchError = stdout.includes('[AI è¿è¡Œå‡ºé”™]') || stdout.includes('[AI ERROR]');
        // æ›´åŠ å®½æ¾çš„æ­£åˆ™åŒ¹é…ï¼Œæ”¯æŒä¸­æ–‡å’Œè‹±æ–‡æ ‡è®°
        const sopMatch = stdout.match(/åŒ¹é… SOP ID:\s*(.*?)($| \|)/i) || stdout.match(/SOP_ID:\s*(.*)/i);
        const argsMatch = stdout.match(/æå–å‚æ•°:\s*(.*?)($| \|)/i) || stdout.match(/ARGS:\s*(.*)/i);

        if (data.exit_code !== 0) {
            summaryResult = `
                <div style="background: #fff5f5; border-left: 4px solid #e74c3c; padding: 15px; border-radius: 4px;">
                    <div style="font-weight: bold; color: #e74c3c; margin-bottom: 5px; font-size: 14px;">âŒ æµ‹è¯•æ‰§è¡Œå‡ºé”™</div>
                    <div style="font-size: 13px; color: #666;">Python è„šæœ¬è¿è¡Œå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºã€‚</div>
                </div>
            `;
        } else if (matchError) {
            summaryResult = `
                <div style="background: #fff5f5; border-left: 4px solid #e74c3c; padding: 15px; border-radius: 4px;">
                    <div style="font-weight: bold; color: #e74c3c; margin-bottom: 5px; font-size: 14px;">âš ï¸ åˆ†ç±»å™¨æ‰§è¡Œå¼‚å¸¸</div>
                    <div style="font-size: 13px; color: #666;">AI å“åº”è§£æå¤±è´¥ï¼Œå¯èƒ½ç”±äºæ¨¡å‹è¾“å‡ºæ ¼å¼ä¸æ­£ç¡®æˆ–ç½‘ç»œè¶…æ—¶ã€‚</div>
                </div>
            `;
        } else if (matchSuccess && sopMatch) {
                         summaryResult = `
                             <div style="background: #f8f9fa; border-left: 4px solid #8e44ad; padding: 15px; border-radius: 4px;">
                                 <div style="font-weight: bold; color: #8e44ad; margin-bottom: 10px; font-size: 14px;">ğŸ¯ æ„å›¾è·¯ç”±æˆåŠŸ</div>
                                 <div style="margin-bottom: 8px;"><strong>åŒ¹é… SOP:</strong> <code style="background: #f4ecf7; color: #6c3483; padding: 2px 6px; border-radius: 3px;">${sopMatch[1].trim()}</code></div>
                                 <div><strong>æå–å‚æ•°:</strong> <pre style="background: #fff; border: 1px solid #ddd; padding: 8px; margin-top: 5px; font-size: 12px; border-radius: 4px;">${argsMatch ? argsMatch[1].trim() : '{}'}</pre></div>
                             </div>
                         `;
                     } else {
                         summaryResult = `
                             <div style="background: #fff5f5; border-left: 4px solid #e74c3c; padding: 15px; border-radius: 4px;">
                                 <div style="font-weight: bold; color: #e74c3c; margin-bottom: 5px; font-size: 14px;">âšª æœªåŒ¹é…åˆ° SOP</div>
                                 <div style="font-size: 13px; color: #666;">æŒ‡ä»¤å¯èƒ½å±äºé€šç”¨å¯¹è¯æˆ–ä¸å±äºç°æœ‰æµç¨‹ã€‚</div>
                             </div>
                         `;
                     }
                 }

                if (!summaryResult) {
                    summaryResult = `
                        <div style="background: #f8f9fa; border-left: 4px solid #3498db; padding: 15px; border-radius: 4px;">
                            <div style="font-weight: bold; color: #3498db; margin-bottom: 5px;">æµ‹è¯•æ‰§è¡Œå®Œæˆ</div>
                            <div style="font-size: 13px; color: #666;">è¯¦ç»†æ‰§è¡Œè¿‡ç¨‹è¯·æŸ¥çœ‹å³ä¾§å®æ—¶æ§åˆ¶å°è¾“å‡ºã€‚</div>
                            <div style="margin-top: 10px; font-size: 12px;">çŠ¶æ€ç : <span style="color: ${data.exit_code === 0 ? '#27ae60' : '#e74c3c'}">${data.exit_code}</span></div>
                        </div>
                    `;
                }

                document.getElementById('testResultDisplay').innerHTML = `
                    <div class="unit-test-result-summary">
                        <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 12px;">
                            æµ‹è¯•æ–‡ä»¶: <span style="font-family: monospace;">tests/${data.test_file}</span>
                        </div>
                        ${summaryResult}
                        ${data.stderr ? `
                            <div style="margin-top: 15px;">
                                <div style="font-size: 11px; color: #e74c3c; margin-bottom: 5px;">é”™è¯¯/è­¦å‘Šè¾“å‡º:</div>
                                <pre class="stderr" style="max-height: 100px; overflow-y: auto; font-size: 11px; background: #fdf2f2;">${escapeHtml(data.stderr)}</pre>
                            </div>
                        ` : ''}
                    </div>
                `;
            
            // Generate flowchart from steps
            let flowchartSteps = [`Start((å¼€å§‹)) --> Init[${mq('æµ‹è¯•: ' + data.test_file)}]`];
            let lastNode = "Init";
            let stepCount = 0;
            let currentStepName = "";
            let currentStepDetails = [];

            const lines = data.stdout.split('\n');
            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (!trimmedLine) return;

                if (trimmedLine.includes('-> æ­¥éª¤')) {
                    // If we had a previous step, add it now
                    if (stepCount > 0) {
                        const nodeId = `Step${stepCount}`;
                        const label = currentStepDetails.length > 0 
                            ? `${currentStepName}\n${currentStepDetails.join('\n')}`
                            : currentStepName;
                        flowchartSteps.push(`${lastNode} --> ${nodeId}[${mq(label)}]`);
                        lastNode = nodeId;
                    }
                    
                    stepCount++;
                    currentStepName = trimmedLine.split(':')[1]?.trim() || `æ­¥éª¤${stepCount}`;
                    currentStepDetails = [];
                    addConsoleLine(trimmedLine);
                } else {
                    // Collect everything else into details (similar to console)
                    if (stepCount > 0) {
                        // For flowchart, we might want to clean up some symbols for better look
                        const cleanLine = trimmedLine.replace('[CALL]', 'ğŸ“').replace('[OK]', 'âœ…').replace('[ERROR]', 'âŒ');
                        currentStepDetails.push(cleanLine);
                    }
                    addConsoleLine(trimmedLine, trimmedLine.includes('[ERROR]') || trimmedLine.includes('å¤±è´¥'));
                }
            });

            // Add the last step
            if (stepCount > 0) {
                const nodeId = `Step${stepCount}`;
                const label = currentStepDetails.length > 0 
                    ? `${currentStepName}\n${currentStepDetails.join('\n')}`
                    : currentStepName;
                flowchartSteps.push(`${lastNode} --> ${nodeId}[${mq(label)}]`);
                lastNode = nodeId;
            }

            flowchartSteps.push(`${lastNode} --> End((å®Œæˆ))`);
            updateFlowchart(`graph TD\n${flowchartSteps.join('\n')}`);

            if (data.stderr) {
                addConsoleLine("é”™è¯¯è¾“å‡º:\n" + data.stderr, true);
            }
            
            stopTimer(data.exit_code === 0 ? 'æµ‹è¯•é€šè¿‡' : 'æµ‹è¯•å¤±è´¥');
        } catch (error) {
            document.getElementById('testResultDisplay').innerHTML = `<div style="color: red;">è¿è¡Œå‡ºé”™: ${error.message}</div>`;
            addConsoleLine("è¿è¡Œå‡ºé”™: " + error.message, true);
            updateFlowchart(`graph TD\nStart((å¼€å§‹)) --> Error[${mq('ç³»ç»Ÿé”™è¯¯: ' + error.message)}]\nError --> End((ç»“æŸ))`);
            stopTimer('è¿è¡Œå‡ºé”™');
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML.replace(/\r?\n/g, "<br/>");
    }

    // Helper to quote labels for Mermaid to avoid syntax errors
    function mq(text) {
        if (!text) return '""';
        // Use double quotes for the label and escape internal double quotes
        // Replace newlines with <br/> for HTML labels
        return `"${text.toString().replace(/"/g, "'").replace(/\n/g, "<br/>")}"`;
    }
</script>
</body>
</html>
