<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PicoAgent Test Console</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({ 
            startOnLoad: false, 
            theme: 'neutral',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            themeVariables: {
                fontSize: '13px',
                fontFamily: 'arial',
                nodePadding: '10'
            }
        });
    </script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; background: #0f172a; display: flex; height: 100vh; overflow: hidden; color: #e2e8f0; }
        
        /* Left Sidebar: Test List */
        .sidebar { width: 260px; background: #1e293b; color: white; padding: 20px; display: flex; flex-direction: column; gap: 10px; box-shadow: 2px 0 12px rgba(0, 0, 0, 0.5); flex-shrink: 0; border-right: 1px solid #334155; }
        
        /* Middle Column: Interaction Area */
        .main-content { flex: 1; padding: 22px; overflow-y: auto; display: flex; flex-direction: column; background: #0f172a; border-right: 1px solid #334155; }
        
        /* Right Column: Execution Trace */
        .execution-trace { width: 450px; background: #1e293b; display: flex; flex-direction: column; flex-shrink: 0; border-left: 1px solid #334155; height: 100vh; }
        
        .trace-section-header { 
            padding: 10px 15px; 
            background: #334155; 
            border-bottom: 1px solid #475569; 
            font-size: 12px; 
            font-weight: bold; 
            color: #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #flowchartArea { 
            flex: 1; 
            overflow: auto; 
            background: #0f172a; 
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        #flowchartArea svg {
            width: 100% !important;
            max-width: 100%;
            height: auto;
            filter: invert(1) hue-rotate(180deg); /* Dark mode adjustment for mermaid default */
        }

        /* Ensure Mermaid labels can expand to fit content */
        .mermaid .label foreignObject {
            overflow: visible;
        }
        .mermaid .label foreignObject div {
            max-width: 200px !important;
            width: auto !important;
            display: inline-block !important;
            text-align: center !important;
            white-space: normal !important;
            word-wrap: break-word;
            color: #000; /* Inverted by filter above */
        }
        .nodeLabel {
            white-space: normal !important;
        }

        .loading-spinner {
            border: 3px solid #334155;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .unit-test-result-summary {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        #consoleArea { 
            height: 40%; 
            overflow-y: auto; 
            background: #020617; 
            color: #cbd5e1; 
            padding: 16px; 
            font-family: 'Consolas', monospace; 
            font-size: 11px;
            border-top: 2px solid #334155;
        }

        .trace-step {
            margin-bottom: 8px;
            border-bottom: 1px solid #1e293b;
            padding-bottom: 5px;
        }
        .trace-step-time { color: #64748b; font-size: 10px; }
        .trace-step-content { margin-top: 3px; white-space: pre-wrap; word-break: break-word; }
        
        .container { max-width: 100%; margin: 0; }
        h1, h2, h3 { margin-top: 0; color: #f1f5f9; }
        h2 { color: #e2e8f0; font-size: 1.1rem; margin-bottom: 15px; }
        h3 { font-size: 0.9rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; }

        .input-group { margin-top: auto; padding-top: 18px; border-top: 1px solid #334155; display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 12px 14px; background: #1e293b; border: 1px solid #475569; color: white; border-radius: 8px; font-size: 14px; transition: border 0.2s, box-shadow 0.2s; }
        input[type="text"]:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25); }
        button { padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; transition: background 0.2s, box-shadow 0.2s; box-shadow: 0 4px 10px rgba(37, 99, 235, 0.2); }
        button:hover { background: #2563eb; box-shadow: 0 6px 14px rgba(37, 99, 235, 0.25); }
        button:disabled { background: #475569; color: #94a3b8; }
        
        .test-btn { background: rgba(255, 255, 255, 0.03); text-align: left; padding: 12px; border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 10px; font-size: 12px; line-height: 1.4; border-left: 4px solid transparent; color: #cbd5e1; cursor: pointer; width: 100%; transition: background 0.2s, border 0.2s, transform 0.2s; }
        .test-btn:hover { background: rgba(255, 255, 255, 0.08); color: #ffffff; transform: translateY(-1px); }
        .test-btn.active { border-left-color: #60a5fa; background: rgba(59, 130, 246, 0.15); color: #ffffff; }
        .test-btn strong { display: block; color: white; margin-bottom: 3px; font-size: 13px; }

        /* Chat Styles */
        #chatDisplay { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; padding-bottom: 20px; }
        .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 8px; font-size: 14px; line-height: 1.5; position: relative; }
        .chat-bubble.user { align-self: flex-end; background: #2563eb; color: white; border-bottom-right-radius: 2px; }
        .chat-bubble.bot { align-self: flex-start; background: #334155; color: #e2e8f0; border-bottom-left-radius: 2px; border: 1px solid #475569; }
        
        /* Trace Card Styles */
        .trace-card { background: #1e293b; border: 1px solid #334155; border-radius: 6px; padding: 12px; margin-bottom: 12px; font-size: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); color: #e2e8f0; }
        .trace-card.running { border-left: 3px solid #3b82f6; }
        .trace-card.completed { border-left: 3px solid #22c55e; }
        .trace-card.failed { border-left: 3px solid #ef4444; }
        .trace-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; color: #e2e8f0; }
        .trace-meta { color: #94a3b8; font-family: 'Consolas', monospace; font-size: 11px; margin-bottom: 5px; }
        .trace-details { color: #cbd5e1; background: #0f172a; padding: 6px; border-radius: 4px; border: 1px solid #334155; margin-top: 5px; overflow-x: auto; }
        
        .status-badge { padding: 2px 5px; border-radius: 3px; font-size: 10px; color: white; text-transform: uppercase; }
        .status-running { background: #3b82f6; }
        .status-completed { background: #22c55e; }
        .status-failed { background: #ef4444; }

        pre { margin: 0; white-space: pre-wrap; word-wrap: break-word; color: #cbd5e1; }
        
        #modelSelectionArea { background: #1e293b; padding: 12px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #334155; }
        .model-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; }
        .model-item { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 12px; 
            cursor: pointer; 
            padding: 6px 10px; 
            border: 1px solid #334155; 
            border-radius: 8px;
            background: #0f172a;
            transition: all 0.2s;
            color: #e2e8f0;
        }
        .model-item:hover { border-color: #60a5fa; background: #334155; }
        .model-item input[type="radio"] { margin: 0; accent-color: #3b82f6; }
        .model-item.active { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); font-weight: bold; }
        .model-name { color: #f1f5f9; font-weight: 500; }
        .model-id { color: #94a3b8; font-size: 10px; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }

        /* Unit Test Result Styles */
        .unit-test-result { background: #020617; color: #e2e8f0; padding: 15px; border-radius: 4px; font-family: 'Consolas', monospace; font-size: 12px; border: 1px solid #334155; }
        .unit-test-result .stdout { color: #e2e8f0; }
        .unit-test-result .stderr { color: #fca5a5; }

        /* Sample Queries */
        #samplesContainer { padding-top: 8px; }
        #sampleQueriesArea { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 10px 12px; }
        .sample-queries {
            display: flex;
            gap: 10px;
            margin-bottom: 4px;
            flex-wrap: wrap;
        }
        .sample-btn {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 11px;
            color: #e2e8f0;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        .sample-btn:hover {
            background: #334155;
            border-color: #60a5fa;
            color: #60a5fa;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        /* Dark Mode Utility Classes for Test 03 */
        .border-blue-500 { border-color: #3b82f6 !important; }
        .bg-blue-900\/20 { background-color: rgba(30, 58, 138, 0.2) !important; }
        .border-slate-600 { border-color: #475569 !important; }
        .bg-slate-800 { background-color: #1e293b !important; }
        .text-blue-300 { color: #93c5fd !important; }
        .text-slate-200 { color: #e2e8f0 !important; }
        .text-green-400 { color: #4ade80 !important; }
        .text-red-400 { color: #f87171 !important; }
        .border-green-500 { border-color: #22c55e !important; }
        .bg-green-900\/20 { background-color: rgba(20, 83, 45, 0.2) !important; }
        .border-red-500 { border-color: #ef4444 !important; }
        .bg-red-900\/20 { background-color: rgba(127, 29, 29, 0.2) !important; }
        .animate-spin { animation: spin 1s linear infinite; }
        .transition-all { transition: all 0.3s ease; }
        .duration-300 { transition-duration: 300ms; }
        .rounded-md { border-radius: 0.375rem !important; }
        .p-3 { padding: 0.75rem !important; }
        .mb-3 { margin-bottom: 0.75rem !important; }
        .flex { display: flex !important; }
        .items-center { align-items: center !important; }
        .gap-2 { gap: 0.5rem !important; }
        .font-medium { font-weight: 500 !important; }
        .text-sm { font-size: 0.875rem !important; line-height: 1.25rem !important; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>PicoAgent æµ‹è¯•å¥—ä»¶</h2>
        <button class="test-btn" id="btn-test-0" onclick="switchTest('0', this)">
            <strong>æµ‹è¯• 00: LLM å¯¹è¯èƒ½åŠ›</strong>
            é€‰æ‹©AIæ¨¡å‹å¹¶è¿›è¡Œå®æ—¶å¯¹è¯æµ‹è¯•.
        </button>
        <button class="test-btn" id="btn-test-1" onclick="switchTest('1', this)">
            <strong>æµ‹è¯• 01: å·¥å…·ä¸SOPåŠ è½½</strong>
            éªŒè¯é™æ€èµ„æºï¼ˆTools/SOPsï¼‰çš„åŠ è½½æƒ…å†µ.
        </button>
        <button class="test-btn" id="btn-test-2" onclick="switchTest('2', this)">
            <strong>æµ‹è¯• 02: æ„å›¾è¯†åˆ«</strong>
            éªŒè¯ç”¨AIå‘½ä¸­SOPçš„èƒ½åŠ›.
        </button>
        <button class="test-btn" id="btn-test-3" onclick="switchTest('3', this)">
            <strong>æµ‹è¯• 03: SOP è§£æ</strong>
            éªŒè¯LLMè§£æSOP-Step-Toolçš„èƒ½åŠ›ã€‚
        </button>
        <button class="test-btn" id="btn-test-4" onclick="switchTest('4', this)">
            <strong>æµ‹è¯• 04: å·¥å…·æœ‰æ•ˆæ€§</strong>
            éªŒè¯Toolsï¼ˆè®¡ç®—å™¨ç­‰ï¼‰çš„ä¸ªä½“èƒ½åŠ›.
        </button>
        <button class="test-btn" id="btn-test-5" onclick="switchTest('5', this)">
            <strong>æµ‹è¯• 05: å…¨æµç¨‹æµ‹è¯•</strong>
            éªŒè¯å…¨æµç¨‹æ‰§è¡Œèƒ½åŠ›ï¼ˆä¸å«åˆ†å±‚Memoryï¼‰.
        </button>
        
        <div style="margin-top: auto; font-size: 11px; color: #95a5a6; text-align: center; border-top: 1px solid #34495e; padding-top: 10px;">
            PicoAgent v0.1 Prototype
        </div>
    </div>

    <div class="main-content">
        <h1 id="testTitle">æµ‹è¯•æ§åˆ¶å°</h1>
        
        <!-- Test 00: Chat Interface -->
        <div id="chatInterface" style="display: none; flex: 1; flex-direction: column;">
            <div id="modelSelectionArea">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div style="font-weight: bold; font-size: 14px; color: #2980b9;">é€‰æ‹©æ¨¡å‹ä¸æ¨¡å¼:</div>
                    <div id="modeSelection" style="display: flex; gap: 15px; background: #1e293b; padding: 5px 15px; border-radius: 20px; border: 1px solid #334155;">
                        <label style="font-size: 12px; display: flex; align-items: center; gap: 5px; cursor: pointer; color: #94a3b8;">
                            <input type="radio" name="runMode" value=""> é»˜è®¤
                        </label>
                        <label style="font-size: 12px; display: flex; align-items: center; gap: 5px; cursor: pointer; color: #d8b4fe; font-weight: bold;">
                            <input type="radio" name="runMode" value="thinking"> Thinking ğŸ§ 
                        </label>
                        <label style="font-size: 12px; display: flex; align-items: center; gap: 5px; cursor: pointer; color: #86efac; font-weight: bold;">
                            <input type="radio" name="runMode" value="instruct" checked> Instruct ğŸ“
                        </label>
                    </div>
                </div>
                <div id="modelGrid" class="model-grid">
                    <!-- Models loaded here -->
                </div>
            </div>
            <div id="chatDisplay">
                <!-- Chat history -->
                <div class="chat-bubble bot">æ‚¨å¥½ï¼è¯·é€‰æ‹©å·¦ä¾§çš„æµ‹è¯•é¡¹ï¼Œæˆ–è€…åœ¨è¿™é‡Œé€‰æ‹©ä¸€ä¸ªæ¨¡å‹å¼€å§‹å¯¹è¯æµ‹è¯•ã€‚</div>
            </div>
        </div>

        <!-- Unit Test Interface -->
        <div id="unitTestInterface" style="display: none; flex: 1; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                <h3 style="margin: 0; color: #2c3e50;">æµ‹è¯•ç»“æœ</h3>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div id="unitTestModelSelection" style="display: none; gap: 6px; align-items: center; background: #1e293b; padding: 5px 10px; border-radius: 20px; border: 1px solid #334155;">
                        <span style="font-size: 12px; color: #94a3b8;">æ¨¡å‹</span>
                        <select id="unitTestModelSelect" style="font-size: 12px; border: 1px solid #334155; padding: 2px 8px; border-radius: 12px; background: #0f172a; color: #cbd5e1; outline: none;" onchange="updateUnitTestModelSelection(this)">
                            <option value="">åŠ è½½ä¸­...</option>
                        </select>
                    </div>
                    <div id="unitTestModeSelection" style="display: none; gap: 15px; background: #1e293b; padding: 5px 15px; border-radius: 20px; border: 1px solid #334155;">
                        <label style="font-size: 12px; display: flex; align-items: center; gap: 5px; cursor: pointer; color: #86efac; font-weight: bold;">
                            <input type="radio" name="unitTestRunMode" value="instruct" checked> Instruct ğŸ“
                        </label>
                        <label style="font-size: 12px; display: flex; align-items: center; gap: 5px; cursor: pointer; color: #d8b4fe; font-weight: bold;">
                            <input type="radio" name="unitTestRunMode" value="thinking"> Thinking ğŸ§ 
                        </label>
                    </div>
                </div>
            </div>
            
            <div id="testResultDisplay" style="flex: 1; overflow-y: auto;">
                <!-- Results of runUnitTest -->
                <div style="color: #95a5a6; font-style: italic; text-align: center; margin-top: 50px;">
                    æµ‹è¯•è¿è¡Œç»“æœå°†åœ¨æ­¤æ˜¾ç¤º
                </div>
            </div>
        </div>

        <div id="samplesContainer" style="margin-top: auto; padding-top: 10px;">
            <div id="sampleQueriesArea" style="display: none; margin-bottom: 5px;">
                <div id="sampleQueriesTitle" style="font-size: 11px; color: #7f8c8d; margin-bottom: 5px; margin-left: 5px;">æ“ä½œ:</div>
                <div class="sample-queries">
                    <!-- Dynamic buttons will be loaded here -->
                </div>
            </div>
        </div>

        <div class="input-group">
            <input type="text" id="queryInput" placeholder="åœ¨æ­¤è¾“å…¥æ‚¨çš„æµ‹è¯•æŒ‡ä»¤..." onkeyup="if(event.keyCode===13) runCurrentAction()">
            <button id="runBtn" onclick="runCurrentAction()">è¿è¡Œ</button>
        </div>
    </div>

    <div class="execution-trace">
        <div class="trace-section-header">
            <span>æ‰§è¡Œæµç¨‹å›¾</span>
            <div id="traceStats" style="font-size: 11px; font-weight: normal;">
                è€—æ—¶: <span id="timer">0ms</span>
            </div>
        </div>
        <div id="flowchartArea">
            <div id="mermaidContainer" class="mermaid">
                graph TD
                Start((å¼€å§‹)) --> Idle[ç­‰å¾…æŒ‡ä»¤]
            </div>
        </div>

        <div class="trace-section-header">
            <span>å®æ—¶æ§åˆ¶å°è¾“å‡º</span>
            <button onclick="document.getElementById('consoleArea').innerHTML=''" style="padding: 2px 8px; font-size: 10px; background: #6c757d;">æ¸…ç©º</button>
        </div>
        <div id="consoleArea">
            <div style="color: #95a5a6; font-style: italic;">ç­‰å¾…æµ‹è¯•è¿è¡Œ...</div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8001';
        let currentTestId = null;
        let startTime = 0;
        let timerInterval;
        let consoleHeartbeatInterval = null;
        let lastConsoleActivity = 0;
        let availableModels = [];

        async function fetchModels() {
            const intro = "åŠ è½½å¯ç”¨æ¨¡å‹å¹¶åŒæ­¥é»˜è®¤é€‰æ‹©ã€‚";
            try {
                const response = await fetch(`${API_URL}/llm_configs?ts=${Date.now()}`);
                availableModels = await response.json();
                const container = document.getElementById('modelGrid');
                container.innerHTML = availableModels.map((m, index) => `
                    <label class="model-item ${m.configured ? (index === 0 ? 'active' : '') : 'disabled'}" id="model-${m.name}">
                        <input type="radio" name="selectedModel" value="${m.name}" ${m.configured ? (index === 0 ? 'checked' : '') : 'disabled'} onchange="updateModelSelection(this)">
                        <div style="flex: 1">
                            <div class="model-name">${m.name}</div>
                            <div class="model-id">${m.model}</div>
                        </div>
                        <div class="model-latency" id="latency-${m.name}" style="font-size: 10px; color: #3498db; font-weight: bold;"></div>
                    </label>
                `).join('');
                const unitTestSelect = document.getElementById('unitTestModelSelect');
                const configuredModels = availableModels.filter(m => m.configured);
                if (unitTestSelect) {
                    unitTestSelect.innerHTML = configuredModels.length > 0 
                        ? configuredModels.map(m => `<option value="${m.name}">${m.name}</option>`).join('')
                        : `<option value="">æ— å¯ç”¨æ¨¡å‹</option>`;
                }
                const defaultModel = pickDefaultModel(availableModels);
                if (defaultModel) {
                    const safeName = window.CSS && CSS.escape ? CSS.escape(defaultModel) : defaultModel;
                    const radio = document.querySelector(`input[name="selectedModel"][value="${safeName}"]`);
                    if (radio && !radio.disabled) {
                        radio.checked = true;
                        updateModelSelection(radio);
                    }
                    if (unitTestSelect) {
                        unitTestSelect.value = defaultModel;
                    }
                }
            } catch (e) {
                console.error('Failed to fetch models', e);
            }
        }

        function updateModelSelection(radio) {
            const intro = "åŒæ­¥æ¨¡å‹å¡ç‰‡ä¸ä¸‹æ‹‰é€‰æ‹©çŠ¶æ€ã€‚";
            // Update UI to show selection
            document.querySelectorAll('.model-item').forEach(el => {
                el.classList.remove('active');
            });
            const parent = document.getElementById(`model-${radio.value}`);
            if (parent) parent.classList.add('active');
            const unitTestSelect = document.getElementById('unitTestModelSelect');
            if (unitTestSelect && unitTestSelect.value !== radio.value) {
                unitTestSelect.value = radio.value;
            }
            
            addConsoleLine(`Model changed to: ${radio.value}`);
        }

        function updateUnitTestModelSelection(select) {
            const intro = "å°†ç»“æœåŒºæ¨¡å‹é€‰æ‹©åŒæ­¥åˆ°æ¨¡å‹å¡ç‰‡ã€‚";
            const safeName = window.CSS && CSS.escape ? CSS.escape(select.value) : select.value;
            const radio = document.querySelector(`input[name="selectedModel"][value="${safeName}"]`);
            if (radio && !radio.disabled) {
                radio.checked = true;
                updateModelSelection(radio);
            }
        }

        function pickDefaultModel(models) {
            const intro = "ä¼˜å…ˆé€‰æ‹© Qwen-VL ç³»åˆ—ä½œä¸ºé»˜è®¤æ¨¡å‹ã€‚";
            if (!models || models.length === 0) return null;
            const candidates = models.filter(m => m.configured);
            const keywords = ["Qwen-VL", "Qwen3-VL", "Qwen VL"];
            const preferred = candidates.find(m => keywords.some(k => (m.name || "").includes(k) || (m.model || "").includes(k)));
            return (preferred || candidates[0])?.name || null;
        }

        // --- Helpers for Test 02 Streaming ---
        function handleTest02Event(event) {
            if (event.status === 'running') {
                addConsoleLine(`[${event.step}] ${event.msg}`);
                updateTest02Flowchart(event.step);
            } else if (event.status === 'done') {
                addConsoleLine(`[${event.step}] âœ… ${event.msg}`);
                if (event.step === 'result') {
                    renderTest02Result(event.data);
                }
                updateTest02Flowchart(event.step, true);
            } else if (event.status === 'failed') {
                 addConsoleLine(`[${event.step}] âŒ ${event.msg}`, true);
            } else if (event.status === 'warning') {
                 addConsoleLine(`[${event.step}] âš ï¸ ${event.msg}`);
            }
        }

        let test04StreamState = { cases: {}, order: [] };
        let test04StartTime = 0;
        let test04TimerInterval = null;

        function resetTest04StreamState() {
            const intro = "é‡ç½® Test04 æµå¼æ¸²æŸ“çŠ¶æ€ã€‚";
            test04StreamState = { cases: {}, order: [] };
        }

        function ensureTest04StreamContainer() {
            const intro = "åˆ›å»ºæˆ–è·å– Test04 æµå¼ç»“æœå®¹å™¨ã€‚";
            const resultEl = document.getElementById('testResultDisplay');
            if (!resultEl) return null;
            let wrapper = document.getElementById('test04StreamWrapper');
            if (!wrapper) {
                resultEl.innerHTML = `
                    <div id="test04StreamWrapper" data-streaming="true">
                        <div style="background: #0f172a; border-left: 4px solid #38bdf8; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #334155;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 15px;">
                                <div id="test04ReportTitle" style="font-weight: bold; color: #38bdf8; font-size: 14px; line-height: 1.4;">ğŸ§° å·¥å…·èƒ½åŠ›éªŒè¯</div>
                                <div style="font-size: 12px; color: #94a3b8; white-space: nowrap; flex-shrink: 0; background: #0b1220; padding: 4px 8px; border-radius: 4px; border: 1px solid #1e293b;">
                                    è€—æ—¶ï¼š<span id="test04SummaryDuration" style="color: #fcd34d; font-weight: bold; font-family: monospace;">0.00ç§’</span>
                                </div>
                            </div>
                            <div style="margin-top: 6px; font-size: 12px; color: #94a3b8;">å·²æ‰§è¡Œ <span id="test04SummaryCount" style="color: #e2e8f0; font-weight: bold;">0</span> é¡¹</div>
                        </div>
                        <div id="test04StreamCases"></div>
                    </div>
                `;
                wrapper = document.getElementById('test04StreamWrapper');
            }
            return wrapper;
        }

        function updateTest04Summary(durationText, countText) {
            const intro = "åˆ·æ–° Test04 æµå¼ç»“æœæ‘˜è¦ã€‚";
            ensureTest04StreamContainer();
            const durationEl = document.getElementById('test04SummaryDuration');
            if (durationEl && durationText !== null && durationText !== undefined) {
                durationEl.textContent = durationText || '0.00ç§’';
            }
            const countEl = document.getElementById('test04SummaryCount');
            if (countEl) countEl.textContent = countText ?? '0';
        }

        function formatTest04Duration(seconds) {
            const intro = "æ ¼å¼åŒ– Test04 è®¡æ—¶æ˜¾ç¤ºã€‚";
            const safeSeconds = Number.isFinite(seconds) ? Math.max(0, seconds) : 0;
            if (safeSeconds >= 60) {
                const minutes = Math.floor(safeSeconds / 60);
                const remain = safeSeconds - minutes * 60;
                return `${minutes}åˆ†${remain.toFixed(2)}ç§’`;
            }
            return `${safeSeconds.toFixed(2)}ç§’`;
        }

        function startTest04Duration() {
            const intro = "å¯åŠ¨ Test04 è®¡æ—¶åˆ·æ–°ã€‚";
            if (test04TimerInterval) {
                clearInterval(test04TimerInterval);
                test04TimerInterval = null;
            }
            test04StartTime = Date.now();
            updateTest04Summary(formatTest04Duration(0), 0);
            test04TimerInterval = setInterval(() => {
                const elapsed = (Date.now() - test04StartTime) / 1000;
                updateTest04Summary(formatTest04Duration(elapsed), test04StreamState.order.length);
            }, 200);
        }

        function stopTest04Duration(finalSeconds = null) {
            const intro = "åœæ­¢ Test04 è®¡æ—¶åˆ·æ–°å¹¶æ›´æ–°æœ€ç»ˆè€—æ—¶ã€‚";
            if (test04TimerInterval) {
                clearInterval(test04TimerInterval);
                test04TimerInterval = null;
            }
            const seconds = finalSeconds == null ? (Date.now() - test04StartTime) / 1000 : finalSeconds;
            updateTest04Summary(formatTest04Duration(seconds), test04StreamState.order.length);
        }

        function upsertTest04Case(caseItem) {
            const intro = "æ’å…¥æˆ–æ›´æ–° Test04 å·¥å…·æµ‹è¯•ç»“æœã€‚";
            if (!caseItem || !caseItem.id) return;
            if (!test04StreamState.cases[caseItem.id]) {
                test04StreamState.order.push(caseItem.id);
            }
            test04StreamState.cases[caseItem.id] = caseItem;
            ensureTest04StreamContainer();
            const casesContainer = document.getElementById('test04StreamCases');
            if (!casesContainer) return;
            const orderedCases = test04StreamState.order.map(id => test04StreamState.cases[id]).filter(Boolean);
            casesContainer.innerHTML = renderTest04Result({ cases: orderedCases });
            updateTest04Summary(null, orderedCases.length);
        }

        function handleTest04Event(event) {
            const intro = "å¤„ç† Test04 æµå¼äº‹ä»¶å¹¶æ›´æ–°ç•Œé¢ã€‚";
            if (event.status === 'running') {
                addConsoleLine(`[${event.step}] ${event.msg}`);
                updateTest04Flowchart(event.step, false, event.tool);
            } else if (event.status === 'done') {
                addConsoleLine(`[${event.step}] âœ… ${event.msg}`);
                if (event.step === 'case_run' && event.payload) {
                    upsertTest04Case(event.payload);
                }
                if (event.step === 'result' && event.data) {
                    const cases = Array.isArray(event.data.cases) ? event.data.cases : [];
                    cases.forEach(item => upsertTest04Case(item));
                    if (event.duration_s != null) {
                        stopTest04Duration(event.duration_s);
                    } else {
                        stopTest04Duration(null);
                    }
                }
                updateTest04Flowchart(event.step, true, event.tool);
            } else if (event.status === 'failed') {
                addConsoleLine(`[${event.step}] âŒ ${event.msg}`, true);
            } else if (event.status === 'warning') {
                addConsoleLine(`[${event.step}] âš ï¸ ${event.msg}`);
            }
        }

        let test03StreamState = { cases: {}, order: [] };
        let test03StartTime = 0;
        let test03TimerInterval = null;
        let test03StepTimers = {};
        let test03StepTimerInterval = null;

        function resetTest03StreamState() {
            const intro = "é‡ç½® Test03 æµå¼æ¸²æŸ“çŠ¶æ€ã€‚";
            test03StreamState = { cases: {}, order: [] };
            test03StepTimers = {};
        }

        function ensureTest03StreamContainer() {
            const intro = "åˆ›å»ºæˆ–è·å– Test03 æµå¼ç»“æœå®¹å™¨ã€‚";
            const resultEl = document.getElementById('testResultDisplay');
            if (!resultEl) return null;
            let wrapper = document.getElementById('test03StreamWrapper');
            if (!wrapper) {
                resultEl.innerHTML = `
                    <div id="test03StreamWrapper" data-streaming="true">
                        <div style="background: #1e293b; border-left: 4px solid #1abc9c; padding: 15px; border-radius: 4px; margin-bottom: 15px; border: 1px solid #334155;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 15px;">
                                <div id="test03ReportTitle" style="font-weight: bold; color: #1abc9c; font-size: 14px; line-height: 1.4;">ğŸ§© SOP Step Analysis</div>
                                <div style="font-size: 12px; color: #94a3b8; white-space: nowrap; flex-shrink: 0; background: #0f172a; padding: 4px 8px; border-radius: 4px; border: 1px solid #334155;">
                                    è€—æ—¶ï¼š<span id="test03SummaryDuration" style="color: #fcd34d; font-weight: bold; font-family: monospace;">0.00ç§’</span>
                                </div>
                            </div>
                        </div>
                        <div id="test03StreamCases"></div>
                    </div>
                `;
                wrapper = document.getElementById('test03StreamWrapper');
            }
            return wrapper;
        }

        function updateTest03Summary(durationText) {
            const intro = "åˆ·æ–° Test03 æµå¼ç»“æœæ‘˜è¦ã€‚";
            ensureTest03StreamContainer();
            const durationEl = document.getElementById('test03SummaryDuration');
            if (durationEl) durationEl.textContent = durationText || '0.00ç§’';
        }

        function updateTest03SummaryQuery(queryText) {
            // Deprecated: Query is now handled via Case Title or removed as per user request
        }

        function formatTest03Duration(seconds) {
            const intro = "æ ¼å¼åŒ– Test03 è®¡æ—¶æ˜¾ç¤ºã€‚";
            const safeSeconds = Number.isFinite(seconds) ? Math.max(0, seconds) : 0;
            if (safeSeconds >= 60) {
                const minutes = Math.floor(safeSeconds / 60);
                const remain = safeSeconds - minutes * 60;
                return `${minutes}åˆ†${remain.toFixed(2)}ç§’`;
            }
            return `${safeSeconds.toFixed(2)}ç§’`;
        }

        function startTest03Duration() {
            const intro = "å¯åŠ¨ Test03 è®¡æ—¶åˆ·æ–°ã€‚";
            if (test03TimerInterval) {
                clearInterval(test03TimerInterval);
                test03TimerInterval = null;
            }
            test03StartTime = Date.now();
            updateTest03Summary(formatTest03Duration(0));
            test03TimerInterval = setInterval(() => {
                const elapsed = (Date.now() - test03StartTime) / 1000;
                updateTest03Summary(formatTest03Duration(elapsed));
            }, 200);
        }

        function stopTest03Duration(finalSeconds = null) {
            const intro = "åœæ­¢ Test03 è®¡æ—¶åˆ·æ–°å¹¶æ›´æ–°æœ€ç»ˆè€—æ—¶ã€‚";
            if (test03TimerInterval) {
                clearInterval(test03TimerInterval);
                test03TimerInterval = null;
            }
            const seconds = finalSeconds == null ? (Date.now() - test03StartTime) / 1000 : finalSeconds;
            updateTest03Summary(formatTest03Duration(seconds));
        }

        function startTest03StepDurationTicker() {
            const intro = "å¯åŠ¨ Test03 æ­¥éª¤è€—æ—¶åˆ·æ–°ã€‚";
            if (test03StepTimerInterval) {
                clearInterval(test03StepTimerInterval);
                test03StepTimerInterval = null;
            }
            test03StepTimerInterval = setInterval(() => {
                updateAllTest03StepDurations();
            }, 200);
        }

        function stopTest03StepDurationTicker() {
            const intro = "åœæ­¢ Test03 æ­¥éª¤è€—æ—¶åˆ·æ–°ã€‚";
            if (test03StepTimerInterval) {
                clearInterval(test03StepTimerInterval);
                test03StepTimerInterval = null;
            }
        }

        function updateAllTest03StepDurations() {
            const intro = "åˆ·æ–°æ‰€æœ‰ Test03 æ­¥éª¤è€—æ—¶æ–‡æœ¬ã€‚";
            const timerEls = document.querySelectorAll('[data-test03-step-timer]');
            if (!timerEls || timerEls.length === 0) return;
            timerEls.forEach(el => {
                const key = el.getAttribute('data-test03-step-timer');
                if (!key || !test03StepTimers[key]) return;
                const timer = test03StepTimers[key];
                const endTime = timer.end ?? Date.now();
                const elapsedSeconds = (endTime - timer.start) / 1000;
                el.textContent = `è€—æ—¶ï¼š${formatTest03Duration(elapsedSeconds)}`;
            });
        }

        function ensureTest03Case(caseInfo) {
            const intro = "åˆ›å»ºæˆ–æ›´æ–° Test03 ç”¨ä¾‹å¡ç‰‡ã€‚";
            if (!caseInfo || !caseInfo.case_id) return null;
            ensureTest03StreamContainer();
            const safeId = window.CSS && CSS.escape ? CSS.escape(caseInfo.case_id) : caseInfo.case_id;
            const casesContainer = document.getElementById('test03StreamCases');
            if (!casesContainer) return null;
            
            // Update Top Header with Case Query (Topic Name)
            const reportTitle = document.getElementById('test03ReportTitle');
            if (reportTitle && (caseInfo.case_query || caseInfo.case_label)) {
                reportTitle.textContent = `ç”¨æˆ·éœ€æ±‚ï¼š${caseInfo.case_query || caseInfo.case_label}`;
            }

            let caseEl = casesContainer.querySelector(`[data-test03-case="${safeId}"]`);
            if (!caseEl) {
                const label = escapeHtml(caseInfo.case_label || caseInfo.case_id || 'æœªå‘½åç”¨ä¾‹');
                caseEl = document.createElement('div');
                caseEl.setAttribute('data-test03-case', caseInfo.case_id);
                caseEl.style.cssText = "margin-bottom:15px;color:#e2e8f0;";
                caseEl.innerHTML = `
                    <div data-test03-case-steps></div>
                `;
                casesContainer.appendChild(caseEl);
                test03StreamState.order.push(caseInfo.case_id);
            }
            return caseEl;
        }

        function appendTest03Step(caseId, stepIndex, payload, isRunning = false) {
            const intro = "è¿½åŠ æˆ–æ›´æ–° Test03 å•æ­¥åˆ†æç»“æœ (UI/UX Pro Max)ã€‚";
            if (!caseId) return;
            const caseEl = ensureTest03Case({ case_id: caseId });
            if (!caseEl) return;
            const stepsEl = caseEl.querySelector('[data-test03-case-steps]');
            if (!stepsEl) return;
            const stepKey = stepIndex ? `index-${stepIndex}` : `index-${stepsEl.children.length + 1}`;
            const existing = stepsEl.querySelector(`[data-test03-step="${stepKey}"]`);

            // çŠ¶æ€å›¾æ ‡ä¸é¢œè‰² (è‰²ç›²å‹å¥½)
            const statusIcon = isRunning ? 
                '<span class="animate-spin">â³</span>' : 
                'âœ…';
            const statusClass = isRunning ? 'border-blue-500 bg-blue-900/20' : 'border-slate-600 bg-slate-800';
            const titleColor = isRunning ? 'text-blue-300' : 'text-slate-200';
            const stepTimerKey = `${caseId}::${stepKey}`;
            const now = Date.now();
            if (!test03StepTimers[stepTimerKey]) {
                test03StepTimers[stepTimerKey] = { start: now, end: null };
            }
            if (!isRunning && test03StepTimers[stepTimerKey].end == null) {
                test03StepTimers[stepTimerKey].end = now;
            }
            const stepTimer = test03StepTimers[stepTimerKey];
            const elapsedSeconds = ((stepTimer.end ?? now) - stepTimer.start) / 1000;
            const stepDurationText = `è€—æ—¶ï¼š${formatTest03Duration(elapsedSeconds)}`;

            // å·¥å…·å›¾æ ‡
            const toolIcon = payload.tool === 'calculator' ? 'ğŸ§®' : 
                             payload.tool === 'knowledge_search' ? 'ğŸ”' : 
                             payload.tool === 'user_input' ? 'âŒ¨ï¸' : 'ğŸ¤–';

            const aiResultText = payload.ai_result || (isRunning ? 'æ‰§è¡Œä¸­...' : 'æ— ');
            const stepLabel = payload.step_label || `Step ${stepIndex || stepsEl.children.length + 1}`;
            const indentStyle = payload.indent ? 'margin-left: 16px;' : '';
            const matchBadge = payload.matched_sop ? `
                <div style="font-size: 12px; color: #e2e8f0; background: #0f172a; padding: 4px 8px; border-radius: 4px; border: 1px solid #334155; font-family: monospace;">
                    SOP: ${escapeHtml(payload.matched_sop)}
                </div>` : '';
            const reasonRow = payload.reason ? `
                <div style="font-size: 12px; color: #94a3b8; margin-top: 8px;">
                    é€‰æ‹©åŸå› : ${escapeHtml(payload.reason)}
                </div>` : '';
            const isMetaStep = stepIndex === 'route' || stepIndex === 'sop_analyze';
            const showDetails = !isMetaStep;

            const stepHtml = `
                <div data-test03-step="${stepKey}" class="transition-all duration-300 ${statusClass}" style="border: 1px solid; border-radius: 8px; padding: 16px; margin-top: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); ${indentStyle}">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                        <div style="font-weight: 600; font-size: 15px;" class="${titleColor}">
                            ${statusIcon} ${escapeHtml(stepLabel)}: ${escapeHtml(payload.name || payload.id || 'Initializing...')}
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="font-size: 12px; color: #94a3b8; background: #0f172a; padding: 4px 8px; border-radius: 4px; border: 1px solid #334155; display: flex; align-items: center; gap: 4px;">
                                ${toolIcon} <span style="font-family: monospace; font-weight: 500;">${escapeHtml(payload.tool || 'auto')}</span>
                            </div>
                            <div data-test03-step-timer="${stepTimerKey}" style="font-size: 12px; color: #fcd34d; background: #0f172a; padding: 4px 8px; border-radius: 4px; border: 1px solid #334155; font-family: monospace;">
                                ${stepDurationText}
                            </div>
                            ${matchBadge}
                        </div>
                    </div>
                    <div style="background: #0f172a; border-radius: 6px; padding: 10px; border: 1px solid #334155;">
                        ${showDetails ? `
                        <div style="font-size: 12px; color: #cbd5e1; display: flex; gap: 6px; margin-bottom: 4px;">
                            ğŸ› ï¸ <span style="font-weight: 500;">å·¥å…·:</span> ${escapeHtml(payload.tool || 'æœªçŸ¥')} ${payload.description ? ` - ${escapeHtml(payload.description)}` : ''}
                        </div>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 12px;">
                            <div style="flex: 1; min-width: 200px; border: 1px solid #334155; border-radius: 6px; overflow: hidden;">
                                <div style="background: #1e293b; padding: 6px 10px; font-size: 11px; font-weight: 600; color: #94a3b8; border-bottom: 1px solid #334155; display: flex; align-items: center; gap: 4px;">
                                    ğŸ“¥ è¾“å…¥ (Inputs)
                                </div>
                                <pre style="margin: 0; padding: 10px; font-size: 11px; background: #020617; max-height: 150px; overflow-y: auto; color: #e2e8f0;">${escapeHtml(JSON.stringify(payload.inputs || {}, null, 2))}</pre>
                            </div>
                            <div style="flex: 1; min-width: 200px; border: 1px solid #334155; border-radius: 6px; overflow: hidden;">
                                <div style="background: #1e293b; padding: 6px 10px; font-size: 11px; font-weight: 600; color: #94a3b8; border-bottom: 1px solid #334155; display: flex; align-items: center; gap: 4px;">
                                    ğŸ“¤ è¾“å‡º (Outputs)
                                </div>
                                <pre style="margin: 0; padding: 10px; font-size: 11px; background: #020617; max-height: 150px; overflow-y: auto; color: #e2e8f0;">${escapeHtml(JSON.stringify(payload.outputs || {}, null, 2))}</pre>
                            </div>
                        </div>
                        ` : ''}
                        ${reasonRow}
                    </div>
                </div>
            `;
            if (existing) {
                existing.outerHTML = stepHtml;
            } else {
                stepsEl.insertAdjacentHTML('beforeend', stepHtml);
            }
        }

        function handleTest03Event(event) {
            const intro = "å¤„ç† Test03 æµå¼äº‹ä»¶å¹¶æ›´æ–°ç•Œé¢ã€‚";
            if (!event || !event.step) return;
            
            // è·¯ç”±é˜¶æ®µ
            if (event.step === 'route' || event.step === 'inference') {
                ensureTest03Case({
                    case_id: event.case_id,
                    case_label: event.case_label,
                    case_query: event.case_query
                });
                
                const isRunning = event.status === 'running';
                const routePayload = {
                    name: event.matched_sop || (isRunning ? "æ­£åœ¨åˆ†ææ„å›¾..." : "åŒ¹é…ä¸­"),
                    id: "sop_route",
                    tool: "route",
                    description: isRunning ? (event.msg || "æ­£åœ¨é€šè¿‡ LLM è·¯ç”± SOP...") : "åŒ¹é…å®Œæˆ",
                    matched_sop: event.matched_sop || '',
                    reason: event.route_reason || '',
                    step_label: "SOP åŒ¹é…"
                };
                appendTest03Step(event.case_id, "route", routePayload, isRunning);
            }

            if (event.step === 'sop_analyze') {
                const isRunning = event.status === 'running';
                const sopPayload = {
                    name: event.matched_sop || (isRunning ? "æ­£åœ¨æå–æ­¥éª¤..." : "è§£æä¸­"),
                    id: "sop_analyze",
                    tool: "llm",
                    description: event.msg || (isRunning ? "æ­£åœ¨åˆ©ç”¨ LLM ç»“æ„åŒ–è§£æ Markdown..." : "SOP è§£æå®Œæˆ"),
                    step_label: "SOP è§£æ"
                };
                appendTest03Step(event.case_id, "sop_analyze", sopPayload, isRunning);
            }

            // æ­¥éª¤åˆ†æé˜¶æ®µ (Running -> Placeholder, Done -> Content)
            if (event.step === 'step_analyze') {
                const isRunning = event.status === 'running';
                const payload = event.payload || { 
                    name: event.step_name, 
                    id: `step_${event.step_index}`,
                    tool: 'loading...',
                    description: event.msg 
                };
                payload.indent = true;
                appendTest03Step(event.case_id, event.step_index, payload, isRunning);
            }

            // æ•´ä½“çŠ¶æ€
            if (event.status === 'running') {
                addConsoleLine(`[${event.step}] ${event.msg}`);
                updateTest03Flowchart(event.step);
            } else if (event.status === 'done') {
                addConsoleLine(`[${event.step}] âœ… ${event.msg}`);
                if (event.step === 'result' && event.data) {
                    const cases = Array.isArray(event.data.cases) ? event.data.cases : [];
                    const duration = typeof event.duration_s === 'number' ? `${event.duration_s.toFixed(2)}s` : 'æœªçŸ¥';
                    stopTest03Duration(typeof event.duration_s === 'number' ? event.duration_s : null);
                    if (cases.length === 1 && cases[0]?.query) {
                        updateTest03SummaryQuery(cases[0].query);
                    }
                    const casesContainer = document.getElementById('test03StreamCases');
                    if (!casesContainer || casesContainer.childElementCount === 0) {
                        const summary = `
                            <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-left: 4px solid #1abc9c; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                                <div style="font-weight: bold; color: #0f766e; margin-bottom: 6px; font-size: 14px;">SOP Step Analysis</div>
                                <div style="font-size: 12px; color: #64748b;">å·²è§£æ ${cases.length} ä¸ªæ¡ˆä¾‹ Â· è€—æ—¶ ${duration}</div>
                                <div style="font-size: 12px; color: #64748b; margin-top: 6px;">é¢˜å¹²: ${cases.length === 1 ? escapeHtml(cases[0].query || '') : 'å¤šä¸ªé¢˜ç›®'}</div>
                            </div>
                            ${renderTest03Result({ cases })}
                        `;
                        document.getElementById('testResultDisplay').innerHTML = summary;
                    }
                }
                updateTest03Flowchart(event.step, true);
            } else if (event.status === 'failed') {
                addConsoleLine(`[${event.step}] âŒ ${event.msg}`, true);
            } else if (event.status === 'warning') {
                addConsoleLine(`[${event.step}] âš ï¸ ${event.msg}`);
            }
        }

        function updateTest01Flowchart(currentStep, summary = {}) {
            const intro = "æ ¹æ® Test01 è¿›åº¦åˆ·æ–°æµç¨‹å›¾é«˜äº®çŠ¶æ€ã€‚";
            const doneColor = "#d4efdf,stroke:#27ae60,stroke-width:2px";
            const activeColor = "#3498db,stroke:#2980b9,stroke-width:2px,color:white,stroke-dasharray: 5 5";
            const warnColor = "#fcf3cf,stroke:#f1c40f,stroke-width:2px";
            const errorColor = "#f5b7b1,stroke:#c0392b,stroke-width:2px";
            const def = `graph TD
                Start((Start)) --> API["API Bridge (APIæ¡¥æ¥)<br/>backend/api_bridge.py:run_test/1"]
                API --> Script["Test Script (æµ‹è¯•è„šæœ¬)<br/>tests/test_01_tool_registration.py"]
                Script --> ToolsLoad["Load Tools (åŠ è½½å·¥å…·)<br/>src/tools/base.py:ToolRegistry.list_tools"]
                ToolsLoad --> ToolsCheck["Validate Core Tools (æ ¸å¿ƒå·¥å…·æ ¡éªŒ)"]
                ToolsCheck --> SOPLoad["Load SOPs (åŠ è½½SOP)<br/>src/core/sop_loader.py:load_all"]
                SOPLoad --> SOPCheck["Validate Core SOPs (æ ¸å¿ƒSOPæ ¡éªŒ)"]
                SOPCheck --> End(("Result (ç»“æœ)"))
            `;
            let styleStr = "";
            let focusNode = null;
            styleStr += `style Start fill:${doneColor}\n`;
            if (currentStep === 'running') {
                styleStr += `style API fill:${activeColor}\n`;
                styleStr += `style Script fill:${activeColor}\n`;
                styleStr += `style ToolsLoad fill:${activeColor}\n`;
                focusNode = "ToolsLoad";
            } else if (currentStep === 'result') {
                styleStr += `style API fill:${doneColor}\n`;
                styleStr += `style Script fill:${doneColor}\n`;
                styleStr += `style ToolsLoad fill:${doneColor}\n`;
                styleStr += `style ToolsCheck fill:${summary.toolsError ? errorColor : doneColor}\n`;
                styleStr += `style SOPLoad fill:${doneColor}\n`;
                styleStr += `style SOPCheck fill:${summary.sopsError ? errorColor : (summary.sopsWarn ? warnColor : doneColor)}\n`;
                styleStr += `style End fill:#d1f2eb,stroke:#16a085,stroke-width:4px\n`;
                focusNode = "End";
            }
            setFlowchartFocusNode(focusNode);
            updateFlowchart(def + "\n" + styleStr);
        }

        function updateTest03Flowchart(currentStep, isDone=false) {
            const intro = "æ ¹æ® Test03 æµå¼æ­¥éª¤åˆ·æ–°æµç¨‹å›¾é«˜äº®çŠ¶æ€ã€‚";
            const doneColor = "#d4efdf,stroke:#27ae60,stroke-width:2px";
            const activeColor = "#3498db,stroke:#2980b9,stroke-width:2px,color:white,stroke-dasharray: 5 5";

            let def = `graph TD
                Start((Start)) --> API["API Endpoint (APIç«¯ç‚¹)<br/>backend/api_bridge.py:stream_test_03"]
                API --> SOP["Load SOPs (åŠ è½½SOP)<br/>src/core/sop_loader.py:load_all"]
                SOP --> ClassInit["Init Classifier (åˆå§‹åŒ–åˆ†ç±»å™¨)<br/>src/agents/classifier.py:__init__"]
                ClassInit --> Route["Route Intent (æ„å›¾è·¯ç”±)<br/>src/agents/classifier.py:route"]
                Route --> SOPParse["Analyze SOP (è§£æSOP)<br/>src/core/sop_loader.py:analyze_sop"]
                SOPParse --> StepParse["Analyze Steps (è§£ææ­¥éª¤)<br/>tests/test_03_sop_analysis.py:analyze_step"]
                StepParse --> End(("Result (ç»“æœ)"))
            `;

            let styleStr = "";
            let focusNode = null;
            styleStr += `style Start fill:${doneColor}\n`;
            styleStr += `style API fill:${doneColor}\n`;

            if (currentStep === 'sop_load') {
                styleStr += `style SOP fill:${isDone ? doneColor : activeColor}\n`;
                focusNode = "SOP";
            } else {
                styleStr += `style SOP fill:${doneColor}\n`;
            }

            if (currentStep === 'classifier_init') {
                styleStr += `style ClassInit fill:${isDone ? doneColor : activeColor}\n`;
                focusNode = "ClassInit";
            } else if (['route', 'sop_analyze', 'step_analyze', 'result'].includes(currentStep)) {
                styleStr += `style ClassInit fill:${doneColor}\n`;
            }

            if (currentStep === 'route') {
                styleStr += `style Route fill:${isDone ? doneColor : activeColor}\n`;
                focusNode = "Route";
            } else if (['sop_analyze', 'step_analyze', 'result'].includes(currentStep)) {
                styleStr += `style Route fill:${doneColor}\n`;
            }

            if (currentStep === 'sop_analyze') {
                styleStr += `style SOPParse fill:${isDone ? doneColor : activeColor}\n`;
                focusNode = "SOPParse";
            } else if (['step_analyze', 'result'].includes(currentStep)) {
                styleStr += `style SOPParse fill:${doneColor}\n`;
            }

            if (currentStep === 'step_analyze') {
                styleStr += `style StepParse fill:${isDone ? doneColor : activeColor}\n`;
                focusNode = "StepParse";
            } else if (currentStep === 'result') {
                styleStr += `style StepParse fill:${doneColor}\n`;
            }

            if (currentStep === 'result') {
                styleStr += `style End fill:#d1f2eb,stroke:#16a085,stroke-width:4px\n`;
                focusNode = "End";
            }

            setFlowchartFocusNode(focusNode);
            updateFlowchart(def + "\n" + styleStr);
        }

        function updateTest04Flowchart(currentStep, isDone=false, toolName=null) {
            const intro = "æ ¹æ® Test04 æµå¼æ­¥éª¤åˆ·æ–°æµç¨‹å›¾é«˜äº®çŠ¶æ€ã€‚";
            const doneColor = "#d4efdf,stroke:#27ae60,stroke-width:2px";
            const activeColor = "#3498db,stroke:#2980b9,stroke-width:2px,color:white,stroke-dasharray: 5 5";
            
            // Dynamic Labels based on toolName
            let generalLabel = "Common Tools (é€šç”¨å·¥å…·)<br/>src/tools/common_tools.py";
            if (toolName === 'table_lookup') {
                generalLabel = "Table Lookup (è¡¨æ ¼æŸ¥è¯¢)<br/>src/tools/table_tools.py:TableLookupTool.run";
            } else if (toolName === 'knowledge_search') {
                generalLabel = "Knowledge Search (çŸ¥è¯†æ£€ç´¢)<br/>src/tools/knowledge_tools.py:KnowledgeSearchTool.run";
            } else if (toolName) {
                generalLabel = `${toolName}<br/>src/tools/common_tools.py`;
            }

            let def = `graph TD
                Start((Start)) --> API["API Endpoint (APIç«¯ç‚¹)<br/>backend/api_bridge.py:stream_test_04"]
                API --> CaseLoad["Load Cases (åŠ è½½ç”¨ä¾‹)<br/>tests/test_04_tool_validity.py:_select_cases"]
                CaseLoad --> Router{Select Tool}
                Router -->|general| GeneralTools["${generalLabel}"]
                Router -->|gis| GISTools["GIS Tools (GISå·¥å…·)<br/>src/tools/gis_tools.py"]
                GeneralTools --> Result(("Result (ç»“æœ)"))
                GISTools --> Result
            `;

            let styleStr = "";
            let focusNode = null;
            styleStr += `style Start fill:${doneColor}\n`;
            styleStr += `style API fill:${doneColor}\n`;

            if (currentStep === 'case_load') {
                styleStr += `style CaseLoad fill:${isDone ? doneColor : activeColor}\n`;
                focusNode = "CaseLoad";
            } else if (['case_run', 'result'].includes(currentStep)) {
                styleStr += `style CaseLoad fill:${doneColor}\n`;
            }

            if (currentStep === 'case_run') {
                const isGis = toolName === 'gis_section_volume_calc';
                if (isGis) {
                    styleStr += `style GISTools fill:${isDone ? doneColor : activeColor}\n`;
                    focusNode = "GISTools";
                } else {
                    styleStr += `style GeneralTools fill:${isDone ? doneColor : activeColor}\n`;
                    focusNode = "GeneralTools";
                }
            } else if (currentStep === 'result') {
                 styleStr += `style GeneralTools fill:${doneColor}\n`;
                 styleStr += `style GISTools fill:${doneColor}\n`;
            }

            if (currentStep === 'result') {
                styleStr += `style Result fill:#d1f2eb,stroke:#16a085,stroke-width:4px\n`;
                focusNode = "Result";
            }

            setFlowchartFocusNode(focusNode);
            updateFlowchart(def + "\n" + styleStr);
        }

        function updateTest02Flowchart(currentStep, isDone=false) {
             const intro = "æ ¹æ®æµå¼æ­¥éª¤åˆ·æ–°æµç¨‹å›¾é«˜äº®çŠ¶æ€ã€‚";
             const doneColor = "#d4efdf,stroke:#27ae60,stroke-width:2px";
             const activeColor = "#3498db,stroke:#2980b9,stroke-width:2px,color:white,stroke-dasharray: 5 5";
             
             // Detailed graph definition matching the initialization
             let def = `graph TD
                Start((Start)) --> API["API Endpoint (APIç«¯ç‚¹)<br/>backend/api_bridge.py:stream_test_02"]
                API --> SOP["Load SOPs (åŠ è½½SOP)<br/>src/core/sop_loader.py:load_all"]
                SOP --> ClassInit["Init Classifier (åˆå§‹åŒ–åˆ†ç±»å™¨)<br/>src/agents/classifier.py:__init__"]
                ClassInit --> Route["Route Intent (æ„å›¾è·¯ç”±)<br/>src/agents/classifier.py:route"]
                Route --> Prompt["Build Prompt (æ„å»ºæç¤ºè¯)<br/>src/agents/classifier.py:_build_prompt"]
                Prompt --> LLM["LLM Chat (LLMå¯¹è¯)<br/>src/core/llm.py:chat"]
                LLM --> Parse["Parse Response (è§£æå“åº”)<br/>src/agents/classifier.py"]
               Parse --> End(("Result (ç»“æœ)"))
             `;
             
             let styleStr = "";
             let focusNode = null;
             
             // State machine coloring
             styleStr += `style Start fill:${doneColor}\n`;
             styleStr += `style API fill:${doneColor}\n`; // API is always done when we receive events

             // LoadSOP (sop_load, sop_validate)
             if (currentStep === 'sop_load' || currentStep === 'sop_validate') {
                 styleStr += `style SOP fill:${isDone ? doneColor : activeColor}\n`;
                 focusNode = "SOP";
             } else if (['llm_load', 'inference', 'result'].includes(currentStep)) {
                 styleStr += `style SOP fill:${doneColor}\n`;
             }
             
             // InitLLM (llm_load)
             if (currentStep === 'llm_load') {
                 styleStr += `style ClassInit fill:${isDone ? doneColor : activeColor}\n`;
                 focusNode = "ClassInit";
             } else if (['inference', 'result'].includes(currentStep)) {
                  styleStr += `style ClassInit fill:${doneColor}\n`;
             }
             
             // Infer (inference covers Route -> Prompt -> LLM)
             if (currentStep === 'inference') {
                 // Highlight the active part of inference chain
                 styleStr += `style Route fill:${activeColor}\n`;
                 styleStr += `style Prompt fill:${activeColor}\n`;
                 styleStr += `style LLM fill:${activeColor}\n`;
                 focusNode = "LLM";
             } else if (['result'].includes(currentStep)) {
                 styleStr += `style Route fill:${doneColor}\n`;
                 styleStr += `style Prompt fill:${doneColor}\n`;
                 styleStr += `style LLM fill:${doneColor}\n`;
             }
             
             // Result (result covers Parse -> End)
             if (currentStep === 'result') {
                 styleStr += `style Parse fill:${doneColor}\n`;
                 styleStr += `style End fill:#d1f2eb,stroke:#16a085,stroke-width:4px\n`;
                 focusNode = "End";
             }
             setFlowchartFocusNode(focusNode);
             updateFlowchart(def + "\n" + styleStr);
        }
        
        function renderTest02Result(data) {
             const intro = "æ¸²æŸ“ Test02 æµå¼ç»“æœå†…å®¹ã€‚";
             const reasonValue = data.reason ?? data.reasonText ?? data.reason_zh ?? data.reason_en;
             const reasonText = reasonValue != null && reasonValue.toString().trim() !== "" ? escapeHtml(reasonValue) : 'æ— ';
             const rawInferenceTime = data.inference_time_s ?? data.inference_time ?? data.latency_s;
             const inferenceSeconds = rawInferenceTime !== undefined && rawInferenceTime !== null && rawInferenceTime !== "" ? Number(rawInferenceTime) : null;
             const inferenceText = inferenceSeconds !== null && !Number.isNaN(inferenceSeconds) ? `${inferenceSeconds.toFixed(2)}s` : 'æœªçŸ¥';
             const html = `
                <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #eee;">
                    <div style="font-size: 11px; color: #95a5a6; margin-bottom: 4px;">æµ‹è¯•æŒ‡ä»¤ (User Query):</div>
                    <div style="font-family: sans-serif; font-size: 14px; color: #34495e; font-weight: 500;">${escapeHtml(data.raw_query || '')}</div>
                </div>
                <div style="background: #f8f9fa; border-left: 4px solid #8e44ad; padding: 15px; border-radius: 4px;">
                     <div style="font-weight: bold; color: #8e44ad; margin-bottom: 10px; font-size: 14px;">ğŸ¯ æ„å›¾è·¯ç”±ç»“æœ</div>
                     <div style="margin-bottom: 8px;">
                        <strong>SOP ID:</strong> 
                        <code style="background: #f4ecf7; color: #6c3483; padding: 2px 6px; border-radius: 3px;">${data.sop_id}</code>
                     </div>
                     <div style="margin-bottom: 8px;">
                        <strong>SOP Name:</strong> ${data.sop_name}
                     </div>
                     <div style="margin-bottom: 8px;">
                        <strong>Reason (æ¨ç†):</strong> 
                        <div style="background: #fff; border: 1px solid #ddd; padding: 8px; margin-top: 5px; font-size: 12px; border-radius: 4px; color: #555;">${reasonText}</div>
                     </div>
                     <div style="margin-bottom: 8px;">
                        <strong>æ¨ç†æ—¶é—´:</strong> ${inferenceText}
                     </div>
                     <div>
                        <strong>æå–å‚æ•°:</strong> 
                        <pre style="background: #fff; border: 1px solid #ddd; padding: 8px; margin-top: 5px; font-size: 12px; border-radius: 4px;">${JSON.stringify(data.args, null, 2)}</pre>
                     </div>
                 </div>
             `;
             document.getElementById('testResultDisplay').innerHTML = html;
        }

        function renderTest03Result(payload) {
            const intro = "æ¸²æŸ“ Test03 æ­¥éª¤åˆ†æç»“æœã€‚";
            const cases = payload && Array.isArray(payload.cases) ? payload.cases : [];
            if (cases.length === 0) {
                return `
                    <div style="background: #fff; border-left: 4px solid #95a5a6; padding: 15px; border-radius: 4px;">
                        <div style="font-weight: bold; color: #7f8c8d; margin-bottom: 5px;">æ— å¯ç”¨åˆ†æç»“æœ</div>
                        <div style="font-size: 12px; color: #95a5a6;">è¯·åœ¨æ§åˆ¶å°æŸ¥çœ‹è¾“å‡ºæ—¥å¿—ã€‚</div>
                    </div>
                `;
            }
            return cases.map(item => {
                const steps = Array.isArray(item.steps) ? item.steps : [];
                const stepsHtml = steps.map((step, index) => `
                    <div style="border: 1px solid #eee; border-radius: 6px; padding: 10px; margin-top: 10px; background: #fafafa;">
                        <div style="font-weight: bold; color: #2c3e50; margin-bottom: 6px;">Step ${index + 1}: ${escapeHtml(step.name || step.id || '')}</div>
                        <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 6px;">å·¥å…·: <code style="background: #f4f6f7; padding: 2px 4px; border-radius: 3px;">${escapeHtml(step.tool || 'auto')}</code></div>
                        <div style="font-size: 12px; color: #555; margin-bottom: 6px;">è¯´æ˜: ${escapeHtml(step.description || 'æ— ')}</div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 180px;">
                                <div style="font-size: 11px; color: #95a5a6; margin-bottom: 4px;">è¾“å…¥</div>
                                <pre style="background: #fff; border: 1px solid #eee; padding: 6px; font-size: 11px; border-radius: 4px; max-height: 120px; overflow-y: auto;">${escapeHtml(JSON.stringify(step.inputs || {}, null, 2))}</pre>
                            </div>
                            <div style="flex: 1; min-width: 180px;">
                                <div style="font-size: 11px; color: #95a5a6; margin-bottom: 4px;">è¾“å‡º</div>
                                <pre style="background: #fff; border: 1px solid #eee; padding: 6px; font-size: 11px; border-radius: 4px; max-height: 120px; overflow-y: auto;">${escapeHtml(JSON.stringify(step.outputs || {}, null, 2))}</pre>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: #555; margin-top: 6px;">æ³¨æ„äº‹é¡¹: ${escapeHtml(step.notes || 'æ— ')}</div>
                        <div style="font-size: 12px; color: #555; margin-top: 6px;">åˆ†æ: ${escapeHtml(step.analysis || 'æ— ')}</div>
                        <div style="font-size: 12px; color: #2c3e50; margin-top: 6px;">AI æ‰§è¡Œ: ${escapeHtml(step.ai_result || 'æ— ')}</div>
                        <div style="font-size: 11px; color: #7f8c8d; margin-top: 4px;">æ‰§è¡Œå¤‡æ³¨: ${escapeHtml(step.ai_note || 'æ— ')}</div>
                    </div>
                `).join('');
                return `
                    <div style="background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="font-weight: bold; color: #34495e; margin-bottom: 6px;">${escapeHtml(item.label || item.id || 'æœªå‘½åç”¨ä¾‹')}</div>
                        <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 8px;">Query: ${escapeHtml(item.query || '')}</div>
                        <div style="font-size: 12px; color: #2c3e50; margin-bottom: 6px;">åŒ¹é… SOP: <code style="background: #f4f6f7; padding: 2px 4px; border-radius: 3px;">${escapeHtml(item.matched_sop || 'None')}</code></div>
                        <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 6px;">è·¯ç”±åŸå› : ${escapeHtml(item.route_reason || 'æ— ')}</div>
                        ${stepsHtml}
                    </div>
                `;
            }).join('');
        }

        function renderTest04Result(payload) {
            const intro = "æ¸²æŸ“ Test04 å·¥å…·èƒ½åŠ›ç»“æœã€‚";
            const cases = payload && Array.isArray(payload.cases) ? payload.cases : [];
            if (cases.length === 0) {
                return `
                    <div style="background: #1e293b; border-left: 4px solid #64748b; padding: 15px; border-radius: 6px;">
                        <div style="font-weight: bold; color: #cbd5e1; margin-bottom: 6px;">æš‚æ— å¯è§†åŒ–ç»“æœ</div>
                        <div style="font-size: 12px; color: #94a3b8;">è¯·æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºã€‚</div>
                    </div>
                `;
            }
            return cases.map(item => {
                const status = item.status || 'ok';
                const statusIcon = status === 'ok' ? 'âœ…' : status === 'skipped' ? 'âšª' : 'âŒ';
                const borderColor = status === 'ok' ? '#22c55e' : status === 'skipped' ? '#94a3b8' : '#ef4444';
                const outputText = item.output !== undefined ? JSON.stringify(item.output, null, 2) : 'æ— ';
                const inputText = item.inputs !== undefined ? JSON.stringify(item.inputs, null, 2) : '{}';
                const expectedText = item.expected !== undefined ? JSON.stringify(item.expected, null, 2) : 'æ— ';
                
                let sourceHtml = "";
                if (item.output && item.output._source_html) {
                    const headerText = item.output._table_headers
                        ? (Array.isArray(item.output._table_headers) ? item.output._table_headers.join(' | ') : String(item.output._table_headers))
                        : "";
                    const headerTitle = headerText ? ` | è¡¨å¤´: ${escapeHtml(headerText)}` : "";
                    const headerBlock = headerText
                        ? `<div style="padding: 8px 10px; font-size: 11px; color: #0f172a; border-bottom: 1px solid #e2e8f0; background: #f8fafc;">è¡¨å¤´: ${escapeHtml(headerText)}</div>`
                        : "";
                    sourceHtml = `
                        <div style="background: #020617; border: 1px solid #1e293b; border-radius: 6px; overflow: hidden; grid-column: 1 / -1; margin-top: 10px;">
                            <div style="background: #1e293b; padding: 6px 10px; font-size: 11px; color: #94a3b8;">æºè¡¨æ ¼ç‰‡æ®µ (Source HTML)${headerTitle}</div>
                            <div style="overflow-x: auto; background: #fff; color: #333; font-size: 12px;">
                                ${headerBlock}
                                <div style="padding: 10px;">
                                    ${item.output._source_html}
                                </div>
                            </div>
                        </div>
                    `;
                }

                let traceHtml = "";
                if (item.output && item.output._trace) {
                    const traceText = Array.isArray(item.output._trace) ? item.output._trace.join('\n') : String(item.output._trace);
                    traceHtml = `
                        <div style="background: #020617; border: 1px solid #1e293b; border-radius: 6px; overflow: hidden; grid-column: 1 / -1; margin-top: 10px;">
                            <div style="background: #1e293b; padding: 6px 10px; font-size: 11px; color: #94a3b8;">æ‰§è¡Œè¿‡ç¨‹ (Trace)</div>
                            <pre style="margin: 0; padding: 8px; font-size: 11px; color: #e2e8f0; max-height: 200px; overflow-y: auto;">${escapeHtml(traceText)}</pre>
                        </div>
                    `;
                }

                let headerHtml = "";

                return `
                    <div style="background: #0f172a; border: 1px solid #334155; border-left: 4px solid ${borderColor}; padding: 14px; border-radius: 8px; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <div style="font-weight: 600; color: #e2e8f0; font-size: 14px;">${statusIcon} ${escapeHtml(item.label || item.id || 'æœªå‘½åå·¥å…·')}</div>
                            <div style="font-size: 11px; color: #94a3b8;">Tool: ${escapeHtml(item.tool || '')}</div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px;">
                            <div style="background: #020617; border: 1px solid #1e293b; border-radius: 6px; overflow: hidden;">
                                <div style="background: #1e293b; padding: 6px 10px; font-size: 11px; color: #94a3b8;">è¾“å…¥</div>
                                <pre style="margin: 0; padding: 8px; font-size: 11px; color: #e2e8f0; max-height: 140px; overflow-y: auto;">${escapeHtml(inputText)}</pre>
                            </div>
                            <div style="background: #020617; border: 1px solid #1e293b; border-radius: 6px; overflow: hidden;">
                                <div style="background: #1e293b; padding: 6px 10px; font-size: 11px; color: #94a3b8;">æœŸæœ›</div>
                                <pre style="margin: 0; padding: 8px; font-size: 11px; color: #e2e8f0; max-height: 140px; overflow-y: auto;">${escapeHtml(expectedText)}</pre>
                            </div>
                            <div style="background: #020617; border: 1px solid #1e293b; border-radius: 6px; overflow: hidden;">
                                <div style="background: #1e293b; padding: 6px 10px; font-size: 11px; color: #94a3b8;">è¾“å‡º</div>
                                <pre style="margin: 0; padding: 8px; font-size: 11px; color: #e2e8f0; max-height: 140px; overflow-y: auto;">${escapeHtml(outputText)}</pre>
                            </div>
                            ${sourceHtml}
                            ${traceHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        fetchModels();

        async function switchTest(testId, btn) {
            const intro = "æ ¹æ®æµ‹è¯•ç±»å‹åˆ‡æ¢ç•Œé¢å¸ƒå±€ã€‚";
            currentTestId = testId;
            document.querySelectorAll('.test-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            document.getElementById('testTitle').innerText = btn.querySelector('strong').innerText;
            
            // Show/Hide interfaces
            const samplesContainer = document.getElementById('samplesContainer');
            const chatSampleDiv = document.getElementById('sampleQueriesArea');
            const modeDiv = document.getElementById('unitTestModeSelection');
            const unitTestModelSelection = document.getElementById('unitTestModelSelection');
            const modelGrid = document.getElementById('modelGrid');

            // Hide all first
            samplesContainer.style.display = 'none';
            chatSampleDiv.style.display = 'none';
            modeDiv.style.display = 'none';
            unitTestModelSelection.style.display = 'none';
            modelGrid.style.display = 'none'; // Default hidden for unit tests

            if (testId === '0') {
                document.getElementById('chatInterface').style.display = 'flex';
                document.getElementById('unitTestInterface').style.display = 'none';
                document.getElementById('queryInput').placeholder = "è¾“å…¥æ‚¨æƒ³å¯¹ LLM è¯´çš„è¯...";
                
                samplesContainer.style.display = 'block';
                chatSampleDiv.style.display = 'block';
                modelGrid.style.display = 'grid'; // Show for chat
                await loadTestCases(testId);
            } else {
                document.getElementById('chatInterface').style.display = 'none';
                document.getElementById('unitTestInterface').style.display = 'flex';
                document.getElementById('queryInput').placeholder = "è¾“å…¥æµ‹è¯•å‚æ•°æˆ–ç›´æ¥ç‚¹å‡»è¿è¡Œ...";
                
                // Show samples container ONLY if there are samples for this test
                if (testId === '1' || testId === '2' || testId === '3' || testId === '4') {
                    samplesContainer.style.display = 'block';
                    chatSampleDiv.style.display = 'block'; // Reuse the same container
                    await loadTestCases(testId);
                    
                    if (testId === '1') {
                         // Test 01: No LLM involved, hide mode selection
                         modeDiv.style.display = 'none';
                    } else if (testId === '2' || testId === '3' || testId === '4') {
                        // Test 02/03/04: Needs LLM selection and Mode
                        modeDiv.style.display = 'flex';
                        unitTestModelSelection.style.display = 'flex';
                        // Only show full grid for 2 and 3, keep 4 compact
                        if (testId !== '4') {
                            modelGrid.style.display = 'grid';
                        }
                    }
                }
            }
            
            // Clear results
            document.getElementById('consoleArea').innerHTML = '';
            document.getElementById('testResultDisplay').innerHTML = `
                <div style="color: #95a5a6; font-style: italic; text-align: center; margin-top: 50px;">
                    æµ‹è¯•è¿è¡Œç»“æœå°†åœ¨æ­¤æ˜¾ç¤º
                </div>
            `;
            updateFlowchart(`graph TD\nStart((å¼€å§‹)) --> Idle[${mq('ç­‰å¾…æŒ‡ä»¤')}]`);
        }

        async function loadTestCases(testId) {
            const container = document.querySelector('#sampleQueriesArea .sample-queries');
            if (!container) return;
            container.innerHTML = '<span style="font-size:11px;color:#999;">åŠ è½½ä¸­...</span>';
            
            try {
                const response = await fetch(`${API_URL}/test_cases/${testId}`);
                const data = await response.json();
                
                container.innerHTML = ''; // Clear loading
                const titleEl = document.getElementById('sampleQueriesTitle');
                if (titleEl) {
                    const count = Array.isArray(data.cases) ? data.cases.length : 0;
                    titleEl.innerText = count > 0 ? `æ“ä½œ (${count}ä¸ª)` : 'æ“ä½œ:';
                }
                
                if (data.cases && data.cases.length > 0) {
                    data.cases.forEach(item => {
                        const btn = document.createElement('button');
                        btn.className = 'sample-btn';
                        btn.innerText = item.label;
                        btn.onclick = () => {
                            document.getElementById('queryInput').value = item.query;
                            if (currentTestId === '0') {
                                runChatTest();
                            } else {
                                runUnitTest(currentTestId);
                            }
                        };
                        container.appendChild(btn);
                    });
                } else {
                    container.innerHTML = '<span style="font-size:11px;color:#999;">æ— å¯ç”¨æ ·æœ¬</span>';
                }
            } catch (e) {
                console.error("Failed to load test cases", e);
                const titleEl = document.getElementById('sampleQueriesTitle');
                if (titleEl) titleEl.innerText = 'æ“ä½œ:';
                container.innerHTML = '<span style="font-size:11px;color:#999;">åŠ è½½å¤±è´¥</span>';
            }
        }

        function setQuery(text) {
            document.getElementById('queryInput').value = text;
        }

    let flowchartRenderPending = null;
    let flowchartRenderRunning = false;
    let flowchartFocusNode = null;
    function updateFlowchart(mermaidCode) {
        const intro = "æ’é˜Ÿæ¸²æŸ“ Mermaid æµç¨‹å›¾å¹¶é¿å…é—ªç™½ã€‚";
        const container = document.getElementById('flowchartArea');
        flowchartRenderPending = mermaidCode;
        if (flowchartRenderRunning) return;
        flowchartRenderRunning = true;
        const renderNext = async () => {
            while (flowchartRenderPending) {
                const code = flowchartRenderPending;
                flowchartRenderPending = null;
                try {
                    const { svg } = await mermaid.render('mermaid-svg', code);
                    container.innerHTML = svg;
                    if (flowchartFocusNode) {
                        requestAnimationFrame(() => centerFlowchartNode(flowchartFocusNode));
                    }
                } catch (e) {
                    console.error("Mermaid render failed", e);
                }
            }
            flowchartRenderRunning = false;
        };
        renderNext();
    }

    function setFlowchartFocusNode(nodeName) {
        const intro = "è®¾ç½®å½“å‰éœ€è¦å±…ä¸­çš„æµç¨‹å›¾èŠ‚ç‚¹ã€‚";
        flowchartFocusNode = nodeName;
    }

    function centerFlowchartNode(nodeName) {
        const intro = "å°†æµç¨‹å›¾ä¸­æŒ‡å®šèŠ‚ç‚¹æ»šåŠ¨åˆ°å®¹å™¨ä¸­é—´ã€‚";
        if (!nodeName) return;
        const container = document.getElementById('flowchartArea');
        if (!container) return;
        const safeName = window.CSS && CSS.escape ? CSS.escape(nodeName) : nodeName;
        const target = container.querySelector(`[id^="flowchart-${safeName}-"]`);
        if (!target) return;
        const containerRect = container.getBoundingClientRect();
        const targetRect = target.getBoundingClientRect();
        const delta = targetRect.top - containerRect.top - containerRect.height / 2 + targetRect.height / 2;
        container.scrollTop += delta;
    }

    function addConsoleLine(text, isError = false) {
        lastConsoleActivity = Date.now();
        const consoleArea = document.getElementById('consoleArea');
        const div = document.createElement('div');
        div.className = 'trace-step';
        const time = new Date().toLocaleTimeString();
        const safeText = escapeHtml(text);
        
        let color = '#ecf0f1';
        if (isError === true) color = '#f44747';
        else if (isError === 'heartbeat') color = '#6c757d'; // Grey for heartbeat

        div.innerHTML = `
            <span class="trace-step-time">[${time}]</span>
            <div class="trace-step-content" style="color: ${color}">${safeText}</div>
        `;
        consoleArea.appendChild(div);
        consoleArea.scrollTop = consoleArea.scrollHeight;
    }

        function runCurrentAction() {
            if (currentTestId === '0') {
                runChatTest();
            } else if (currentTestId) {
                runUnitTest(currentTestId);
            } else {
                alert("è¯·å…ˆä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæµ‹è¯•é¡¹ã€‚");
            }
        }

        function updateTimer() {
            const elapsed = Date.now() - startTime;
            document.getElementById('timer').innerText = elapsed + 'ms';
        }

        function startTimer() {
            startTime = Date.now();
            document.getElementById('traceStats').style.display = 'block';
            timerInterval = setInterval(updateTimer, 50);
            
            // Heartbeat setup
            if (consoleHeartbeatInterval) clearInterval(consoleHeartbeatInterval);
            lastConsoleActivity = Date.now();
            consoleHeartbeatInterval = setInterval(() => {
                if (Date.now() - lastConsoleActivity >= 5000) {
                    addConsoleLine("... (heartbeat) ...", 'heartbeat');
                }
            }, 1000);
        }

        function stopTimer(status = 'å®Œæˆ') {
            clearInterval(timerInterval);
            if (consoleHeartbeatInterval) {
                clearInterval(consoleHeartbeatInterval);
                consoleHeartbeatInterval = null;
            }
            const elapsed = Date.now() - startTime;
            const selectedModel = document.querySelector('input[name="selectedModel"]:checked')?.value;
            if (selectedModel) {
                const latencyEl = document.getElementById(`latency-${selectedModel}`);
                if (latencyEl) latencyEl.innerText = elapsed + 'ms';
            }
        }

        function addChatMessage(role, content) {
            const display = document.getElementById('chatDisplay');
            const div = document.createElement('div');
            div.className = `chat-bubble ${role}`;
            div.innerText = content;
            display.appendChild(div);
            display.scrollTop = display.scrollHeight;
        }

        async function runChatTest(runDefault = false) {
            let query = document.getElementById('queryInput').value;
            const model = document.querySelector('input[name="selectedModel"]:checked')?.value;
            const mode = document.querySelector('input[name="runMode"]:checked')?.value;
            
            if (runDefault) {
                query = ""; // Empty query triggers default suite in backend
            } else if (!query) {
                return;
            }
            
            if (!model) { alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¨¡å‹"); return; }

        if (query) {
            addChatMessage('user', query);
        } else {
            addChatMessage('user', "è¿è¡Œé»˜è®¤æµ‹è¯•å¥—ä»¶ (5ä¸ªæ ·æœ¬)");
        }
        
        document.getElementById('queryInput').value = '';
        document.getElementById('consoleArea').innerHTML = '';
        
        startTimer();
        
        addConsoleLine(`å¯åŠ¨ LLM å¯¹è¯æµ‹è¯•: æ¨¡å‹=${model}, æ¨¡å¼=${mode || 'é»˜è®¤'}, è¾“å…¥=${query || 'é»˜è®¤å¥—ä»¶'}`);
        // Initial flowchart
        updateFlowchart(`graph TD
            Start((Start)) --> API["API Bridge (APIæ¡¥æ¥)<br/>backend/api_bridge.py:run_test/0"]
            API --> Script["Test Script (æµ‹è¯•è„šæœ¬)<br/>tests/test_00_llm_chat.py"]
            Script --> LLM["LLM Core (æ ¸å¿ƒLLM)<br/>src/core/llm.py:chat"]
            LLM --> HTTP["Request (è¯·æ±‚)<br/>requests.post"]
            HTTP --> Waiting["Waiting for Response... (ç­‰å¾…å“åº”)"]
        `);

        try {
            let url = `${API_URL}/run_test/0?config=${encodeURIComponent(model)}&query=${encodeURIComponent(query)}`;
            if (mode) url += `&mode=${encodeURIComponent(mode)}`;
            
            const response = await fetch(url);
            const data = await response.json();
            
            const stdout = data.stdout || "";
            const responseMatch = stdout.match(/å“åº”å†…å®¹é¢„è§ˆ: (.*)\.\.\./);
            const botResponse = responseMatch ? responseMatch[1] : "æµ‹è¯•å®Œæˆï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚";
            
            // Extract function calls from stdout for chat test
            let chatFunctions = [];
            stdout.split('\n').forEach(line => {
                if (line.includes('[CALL]')) {
                    const func = line.split('[CALL]')[1]?.trim().replace('()', '');
                    if (func) chatFunctions.push(func);
                }
            });

            addChatMessage('bot', botResponse);
            addConsoleLine("æ”¶åˆ°åç«¯å“åº”:\n" + stdout);
            
            const successLabel = chatFunctions.length > 0 
                ? `å“åº”æˆåŠŸ\n(${chatFunctions.join(', ')})`
                : "å“åº”æˆåŠŸ";

            // Sanitize label for Mermaid: escape quotes and handle newlines
            const safeLabel = successLabel.replace(/"/g, "'").replace(/\n/g, '<br/>');
            const resultNode = data.exit_code === 0 
                ? `Success["Success (æˆåŠŸ)<br/>${safeLabel}"]` 
                : `Failed["Failed (å¤±è´¥)<br/>Exit Code: ${data.exit_code}"]`;
            
            const resultStyle = data.exit_code === 0 ? "style Success fill:#d4efdf,stroke:#27ae60" : "style Failed fill:#fadbd8,stroke:#c0392b";
            
            updateFlowchart(`graph TD
                Start((Start)) --> API["API Bridge (APIæ¡¥æ¥)<br/>backend/api_bridge.py:run_test/0"]
                API --> Script["Test Script (æµ‹è¯•è„šæœ¬)<br/>tests/test_00_llm_chat.py"]
                Script --> LLM["LLM Core (æ ¸å¿ƒLLM)<br/>src/core/llm.py:chat"]
                LLM --> HTTP["Request (è¯·æ±‚)<br/>requests.post"]
                HTTP --> ${resultNode}
                ${resultStyle}
            `);

            if (data.stderr) {
                addConsoleLine("é”™è¯¯è¾“å‡º: " + data.stderr, true);
            }
            
            stopTimer(data.exit_code === 0 ? 'æµ‹è¯•é€šè¿‡' : 'æµ‹è¯•å¤±è´¥');
        } catch (error) {
            addChatMessage('bot', "å‘ç”Ÿé”™è¯¯: " + error.message);
            addConsoleLine("è¿è¡Œæ—¶å¼‚å¸¸: " + error.message, true);
            updateFlowchart(`graph TD\nStart((å¼€å§‹)) --> Error[${mq('ç³»ç»Ÿé”™è¯¯: ' + error.message)}]\nError --> End((ç»“æŸ))`);
            stopTimer('è¿è¡Œå‡ºé”™');
        }
        }

    async function runUnitTest(testId) {
            // Collect UI State
            // query and mode will be determined below based on test ID and visibility
            const model = document.querySelector('input[name="selectedModel"]:checked')?.value;

            document.getElementById('consoleArea').innerHTML = '';
            document.getElementById('testResultDisplay').innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100px; color: #3498db;">
                    <div class="loading-spinner"></div>
                    <div style="margin-top: 10px; font-size: 13px;">æ­£åœ¨æ‰§è¡Œæµ‹è¯•è„šæœ¬...</div>
                </div>
            `;
            
            startTimer();
            
            // Get mode if visible
            const modeDiv = document.getElementById('unitTestModeSelection');
            let mode = null;
            if (modeDiv.style.display !== 'none') {
                mode = document.querySelector('input[name="unitTestRunMode"]:checked')?.value;
            }

            // Get query from main input if it's test 01 or 02
            let query = null;
            if (testId === '1' || testId === '2' || testId === '3' || testId === '4') {
                query = document.getElementById('queryInput').value;
                document.getElementById('queryInput').value = ''; // Clear input as requested
                addConsoleLine(`æµ‹è¯•æŒ‡ä»¤: "${query}"`);
            }

            // --- SPECIAL HANDLING FOR TEST 02 STREAMING ---
        if (testId === '2' && query) {
            // Validate Model Selection for Test 02
            if (!model) { 
                alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¨¡å‹ (Test 02 éœ€è¦ LLM)"); 
                document.getElementById('testResultDisplay').innerHTML = '';
                return; 
            }

            // Use the new streaming endpoint
            addConsoleLine(`å¯åŠ¨æ„å›¾è¯†åˆ«æµç¨‹ (Streaming)...`);
            addConsoleLine(`Model: ${model}, Mode: ${mode}`);
            
            // Init Flowchart
            const graphDef = `graph TD
                Start((Start)) --> API["API Endpoint (APIç«¯ç‚¹)<br/>backend/api_bridge.py:stream_test_02"]
                API --> SOP["Load SOPs (åŠ è½½SOP)<br/>src/core/sop_loader.py:load_all"]
                SOP --> ClassInit["Init Classifier (åˆå§‹åŒ–åˆ†ç±»å™¨)<br/>src/agents/classifier.py:__init__"]
                ClassInit --> Route["Route Intent (æ„å›¾è·¯ç”±)<br/>src/agents/classifier.py:route"]
                Route --> Prompt["Build Prompt (æ„å»ºæç¤ºè¯)<br/>src/agents/classifier.py:_build_prompt"]
                Prompt --> LLM["LLM Chat (LLMå¯¹è¯)<br/>src/core/llm.py:chat"]
                LLM --> Parse["Parse Response (è§£æå“åº”)<br/>src/agents/classifier.py"]
                Parse --> End(("Result (ç»“æœ)"))
                
                style Start fill:#ecf0f1,stroke:#bdc3c7
                style API fill:#e8f8f5,stroke:#1abc9c
                style SOP fill:#fff,stroke:#3498db,stroke-dasharray: 5 5
                style ClassInit fill:#fff,stroke:#bdc3c7
                style Route fill:#fff,stroke:#bdc3c7
                style Prompt fill:#fff,stroke:#bdc3c7
                style LLM fill:#fef9e7,stroke:#f1c40f
                style Parse fill:#fff,stroke:#bdc3c7
                style End fill:#ecf0f1,stroke:#bdc3c7
            `;
            updateFlowchart(graphDef);

            try {
                const url = `${API_URL}/test/stream/02?query=${encodeURIComponent(query)}&config=${encodeURIComponent(model)}&mode=${encodeURIComponent(mode)}`;
                const response = await fetch(url);
                const reader = response.body.getReader();
            const decoder = new TextDecoder();
                    let buffer = '';
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop(); // Keep incomplete line
                        
                        for (const line of lines) {
                            if (!line.trim()) continue;
                            try {
                                const event = JSON.parse(line);
                                handleTest02Event(event);
                            } catch (e) {
                                console.error("JSON Parse Error", e);
                            }
                        }
                    }
                    stopTimer('å®Œæˆ');
                } catch (e) {
                    addConsoleLine(`Error: ${e.message}`, true);
                    stopTimer('å‡ºé”™');
                }
                return; // Exit function, don't run legacy logic
            }

        if (testId === '3') {
            if (!model) {
                alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¨¡å‹ (Test 03 éœ€è¦ LLM)");
                document.getElementById('testResultDisplay').innerHTML = '';
                return;
            }

            resetTest03StreamState();
            ensureTest03StreamContainer();
            startTest03Duration();
            startTest03StepDurationTicker();
            updateTest03SummaryQuery(query || 'ç­‰å¾…è¾“å…¥');

            addConsoleLine(`å¯åŠ¨ SOP è§£ææµç¨‹ (Streaming)...`);
            addConsoleLine(`Model: ${model}, Mode: ${mode}`);

            const graphDef = `graph TD
                Start((Start)) --> API["API Endpoint (APIç«¯ç‚¹)<br/>backend/api_bridge.py:stream_test_03"]
                API --> SOP["Load SOPs (åŠ è½½SOP)<br/>src/core/sop_loader.py:load_all"]
                SOP --> ClassInit["Init Classifier (åˆå§‹åŒ–åˆ†ç±»å™¨)<br/>src/agents/classifier.py:__init__"]
                ClassInit --> Route["Route Intent (æ„å›¾è·¯ç”±)<br/>src/agents/classifier.py:route"]
                Route --> SOPParse["Analyze SOP (è§£æSOP)<br/>src/core/sop_loader.py:analyze_sop"]
                SOPParse --> StepParse["Analyze Steps (è§£ææ­¥éª¤)<br/>tests/test_03_sop_analysis.py:analyze_step"]
                StepParse --> End(("Result (ç»“æœ)"))

                style Start fill:#ecf0f1,stroke:#bdc3c7
                style API fill:#e8f8f5,stroke:#1abc9c
                style SOP fill:#fff,stroke:#3498db,stroke-dasharray: 5 5
                style ClassInit fill:#fff,stroke:#bdc3c7
                style Route fill:#fff,stroke:#bdc3c7
                style SOPParse fill:#fef9e7,stroke:#f1c40f
                style StepParse fill:#fff,stroke:#bdc3c7
                style End fill:#ecf0f1,stroke:#bdc3c7
            `;
            updateFlowchart(graphDef);

            try {
                const safeQuery = query || '';
                const url = `${API_URL}/test/stream/03?query=${encodeURIComponent(safeQuery)}&config=${encodeURIComponent(model)}&mode=${encodeURIComponent(mode)}`;
                const response = await fetch(url);
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (!line.trim()) continue;
                        try {
                            const event = JSON.parse(line);
                            handleTest03Event(event);
                            if (event.step === 'step_analyze') {
                                await new Promise(r => setTimeout(r, 0));
                            }
                        } catch (e) {
                            console.error("JSON Parse Error", e);
                        }
                    }
                }
                stopTimer('å®Œæˆ');
            } catch (e) {
                addConsoleLine(`Error: ${e.message}`, true);
                stopTimer('å‡ºé”™');
                stopTest03Duration(null);
            }
            stopTest03StepDurationTicker();
            return;
        }

        if (testId === '4') {
            resetTest04StreamState();
            ensureTest04StreamContainer();
            startTest04Duration();

            addConsoleLine(`å¯åŠ¨å·¥å…·èƒ½åŠ›éªŒè¯ (Streaming)...`);
            if (mode) {
                addConsoleLine(`Mode: ${mode}`);
            }

            const graphDef = `graph TD
                Start((Start)) --> API["API Endpoint (APIç«¯ç‚¹)<br/>backend/api_bridge.py:stream_test_04"]
                API --> CaseLoad["Load Cases (åŠ è½½ç”¨ä¾‹)<br/>tests/test_04_tool_validity.py:_select_cases"]
                CaseLoad --> CaseRun["Run Tools (æ‰§è¡Œå·¥å…·)<br/>src/tools/*:ToolRegistry.get_tool"]
                CaseRun --> Result(("Result (ç»“æœ)"))

                style Start fill:#ecf0f1,stroke:#bdc3c7
                style API fill:#e8f8f5,stroke:#1abc9c
                style CaseLoad fill:#fff,stroke:#3498db,stroke-dasharray: 5 5
                style CaseRun fill:#fff,stroke:#bdc3c7
                style Result fill:#ecf0f1,stroke:#bdc3c7
            `;
            updateFlowchart(graphDef);

            try {
                const safeQuery = query || '';
                const params = [];
                if (safeQuery) params.push(`query=${encodeURIComponent(safeQuery)}`);
                if (mode) params.push(`mode=${encodeURIComponent(mode)}`);
                if (model) params.push(`config=${encodeURIComponent(model)}`);
                const url = `${API_URL}/test/stream/04${params.length > 0 ? `?${params.join('&')}` : ''}`;
                const response = await fetch(url);
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (!line.trim()) continue;
                        try {
                            const event = JSON.parse(line);
                            handleTest04Event(event);
                        } catch (e) {
                            console.error("JSON Parse Error", e);
                        }
                    }
                }
                stopTimer('å®Œæˆ');
            } catch (e) {
                addConsoleLine(`Error: ${e.message}`, true);
                stopTimer('å‡ºé”™');
                stopTest04Duration(null);
            }
            return;
        }

            addConsoleLine(`å•å…ƒæµ‹è¯•å¯åŠ¨: Test ID: ${testId} ${mode ? `(Mode: ${mode})` : ''}`);
            let graphDef = "";
            if (testId === '1') {
                graphDef = `graph TD
                    Start((Start)) --> API["API Bridge<br/>backend/api_bridge.py:run_test/1"]
                    API --> Script["Test Script<br/>tests/test_01_tool_registration.py"]
                    Script --> ToolsLoad["Load Tools<br/>src/tools/base.py:ToolRegistry.list_tools"]
                    ToolsLoad --> ToolsCheck["Validate Core Tools"]
                    ToolsCheck --> SOPLoad["Load SOPs<br/>src/core/sop_loader.py:load_all"]
                    SOPLoad --> SOPCheck["Validate Core SOPs"]
                    SOPCheck --> End((Wait Result))`;
            } else if (testId === '2') {
                 graphDef = `graph TD
                    Start((Start)) --> API["API Bridge<br/>backend/api_bridge.py:run_test/2"]
                    API --> Script["Test Script<br/>tests/test_02_intent_classifier.py"]
                    Script --> SOP["SOP Loader<br/>src/core/sop_loader.py"]
                    SOP --> Class["Classifier<br/>src/agents/classifier.py"]
                    Class --> End((Wait Result))`;
            } else if (testId === '4') {
                 graphDef = `graph TD
                    Start((Start)) --> API["API Bridge<br/>backend/api_bridge.py:run_test/4"]
                    API --> Script["Test Script<br/>tests/test_04_tool_validity.py"]
                    Script --> Tools["Tool Registry<br/>src/tools/base.py:ToolRegistry.get_tool"]
                    Tools --> Exec["Execute Tools<br/>table_lookup / knowledge_search / calculator / gis"]
                    Exec --> Report["Build JSON Report"]
                    Report --> End((Wait Result))`;
            } else {
                 graphDef = `graph TD\nStart((Start)) --> Init["åˆå§‹åŒ–æµ‹è¯•: ${testId}"]\nInit --> Running["è¿è¡Œä¸­..."]`;
            }
            if (testId === '1') {
                updateTest01Flowchart('running');
            } else {
                updateFlowchart(graphDef);
            }

            try {
                const config = document.querySelector('input[name="selectedModel"]:checked')?.value;
                
                let url = `${API_URL}/run_test/${testId}`;
                const params = [];
                if (mode) params.push(`mode=${encodeURIComponent(mode)}`);
                if (query) params.push(`query=${encodeURIComponent(query)}`);
                if (config) params.push(`config=${encodeURIComponent(config)}`);
                
                if (params.length > 0) {
                    url += `?${params.join('&')}`;
                }

                const response = await fetch(url);
                const data = await response.json();
                
                // Extract key result for display
                let summaryResult = "";
                
                // Common JSON extraction for structured tests
                let jsonResult = null;
                const jsonMatch = data.stdout.match(/__JSON_START__\s*([\s\S]*?)\s*__JSON_END__/);
                if (jsonMatch) {
                    try {
                        jsonResult = JSON.parse(jsonMatch[1]);
                    } catch (e) {
                        console.error("Failed to parse JSON result", e);
                    }
                }

                if (testId === '1') {
                    if (jsonResult) {
                        let toolsHtml = "";
                        let sopsHtml = "";
                        const toolCountMatch = data.stdout.match(/å·²æ³¨å†Œå·¥å…·æ•°é‡:\s*(\d+)/);
                        const sopCountMatch = data.stdout.match(/å·²åŠ è½½ SOP æ•°é‡:\s*(\d+)/);
                        const toolCount = toolCountMatch ? parseInt(toolCountMatch[1]) : (jsonResult.tools ? jsonResult.tools.filter(t => t.status === 'ok').length : 0);
                        const sopCount = sopCountMatch ? parseInt(sopCountMatch[1]) : (jsonResult.sops ? jsonResult.sops.filter(s => s.status === 'ok').length : 0);
                        if (jsonResult.tools && jsonResult.tools.length > 0) {
                            toolsHtml = jsonResult.tools.map(t => `
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; border-bottom: 1px solid #334155;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 16px;">${t.status === 'ok' ? 'âœ…' : 'âŒ'}</span>
                                        <div>
                                            <div style="font-weight: bold; color: #e2e8f0; display: flex; align-items: center;">
                                                ${t.name}
                                                ${t.execution && t.execution !== 'skipped' ? 
                                                    `<span style="font-size: 9px; padding: 1px 4px; border-radius: 3px; margin-left: 6px; background: ${t.execution==='success'?'#14532d':(t.execution==='error'?'#7f1d1d':'#713f12')}; color: ${t.execution==='success'?'#86efac':(t.execution==='error'?'#fca5a5':'#fcd34d')}">Run: ${t.execution}</span>` 
                                                    : ''}
                                            </div>
                                            <div style="font-size: 11px; color: #94a3b8;">${t.desc || 'No description'}</div>
                                        </div>
                                    </div>
                                    <div style="font-size: 10px; color: #64748b; text-transform: uppercase;">TOOL</div>
                                </div>
                            `).join('');
                        }

                        if (jsonResult.sops && jsonResult.sops.length > 0) {
                            sopsHtml = jsonResult.sops.map(s => `
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; border-bottom: 1px solid #334155;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 16px;">${s.status === 'missing' ? 'âŒ' : 'âœ…'}</span>
                                        <div>
                                            <div style="font-weight: bold; color: #e2e8f0;">${s.name}</div>
                                            <div style="font-size: 11px; color: #94a3b8;">${s.desc || 'No description'}</div>
                                        </div>
                                    </div>
                                    <div style="font-size: 10px; color: #64748b; text-transform: uppercase;">SOP</div>
                                </div>
                            `).join('');
                        }

                        summaryResult = `
                            <div style="background: #0f172a; border: 1px solid #334155; border-radius: 6px; overflow: hidden;">
                                <div style="padding: 10px 15px; background: #1e293b; border-bottom: 1px solid #334155; font-weight: bold; color: #e2e8f0;">
                                    èµ„æºåŠ è½½æ£€æŸ¥æ¸…å•
                                </div>
                                <div style="max-height: 300px; overflow-y: auto;">
                                    ${toolsHtml ? `<div style="padding: 5px 15px; background: #134e4a; color: #5eead4; font-size: 11px; font-weight: bold;">Toolsï¼ˆ${toolCount}ï¼‰</div>${toolsHtml}` : ''}
                                    ${sopsHtml ? `<div style="padding: 5px 15px; background: #713f12; color: #fcd34d; font-size: 11px; font-weight: bold;">SOPsï¼ˆ${sopCount}ï¼‰</div>${sopsHtml}` : ''}
                                </div>
                            </div>
                        `;
                        updateTest01Flowchart('result', {
                            toolsError: (jsonResult.tools || []).some(t => t.status !== 'ok'),
                            sopsError: (jsonResult.sops || []).some(s => s.status === 'missing'),
                            sopsWarn: (jsonResult.sops || []).some(s => s.status === 'warning')
                        });
                    } else {
                        const toolMatch = data.stdout.match(/\[AI é€‰æ‹©\] å·¥å…·: (.*)/);
                        const paramsMatch = data.stdout.match(/\[AI å‚æ•°\] Inputs: (.*)/);
                        if (toolMatch) {
                            summaryResult = `
                                <div style="background: #1e293b; border-left: 4px solid #22c55e; padding: 15px; border-radius: 4px;">
                                    <div style="font-weight: bold; color: #22c55e; margin-bottom: 10px; font-size: 14px;">âœ… å·¥å…·é€‰æ‹©ç»“æœ</div>
                                    <div style="margin-bottom: 8px; color: #cbd5e1;"><strong>é€‰å®šå·¥å…·:</strong> <code style="background: #14532d; color: #86efac; padding: 2px 6px; border-radius: 3px;">${toolMatch[1]}</code></div>
                                    <div style="color: #cbd5e1;"><strong>æå–å‚æ•°:</strong> <pre style="background: #0f172a; border: 1px solid #334155; padding: 8px; margin-top: 5px; font-size: 12px; border-radius: 4px; color: #cbd5e1;">${paramsMatch ? paramsMatch[1] : '{}'}</pre></div>
                                </div>
                            `;
                        }
                        updateTest01Flowchart('result', {});
                    }
                } else if (testId === '2') {
        const stdout = data.stdout || "";
        console.log("Test 02 Output:", stdout); // Debug log
        const matchSuccess = stdout.includes('[AI åŒ¹é…æˆåŠŸ]') || stdout.includes('[MATCH SUCCESS]');
        const matchError = stdout.includes('[AI è¿è¡Œå‡ºé”™]') || stdout.includes('[AI ERROR]');
        // æ›´åŠ å®½æ¾çš„æ­£åˆ™åŒ¹é…ï¼Œæ”¯æŒä¸­æ–‡å’Œè‹±æ–‡æ ‡è®°
        const sopMatch = stdout.match(/åŒ¹é… SOP ID:\s*(.*?)($| \|)/i) || stdout.match(/SOP_ID:\s*(.*)/i);
        const argsMatch = stdout.match(/æå–å‚æ•°:\s*(.*?)($| \|)/i) || stdout.match(/ARGS:\s*(.*)/i);

        let queryDisplay = "";
        if (query) {
             queryDisplay = `
                <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #334155;">
                    <div style="font-size: 11px; color: #94a3b8; margin-bottom: 4px;">æµ‹è¯•æŒ‡ä»¤ (User Query):</div>
                    <div style="font-family: sans-serif; font-size: 14px; color: #e2e8f0; font-weight: 500;">${escapeHtml(query)}</div>
                </div>
            `;
        }

        if (data.exit_code !== 0) {
            summaryResult = `
                ${queryDisplay}
                <div style="background: #450a0a; border-left: 4px solid #ef4444; padding: 15px; border-radius: 4px;">
                    <div style="font-weight: bold; color: #ef4444; margin-bottom: 5px; font-size: 14px;">âŒ æµ‹è¯•æ‰§è¡Œå‡ºé”™</div>
                    <div style="font-size: 13px; color: #fca5a5;">Python è„šæœ¬è¿è¡Œå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºã€‚</div>
                </div>
            `;
        } else if (matchError) {
            summaryResult = `
                ${queryDisplay}
                <div style="background: #450a0a; border-left: 4px solid #ef4444; padding: 15px; border-radius: 4px;">
                    <div style="font-weight: bold; color: #ef4444; margin-bottom: 5px; font-size: 14px;">âš ï¸ åˆ†ç±»å™¨æ‰§è¡Œå¼‚å¸¸</div>
                    <div style="font-size: 13px; color: #fca5a5;">AI å“åº”è§£æå¤±è´¥ï¼Œå¯èƒ½ç”±äºæ¨¡å‹è¾“å‡ºæ ¼å¼ä¸æ­£ç¡®æˆ–ç½‘ç»œè¶…æ—¶ã€‚</div>
                </div>
            `;
        } else if (matchSuccess && sopMatch) {
                         summaryResult = `
                             ${queryDisplay}
                             <div style="background: #1e293b; border-left: 4px solid #a855f7; padding: 15px; border-radius: 4px;">
                                 <div style="font-weight: bold; color: #a855f7; margin-bottom: 10px; font-size: 14px;">ğŸ¯ æ„å›¾è·¯ç”±æˆåŠŸ</div>
                                 <div style="margin-bottom: 8px; color: #cbd5e1;"><strong>åŒ¹é… SOP:</strong> <code style="background: #581c87; color: #e9d5ff; padding: 2px 6px; border-radius: 3px;">${sopMatch[1].trim()}</code></div>
                                 <div style="color: #cbd5e1;"><strong>æå–å‚æ•°:</strong> <pre style="background: #0f172a; border: 1px solid #334155; padding: 8px; margin-top: 5px; font-size: 12px; border-radius: 4px; color: #cbd5e1;">${argsMatch ? argsMatch[1].trim() : '{}'}</pre></div>
                             </div>
                         `;
                     } else {
                         summaryResult = `
                             ${queryDisplay}
                             <div style="background: #450a0a; border-left: 4px solid #ef4444; padding: 15px; border-radius: 4px;">
                                 <div style="font-weight: bold; color: #ef4444; margin-bottom: 5px; font-size: 14px;">âšª æœªåŒ¹é…åˆ° SOP</div>
                                 <div style="font-size: 13px; color: #fca5a5;">æŒ‡ä»¤å¯èƒ½å±äºé€šç”¨å¯¹è¯æˆ–ä¸å±äºç°æœ‰æµç¨‹ã€‚</div>
                             </div>
                         `;
                     }
                } else if (testId === '3') {
                    if (jsonResult) {
                        summaryResult = `
                            <div style="background: #1e293b; border-left: 4px solid #14b8a6; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
                                <div style="font-weight: bold; color: #14b8a6; margin-bottom: 6px; font-size: 14px;">ğŸ§© SOP Step Analysis</div>
                                <div style="font-size: 12px; color: #94a3b8;">å·²è§£æ ${jsonResult.cases ? jsonResult.cases.length : 0} ä¸ªæ¡ˆä¾‹</div>
                            </div>
                            ${renderTest03Result(jsonResult)}
                        `;
                    }
                 } else if (testId === '4') {
                    if (jsonResult) {
                        const count = Array.isArray(jsonResult.cases) ? jsonResult.cases.length : 0;
                        summaryResult = `
                            <div style="background: #1e293b; border-left: 4px solid #38bdf8; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
                                <div style="font-weight: bold; color: #38bdf8; margin-bottom: 6px; font-size: 14px;">ğŸ§° å·¥å…·èƒ½åŠ›éªŒè¯</div>
                                <div style="font-size: 12px; color: #94a3b8;">å·²æ‰§è¡Œ ${count} é¡¹å·¥å…·æµ‹è¯•</div>
                            </div>
                            ${renderTest04Result(jsonResult)}
                        `;
                    }
                 }

                if (!summaryResult) {
                    summaryResult = `
                        <div style="background: #1e293b; border-left: 4px solid #3b82f6; padding: 15px; border-radius: 4px;">
                            <div style="font-weight: bold; color: #3b82f6; margin-bottom: 5px;">æµ‹è¯•æ‰§è¡Œå®Œæˆ</div>
                            <div style="font-size: 13px; color: #cbd5e1;">è¯¦ç»†æ‰§è¡Œè¿‡ç¨‹è¯·æŸ¥çœ‹å³ä¾§å®æ—¶æ§åˆ¶å°è¾“å‡ºã€‚</div>
                            <div style="margin-top: 10px; font-size: 12px; color: #cbd5e1;">çŠ¶æ€ç : <span style="color: ${data.exit_code === 0 ? '#86efac' : '#fca5a5'}">${data.exit_code}</span></div>
                        </div>
                    `;
                }

                document.getElementById('testResultDisplay').innerHTML = `
                    <div class="unit-test-result-summary">
                        <div style="font-size: 12px; color: #94a3b8; margin-bottom: 12px;">
                            æµ‹è¯•æ–‡ä»¶: <span style="font-family: monospace; color: #cbd5e1;">tests/${data.test_file}</span>
                        </div>
                        ${summaryResult}
                        ${data.stderr ? `
                            <div style="margin-top: 15px;">
                                <div style="font-size: 11px; color: #fca5a5; margin-bottom: 5px;">é”™è¯¯/è­¦å‘Šè¾“å‡º:</div>
                                <pre class="stderr" style="max-height: 100px; overflow-y: auto; font-size: 11px; background: #450a0a; color: #fca5a5; border: 1px solid #7f1d1d;">${escapeHtml(data.stderr)}</pre>
                            </div>
                        ` : ''}
                    </div>
                `;
            
            let flowchartSteps = [`Start((å¼€å§‹)) --> Init[${mq('æµ‹è¯•: ' + data.test_file)}]`];
            let lastNode = "Init";
            let stepCount = 0;
            let currentStepName = "";
            let currentStepDetails = [];
            const buildFlowchartSteps = testId !== '1';

            const lines = data.stdout.split('\n');
            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (!trimmedLine) return;

                if (trimmedLine.includes('-> æ­¥éª¤')) {
                    if (stepCount > 0 && buildFlowchartSteps) {
                        const nodeId = `Step${stepCount}`;
                        const label = currentStepDetails.length > 0 
                            ? `${currentStepName}\n${currentStepDetails.join('\n')}`
                            : currentStepName;
                        flowchartSteps.push(`${lastNode} --> ${nodeId}[${mq(label)}]`);
                        lastNode = nodeId;
                    }
                    
                    stepCount++;
                    currentStepName = trimmedLine.split(':')[1]?.trim() || `æ­¥éª¤${stepCount}`;
                    currentStepDetails = [];
                    addConsoleLine(trimmedLine);
                } else {
                    if (stepCount > 0 && buildFlowchartSteps) {
                        const cleanLine = trimmedLine.replace('[CALL]', 'ğŸ“').replace('[OK]', 'âœ…').replace('[ERROR]', 'âŒ');
                        currentStepDetails.push(cleanLine);
                    }
                    addConsoleLine(trimmedLine, trimmedLine.includes('[ERROR]') || trimmedLine.includes('å¤±è´¥'));
                }
            });

            if (buildFlowchartSteps) {
                if (stepCount > 0) {
                    const nodeId = `Step${stepCount}`;
                    const label = currentStepDetails.length > 0 
                        ? `${currentStepName}\n${currentStepDetails.join('\n')}`
                        : currentStepName;
                    flowchartSteps.push(`${lastNode} --> ${nodeId}[${mq(label)}]`);
                    lastNode = nodeId;
                }

                flowchartSteps.push(`${lastNode} --> End((å®Œæˆ))`);
                updateFlowchart(`graph TD\n${flowchartSteps.join('\n')}`);
            }

            if (data.stderr) {
                addConsoleLine("é”™è¯¯è¾“å‡º:\n" + data.stderr, true);
            }
            
            stopTimer(data.exit_code === 0 ? 'æµ‹è¯•é€šè¿‡' : 'æµ‹è¯•å¤±è´¥');
        } catch (error) {
            document.getElementById('testResultDisplay').innerHTML = `<div style="color: red;">è¿è¡Œå‡ºé”™: ${error.message}</div>`;
            addConsoleLine("è¿è¡Œå‡ºé”™: " + error.message, true);
            updateFlowchart(`graph TD\nStart((å¼€å§‹)) --> Error[${mq('ç³»ç»Ÿé”™è¯¯: ' + error.message)}]\nError --> End((ç»“æŸ))`);
            stopTimer('è¿è¡Œå‡ºé”™');
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML.replace(/\r?\n/g, "<br/>");
    }

    // Helper to quote labels for Mermaid to avoid syntax errors
    function mq(text) {
        if (!text) return '""';
        // Use double quotes for the label and escape internal double quotes
        // Replace newlines with <br/> for HTML labels
        return `"${text.toString().replace(/"/g, "'").replace(/\n/g, "<br/>")}"`;
    }
</script>
</body>
</html>
