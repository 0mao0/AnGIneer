<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PicoAgent Test Console</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({ 
            startOnLoad: false, 
            theme: 'neutral',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            themeVariables: {
                fontSize: '13px',
                fontFamily: 'arial',
                nodePadding: '10'
            }
        });
    </script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; background: #f5f5f5; display: flex; height: 100vh; overflow: hidden; }
        
        /* Left Sidebar: Test List */
        .sidebar { width: 260px; background: #2c3e50; color: white; padding: 20px; display: flex; flex-direction: column; gap: 10px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); flex-shrink: 0; }
        
        /* Middle Column: Interaction Area */
        .main-content { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; background: white; border-right: 1px solid #ddd; }
        
        /* Right Column: Execution Trace */
        .execution-trace { width: 450px; background: #f8f9fa; display: flex; flex-direction: column; flex-shrink: 0; border-left: 1px solid #ddd; height: 100vh; }
        
        .trace-section-header { 
            padding: 10px 15px; 
            background: #e9ecef; 
            border-bottom: 1px solid #dee2e6; 
            font-size: 12px; 
            font-weight: bold; 
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #flowchartArea { 
            flex: 1; 
            overflow: auto; 
            background: white; 
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        #flowchartArea svg {
            width: 100% !important;
            max-width: 100%;
            height: auto;
        }

        /* Ensure Mermaid labels can expand to fit content */
        .mermaid .label foreignObject {
            overflow: visible;
        }
        .mermaid .label foreignObject div {
            max-width: 200px !important;
            width: auto !important;
            display: inline-block !important;
            text-align: center !important;
            white-space: normal !important;
            word-wrap: break-word;
        }
        .nodeLabel {
            white-space: normal !important;
        }

        #consoleArea { 
            height: 40%; 
            overflow-y: auto; 
            background: #2c3e50; 
            color: #ecf0f1; 
            padding: 15px; 
            font-family: 'Consolas', monospace; 
            font-size: 11px;
            border-top: 2px solid #34495e;
        }

        .trace-step {
            margin-bottom: 8px;
            border-bottom: 1px solid #3d566e;
            padding-bottom: 5px;
        }
        .trace-step-time { color: #95a5a6; font-size: 10px; }
        .trace-step-content { margin-top: 3px; white-space: pre-wrap; word-break: break-word; }
        
        .container { max-width: 100%; margin: 0; }
        h1, h2, h3 { margin-top: 0; color: #333; }
        h2 { color: #ecf0f1; font-size: 1.1rem; margin-bottom: 15px; }
        h3 { font-size: 0.9rem; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; }

        .input-group { margin-top: auto; padding-top: 20px; border-top: 1px solid #eee; display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; transition: background 0.2s; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; }
        
        .test-btn { background: #34495e; text-align: left; padding: 12px; border: none; border-radius: 4px; font-size: 12px; line-height: 1.4; border-left: 4px solid transparent; color: #bdc3c7; cursor: pointer; width: 100%; }
        .test-btn:hover { background: #4b6584; color: white; }
        .test-btn.active { border-left-color: #3498db; background: #3d566e; color: white; }
        .test-btn strong { display: block; color: white; margin-bottom: 3px; font-size: 13px; }

        /* Chat Styles */
        #chatDisplay { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; padding-bottom: 20px; }
        .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 8px; font-size: 14px; line-height: 1.5; position: relative; }
        .chat-bubble.user { align-self: flex-end; background: #007bff; color: white; border-bottom-right-radius: 2px; }
        .chat-bubble.bot { align-self: flex-start; background: #f0f0f0; color: #333; border-bottom-left-radius: 2px; border: 1px solid #e0e0e0; }
        
        /* Trace Card Styles */
        .trace-card { background: white; border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; margin-bottom: 12px; font-size: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .trace-card.running { border-left: 3px solid #007bff; }
        .trace-card.completed { border-left: 3px solid #28a745; }
        .trace-card.failed { border-left: 3px solid #dc3545; }
        .trace-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; color: #2c3e50; }
        .trace-meta { color: #7f8c8d; font-family: 'Consolas', monospace; font-size: 11px; margin-bottom: 5px; }
        .trace-details { color: #34495e; background: #fcfcfc; padding: 6px; border-radius: 4px; border: 1px solid #f0f0f0; margin-top: 5px; overflow-x: auto; }
        
        .status-badge { padding: 2px 5px; border-radius: 3px; font-size: 10px; color: white; text-transform: uppercase; }
        .status-running { background: #007bff; }
        .status-completed { background: #28a745; }
        .status-failed { background: #dc3545; }

        pre { margin: 0; white-space: pre-wrap; word-wrap: break-word; }
        
        #modelSelectionArea { background: #f8f9f9; padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #e5e8e8; }
        .model-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; }
        .model-item { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 12px; 
            cursor: pointer; 
            padding: 6px 10px; 
            border: 1px solid #d5dbdb; 
            border-radius: 4px;
            background: white;
            transition: all 0.2s;
        }
        .model-item:hover { border-color: #3498db; background: #ebf5fb; }
        .model-item input[type="radio"] { margin: 0; }
        .model-item.active { border-color: #3498db; background: #ebf5fb; font-weight: bold; }
        .model-name { color: #2c3e50; font-weight: 500; }
        .model-id { color: #7f8c8d; font-size: 10px; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }

        /* Unit Test Result Styles */
        .unit-test-result { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 4px; font-family: 'Consolas', monospace; font-size: 12px; }
        .unit-test-result .stdout { color: #d4d4d4; }
        .unit-test-result .stderr { color: #f44747; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>PicoAgent æµ‹è¯•å¥—ä»¶</h2>
        <button class="test-btn" id="btn-test-0" onclick="switchTest('0', this)">
            <strong>æµ‹è¯• 00: LLM å¯¹è¯èƒ½åŠ›</strong>
            é€‰æ‹©æ¨¡å‹å¹¶è¿›è¡Œå®æ—¶å¯¹è¯æµ‹è¯•.
        </button>
        <button class="test-btn" id="btn-test-1" onclick="switchTest('1', this)">
            <strong>æµ‹è¯• 01: å·¥å…·æ³¨å†Œ</strong>
            éªŒè¯ TableLookup, Calculator ç­‰æ ¸å¿ƒå·¥å…·.
        </button>
        <button class="test-btn" id="btn-test-2" onclick="switchTest('2', this)">
            <strong>æµ‹è¯• 02: æ„å›¾åˆ†ç±»å™¨</strong>
            æ¨¡æ‹Ÿ LLM è·¯ç”±ï¼ŒéªŒè¯ SOP åŒ¹é…é€»è¾‘.
        </button>
        <button class="test-btn" id="btn-test-3" onclick="switchTest('3', this)">
            <strong>æµ‹è¯• 03: SOP æ··åˆåˆ†æ</strong>
            éªŒè¯ä» Markdown æå–ç»“æ„åŒ–æ­¥éª¤.
        </button>
        <button class="test-btn" id="btn-test-4" onclick="switchTest('4', this)">
            <strong>æµ‹è¯• 04: å®Œæ•´æ‰§è¡Œæµ</strong>
            æ¨¡æ‹Ÿä»æŸ¥è¯¢åˆ°è°ƒç”¨çš„å…¨è¿‡ç¨‹ï¼ˆå¸¦ Mockï¼‰.
        </button>
        <button class="test-btn" id="btn-test-5" onclick="switchTest('5', this)">
            <strong>æµ‹è¯• 05: è¡¨æ ¼æŸ¥è¯¢å·¥å…·</strong>
            ç›´æ¥æµ‹è¯• TableLookupTool æå–èƒ½åŠ›.
        </button>
        
        <div style="margin-top: auto; font-size: 11px; color: #95a5a6; text-align: center; border-top: 1px solid #34495e; padding-top: 10px;">
            PicoAgent v0.1 Prototype
        </div>
    </div>

    <div class="main-content">
        <h1 id="testTitle">æµ‹è¯•æ§åˆ¶å°</h1>
        
        <!-- Test 00: Chat Interface -->
        <div id="chatInterface" style="display: none; flex: 1; flex-direction: column;">
            <div id="modelSelectionArea">
                <div style="font-weight: bold; font-size: 14px; color: #2980b9;">é€‰æ‹©æ¨¡å‹è¿›è¡Œæµ‹è¯•:</div>
                <div id="modelGrid" class="model-grid">
                    <!-- Models loaded here -->
                </div>
            </div>
            <div id="chatDisplay">
                <!-- Chat history -->
                <div class="chat-bubble bot">æ‚¨å¥½ï¼è¯·é€‰æ‹©å·¦ä¾§çš„æµ‹è¯•é¡¹ï¼Œæˆ–è€…åœ¨è¿™é‡Œé€‰æ‹©ä¸€ä¸ªæ¨¡å‹å¼€å§‹å¯¹è¯æµ‹è¯•ã€‚</div>
            </div>
        </div>

        <!-- Unit Test Interface -->
        <div id="unitTestInterface" style="display: none; flex: 1; flex-direction: column;">
            <div id="testSourceView" style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 8px;">æµ‹è¯•æºç é¢„è§ˆ:</h3>
                <div style="background: #2d2d2d; color: #ccc; padding: 12px; border-radius: 4px; font-family: 'Consolas', monospace; font-size: 11px; max-height: 200px; overflow-y: auto;">
                    <pre id="testSourceContent"></pre>
                </div>
            </div>
            <div id="testResultDisplay">
                <!-- Results of runUnitTest -->
            </div>
        </div>

        <div class="input-group">
            <input type="text" id="queryInput" placeholder="åœ¨æ­¤è¾“å…¥æ‚¨çš„æµ‹è¯•æŒ‡ä»¤..." onkeyup="if(event.keyCode===13) runCurrentAction()">
            <button id="runBtn" onclick="runCurrentAction()">è¿è¡Œ</button>
        </div>
    </div>

    <div class="execution-trace">
        <div class="trace-section-header">
            <span>æ‰§è¡Œæµç¨‹å›¾</span>
            <div id="traceStats" style="font-size: 11px; font-weight: normal;">
                è€—æ—¶: <span id="timer">0ms</span>
            </div>
        </div>
        <div id="flowchartArea">
            <div id="mermaidContainer" class="mermaid">
                graph TD
                Start((å¼€å§‹)) --> Idle[ç­‰å¾…æŒ‡ä»¤]
            </div>
        </div>

        <div class="trace-section-header">
            <span>å®æ—¶æ§åˆ¶å°è¾“å‡º</span>
            <button onclick="document.getElementById('consoleArea').innerHTML=''" style="padding: 2px 8px; font-size: 10px; background: #6c757d;">æ¸…ç©º</button>
        </div>
        <div id="consoleArea">
            <div style="color: #95a5a6; font-style: italic;">ç­‰å¾…æµ‹è¯•è¿è¡Œ...</div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let currentTestId = null;
        let startTime = 0;
        let timerInterval;
        let availableModels = [];

        async function fetchModels() {
            try {
                const response = await fetch(`${API_URL}/llm_configs`);
                availableModels = await response.json();
                const container = document.getElementById('modelGrid');
                container.innerHTML = availableModels.map((m, index) => `
                    <label class="model-item ${m.configured ? (index === 0 ? 'active' : '') : 'disabled'}" id="model-${m.name}">
                        <input type="radio" name="selectedModel" value="${m.name}" ${m.configured ? (index === 0 ? 'checked' : '') : 'disabled'} onchange="updateModelSelection(this)">
                        <div style="flex: 1">
                            <div class="model-name">${m.name}</div>
                            <div class="model-id">${m.model}</div>
                        </div>
                        <div class="model-latency" id="latency-${m.name}" style="font-size: 10px; color: #3498db; font-weight: bold;"></div>
                    </label>
                `).join('');
            } catch (e) {
                console.error('Failed to fetch models', e);
            }
        }

        function updateModelSelection(radio) {
            document.querySelectorAll('.model-item').forEach(el => el.classList.remove('active'));
            if (radio.checked) {
                radio.closest('.model-item').classList.add('active');
            }
        }

        fetchModels();

        function switchTest(testId, btn) {
            currentTestId = testId;
            document.querySelectorAll('.test-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            document.getElementById('testTitle').innerText = btn.querySelector('strong').innerText;
            
            // Show/Hide interfaces
            if (testId === '0') {
                document.getElementById('chatInterface').style.display = 'flex';
                document.getElementById('unitTestInterface').style.display = 'none';
                document.getElementById('queryInput').placeholder = "è¾“å…¥æ‚¨æƒ³å¯¹ LLM è¯´çš„è¯...";
            } else {
                document.getElementById('chatInterface').style.display = 'none';
                document.getElementById('unitTestInterface').style.display = 'flex';
                document.getElementById('queryInput').placeholder = "è¾“å…¥æµ‹è¯•å‚æ•°æˆ–ç›´æ¥ç‚¹å‡»è¿è¡Œ...";
                loadTestSource(testId);
            }
            
            // Clear results
            document.getElementById('consoleArea').innerHTML = '';
            document.getElementById('testResultDisplay').innerHTML = '';
            updateFlowchart(`graph TD\nStart((å¼€å§‹)) --> Idle[${mq('ç­‰å¾…æŒ‡ä»¤')}]`);
        }

    function updateFlowchart(mermaidCode) {
        const container = document.getElementById('flowchartArea');
        container.innerHTML = `<div id="mermaidContainer" class="mermaid">${mermaidCode}</div>`;
        mermaid.render('mermaid-svg', mermaidCode).then(({ svg }) => {
            container.innerHTML = svg;
        });
    }

    function addConsoleLine(text, isError = false) {
        const consoleArea = document.getElementById('consoleArea');
        const div = document.createElement('div');
        div.className = 'trace-step';
        const time = new Date().toLocaleTimeString();
        const safeText = escapeHtml(text);
        div.innerHTML = `
            <span class="trace-step-time">[${time}]</span>
            <div class="trace-step-content" style="color: ${isError ? '#f44747' : '#ecf0f1'}">${safeText}</div>
        `;
        consoleArea.appendChild(div);
        consoleArea.scrollTop = consoleArea.scrollHeight;
    }

        async function loadTestSource(testId) {
            try {
                const response = await fetch(`${API_URL}/test_source/${testId}`);
                const data = await response.json();
                document.getElementById('testSourceContent').innerText = data.content;
            } catch (e) {
                document.getElementById('testSourceContent').innerText = "åŠ è½½æºç å¤±è´¥: " + e.message;
            }
        }

        function runCurrentAction() {
            if (currentTestId === '0') {
                runChatTest();
            } else if (currentTestId) {
                runUnitTest(currentTestId);
            } else {
                alert("è¯·å…ˆä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæµ‹è¯•é¡¹ã€‚");
            }
        }

        function updateTimer() {
            const elapsed = Date.now() - startTime;
            document.getElementById('timer').innerText = elapsed + 'ms';
        }

        function startTimer() {
            startTime = Date.now();
            document.getElementById('traceStats').style.display = 'block';
            timerInterval = setInterval(updateTimer, 50);
        }

        function stopTimer(status = 'å®Œæˆ') {
            clearInterval(timerInterval);
            const elapsed = Date.now() - startTime;
            const selectedModel = document.querySelector('input[name="selectedModel"]:checked')?.value;
            if (selectedModel) {
                const latencyEl = document.getElementById(`latency-${selectedModel}`);
                if (latencyEl) latencyEl.innerText = elapsed + 'ms';
            }
        }

        function addChatMessage(role, content) {
            const display = document.getElementById('chatDisplay');
            const div = document.createElement('div');
            div.className = `chat-bubble ${role}`;
            div.innerText = content;
            display.appendChild(div);
            display.scrollTop = display.scrollHeight;
        }

        async function runChatTest() {
            const query = document.getElementById('queryInput').value;
            const model = document.querySelector('input[name="selectedModel"]:checked')?.value;
            
            if (!query) return;
            if (!model) { alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¨¡å‹"); return; }

        addChatMessage('user', query);
        document.getElementById('queryInput').value = '';
        document.getElementById('consoleArea').innerHTML = '';
        
        startTimer();
        
        addConsoleLine(`å¯åŠ¨ LLM å¯¹è¯æµ‹è¯•: æ¨¡å‹=${model}, è¾“å…¥=${query}`);
        // Initial flowchart
        updateFlowchart(`graph TD\nStart((å¼€å§‹)) --> Request[${mq('å‘é€è¯·æ±‚: ' + model)}]\nRequest --> Waiting[${mq('ç­‰å¾…å“åº”...')}]`);

        try {
            const response = await fetch(`${API_URL}/run_test/0?config=${encodeURIComponent(model)}&query=${encodeURIComponent(query)}`);
            const data = await response.json();
            
            const stdout = data.stdout || "";
            const responseMatch = stdout.match(/å“åº”å†…å®¹é¢„è§ˆ: (.*)\.\.\./);
            const botResponse = responseMatch ? responseMatch[1] : "æµ‹è¯•å®Œæˆï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚";
            
            // Extract function calls from stdout for chat test
            let chatFunctions = [];
            stdout.split('\n').forEach(line => {
                if (line.includes('[CALL]')) {
                    const func = line.split('[CALL]')[1]?.trim().replace('()', '');
                    if (func) chatFunctions.push(func);
                }
            });

            addChatMessage('bot', botResponse);
            addConsoleLine("æ”¶åˆ°åç«¯å“åº”:\n" + stdout);
            
            const successLabel = chatFunctions.length > 0 
                ? `å“åº”æˆåŠŸ\n(${chatFunctions.join(', ')})`
                : "å“åº”æˆåŠŸ";

            if (data.exit_code === 0) {
                updateFlowchart(`graph TD\nStart((å¼€å§‹)) --> Request[${mq('å‘é€è¯·æ±‚: ' + model)}]\nRequest --> Success[${mq(successLabel)}]\nSuccess --> End((ç»“æŸ))`);
            } else {
                updateFlowchart(`graph TD\nStart((å¼€å§‹)) --> Request[${mq('å‘é€è¯·æ±‚: ' + model)}]\nRequest --> Failed[${mq('è¯·æ±‚å¤±è´¥')}]\nFailed --> End((ç»“æŸ))`);
            }

            if (data.stderr) {
                addConsoleLine("é”™è¯¯è¾“å‡º: " + data.stderr, true);
            }
            
            stopTimer(data.exit_code === 0 ? 'æµ‹è¯•é€šè¿‡' : 'æµ‹è¯•å¤±è´¥');
        } catch (error) {
            addChatMessage('bot', "å‘ç”Ÿé”™è¯¯: " + error.message);
            addConsoleLine("è¿è¡Œæ—¶å¼‚å¸¸: " + error.message, true);
            updateFlowchart(`graph TD\nStart((å¼€å§‹)) --> Error[${mq('ç³»ç»Ÿé”™è¯¯: ' + error.message)}]\nError --> End((ç»“æŸ))`);
            stopTimer('è¿è¡Œå‡ºé”™');
        }
        }

    async function runUnitTest(testId) {
        document.getElementById('consoleArea').innerHTML = '';
        document.getElementById('testResultDisplay').innerHTML = '<div style="color: #666;">æ­£åœ¨è¿è¡Œæµ‹è¯•...</div>';
        
        startTimer();
        
        addConsoleLine(`å•å…ƒæµ‹è¯•å¯åŠ¨: Test ID: ${testId}`);
        updateFlowchart(`graph TD\nStart((å¼€å§‹)) --> Init[${mq('åˆå§‹åŒ–æµ‹è¯•: ' + testId)}]\nInit --> Running[${mq('è¿è¡Œä¸­...')}]`);

        try {
            const response = await fetch(`${API_URL}/run_test/${testId}`);
            const data = await response.json();
            
            const stdoutContent = escapeHtml(data.stdout || '(æ— æ ‡å‡†è¾“å‡º)');
            const stderrContent = data.stderr ? escapeHtml(data.stderr) : '';
            document.getElementById('testResultDisplay').innerHTML = `
                <div class="unit-test-result">
                    <div style="color: #6a9955; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px;">
                        <strong>æ‰§è¡Œæ–‡ä»¶:</strong> tests/${data.test_file} | <strong>çŠ¶æ€ç :</strong> ${data.exit_code}
                    </div>
                    <pre class="stdout">${stdoutContent}</pre>
                    ${data.stderr ? `<pre class="stderr">${stderrContent}</pre>` : ''}
                </div>
            `;
            
            // Generate flowchart from steps
            let flowchartSteps = [`Start((å¼€å§‹)) --> Init[${mq('æµ‹è¯•: ' + data.test_file)}]`];
            let lastNode = "Init";
            let stepCount = 0;
            let currentStepName = "";
            let currentStepDetails = [];

            const lines = data.stdout.split('\n');
            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (!trimmedLine) return;

                if (trimmedLine.includes('-> æ­¥éª¤')) {
                    // If we had a previous step, add it now
                    if (stepCount > 0) {
                        const nodeId = `Step${stepCount}`;
                        const label = currentStepDetails.length > 0 
                            ? `${currentStepName}\n${currentStepDetails.join('\n')}`
                            : currentStepName;
                        flowchartSteps.push(`${lastNode} --> ${nodeId}[${mq(label)}]`);
                        lastNode = nodeId;
                    }
                    
                    stepCount++;
                    currentStepName = trimmedLine.split(':')[1]?.trim() || `æ­¥éª¤${stepCount}`;
                    currentStepDetails = [];
                    addConsoleLine(trimmedLine);
                } else {
                    // Collect everything else into details (similar to console)
                    if (stepCount > 0) {
                        // For flowchart, we might want to clean up some symbols for better look
                        const cleanLine = trimmedLine.replace('[CALL]', 'ğŸ“').replace('[OK]', 'âœ…').replace('[ERROR]', 'âŒ');
                        currentStepDetails.push(cleanLine);
                    }
                    addConsoleLine(trimmedLine, trimmedLine.includes('[ERROR]') || trimmedLine.includes('å¤±è´¥'));
                }
            });

            // Add the last step
            if (stepCount > 0) {
                const nodeId = `Step${stepCount}`;
                const label = currentStepDetails.length > 0 
                    ? `${currentStepName}\n${currentStepDetails.join('\n')}`
                    : currentStepName;
                flowchartSteps.push(`${lastNode} --> ${nodeId}[${mq(label)}]`);
                lastNode = nodeId;
            }

            flowchartSteps.push(`${lastNode} --> End((å®Œæˆ))`);
            updateFlowchart(`graph TD\n${flowchartSteps.join('\n')}`);

            if (data.stderr) {
                addConsoleLine("é”™è¯¯è¾“å‡º:\n" + data.stderr, true);
            }
            
            stopTimer(data.exit_code === 0 ? 'æµ‹è¯•é€šè¿‡' : 'æµ‹è¯•å¤±è´¥');
        } catch (error) {
            document.getElementById('testResultDisplay').innerHTML = `<div style="color: red;">è¿è¡Œå‡ºé”™: ${error.message}</div>`;
            addConsoleLine("è¿è¡Œå‡ºé”™: " + error.message, true);
            updateFlowchart(`graph TD\nStart((å¼€å§‹)) --> Error[${mq('ç³»ç»Ÿé”™è¯¯: ' + error.message)}]\nError --> End((ç»“æŸ))`);
            stopTimer('è¿è¡Œå‡ºé”™');
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML.replace(/\r?\n/g, "<br/>");
    }

    // Helper to quote labels for Mermaid to avoid syntax errors
    function mq(text) {
        if (!text) return '""';
        // Use double quotes for the label and escape internal double quotes
        // Replace newlines with <br/> for HTML labels
        return `"${text.toString().replace(/"/g, "'").replace(/\n/g, "<br/>")}"`;
    }
</script>
</body>
</html>
